<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vraj Clicker 2</title>
    <link rel="icon" type="image/png" href="image_0.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Quicksand:wght@400;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        
        :root {
            --bg-main: #070b14;
            --text-main: #e2e8f0;
            --accent: #3b82f6;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
            --panel-bg: rgba(7, 11, 20, 0.9);
            --transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- THEME DEFINITIONS --- */
        body.theme-light { --bg-main: #f8fafc; --text-main: #1e293b; --accent: #2563eb; --glass: rgba(255, 255, 255, 0.7); --border: rgba(0, 0, 0, 0.1); --panel-bg: rgba(241, 245, 249, 0.9); }
        body.theme-midnight { --bg-main: #010204; --text-main: #94a3b8; --accent: #3b82f6; --glass: rgba(255, 255, 255, 0.01); --border: rgba(255, 255, 255, 0.05); --panel-bg: rgba(1, 2, 4, 0.9); }
        body.theme-red { --bg-main: #1a0505; --text-main: #fecaca; --accent: #dc2626; --panel-bg: rgba(26, 5, 5, 0.9); }
        body.theme-orange { --bg-main: #1c0f05; --text-main: #fed7aa; --accent: #ea580c; --panel-bg: rgba(28, 15, 5, 0.9); }
        body.theme-yellow { --bg-main: #1a1605; --text-main: #fef08a; --accent: #ca8a04; --panel-bg: rgba(26, 22, 5, 0.9); }
        body.theme-green { --bg-main: #051a05; --text-main: #bbf7d0; --accent: #16a34a; --panel-bg: rgba(5, 26, 5, 0.9); }
        body.theme-blue { --bg-main: #0c1a2b; --text-main: #e0f2fe; --accent: #00d2ff; --panel-bg: rgba(12, 26, 43, 0.9); }
        body.theme-purple { --bg-main: #11051a; --text-main: #ddd6fe; --accent: #9333ea; --panel-bg: rgba(17, 5, 26, 0.9); }
        body.theme-pink { --bg-main: linear-gradient(to bottom, #3f0e22, #1a0510); --text-main: #fce7f3; --accent: #f472b6; --panel-bg: rgba(26, 5, 16, 0.9); }
        body.theme-nature { --bg-main: linear-gradient(to bottom, #1a2e05, #0d1a0d); --text-main: #ecfccb; --accent: #65a30d; --panel-bg: rgba(13, 26, 13, 0.9); }
        body.theme-sea { --bg-main: linear-gradient(to bottom, #021d2e, #082f49); --text-main: #e0f2fe; --accent: #0ea5e9; --panel-bg: rgba(8, 47, 73, 0.9); }
        body.theme-snowy { --bg-main: linear-gradient(to bottom, #334155, #1e293b); --text-main: #f1f5f9; --accent: #94a3b8; --panel-bg: rgba(30, 41, 59, 0.9); }
        body.theme-starry { --bg-main: #000000; --text-main: #ffffff; --accent: #6366f1; --panel-bg: rgba(0, 0, 0, 0.9); }
        
        body.theme-milkyway { --bg-main: #000000; --text-main: #ffffff; --accent: #a855f7; --glass: rgba(0, 0, 0, 0.3); --border: rgba(168, 85, 247, 0.3); --panel-bg: rgba(0, 0, 0, 0.6); }
        .theme-milkyway .glass { border-color: rgba(168, 85, 247, 0.4); box-shadow: 0 0 20px rgba(124, 58, 237, 0.15); }
        .theme-milkyway .prestige-btn, .theme-milkyway .bulk-btn.active, .theme-milkyway .shop-tab-btn.active, .theme-milkyway .style-tab-btn.active {
            background: #7c3aed !important;
            box-shadow: 0 0 15px #7c3aed, 0 0 5px #a855f7;
            border: 1px solid #c084fc;
        }
        .theme-milkyway #score { text-shadow: 0 0 20px rgba(168, 85, 247, 0.8); }
        .theme-milkyway .lb-card, .theme-milkyway .upgrade-card, .theme-milkyway .ach-card { background: rgba(0, 0, 0, 0.2) !important; border-color: rgba(168, 85, 247, 0.2); }
        .theme-milkyway .click-btn-container { border-color: rgba(168, 85, 247, 0.8) !important; box-shadow: 0 0 30px rgba(168, 85, 247, 0.6), 0 0 60px rgba(124, 58, 237, 0.4), inset 0 0 20px rgba(168, 85, 247, 0.2); }

        body { font-family: 'Poppins', sans-serif; background: var(--bg-main); color: var(--text-main); margin: 0; height: 100vh; width: 100vw; overflow: hidden; transition: background 0.8s ease, color 0.5s ease; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .glass { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid var(--border); transition: var(--transition); transform: translateZ(0); backface-visibility: hidden; }
        
        .left-panel-content { background: var(--panel-bg); transition: var(--transition); }
        .side-tab { background: rgba(0,0,0,0.4); color: var(--text-main); opacity: 0.8; }
        .side-tab.active { background: var(--accent); color: white; opacity: 1; transform: translateX(5px); }
        .side-tab.locked { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; pointer-events: none; position: relative; }
        .side-tab.locked::after { content: 'üîí'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; }
        
        #score { color: var(--accent); transition: var(--transition); }

        #galaxy-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 1; }
        .hidden { display: none !important; }

        #theme-overlay { position: fixed; inset: 0; pointer-events: none !important; z-index: 1; overflow: hidden; }
        .particle { position: absolute; pointer-events: none !important; will-change: transform; user-select: none; }

        #ascension-tree-view { position: fixed; inset: 0; z-index: 0; background-image: radial-gradient(circle at center, transparent 0%, #000 90%), url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsPSJub25lIiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiIHN0cm9rZS13aWR0aD0iMSI+PHBhdGggZD0iTTAgMGg0MHY0MEgwWiIvPjwvc3ZnPg=='); background-color: #050510; background-repeat: repeat; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 1s ease; overflow: hidden; }
        #ascension-tree-view.active { opacity: 1; pointer-events: auto; z-index: 2000; }
        #tree-container { position: relative; width: 100%; height: 100%; overflow: visible; cursor: grab; transform-origin: 0 0; touch-action: none; padding: 60px; }
        #tree-container::-webkit-scrollbar { display: none; }

        .tree-node { position: absolute; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; background: #1e1b4b; border: 3px solid #4c1d95; box-shadow: 0 0 15px rgba(0,0,0,0.5); transition: all 0.2s; z-index: 10; will-change: transform; transform: translateZ(0); }
        .tree-node:hover { transform: scale(1.2) translateZ(0); z-index: 20; border-color: white; }
        .tree-node.type-root { border-color: white; background: #000; box-shadow: 0 0 30px white; width: 70px; height: 70px; font-size: 35px; }
        .tree-node.type-click { border-color: #ef4444; background: #450a0a; } 
        .tree-node.type-passive { border-color: #3b82f6; background: #172554; } 
        .tree-node.type-golden { border-color: #eab308; background: #422006; } 
        .tree-node.type-synergy { border-color: #a855f7; background: #3b0764; } 
        .tree-node.type-pet { border-color: #10b981; background: #064e3b; } 
        .tree-node.type-special { border-color: #fff; background: #333; box-shadow: 0 0 10px white; }
        .tree-node.owned { filter: brightness(1.2); box-shadow: 0 0 25px #ffd700, 0 0 10px #ffffff; border-color: #ffd700; opacity: 1; z-index: 15; }
        .tree-node.available { animation: pulseNode 2s infinite; opacity: 1; cursor: pointer; filter: brightness(1.1); }
        .tree-node.locked { filter: grayscale(1) brightness(0.5); opacity: 0.4; cursor: not-allowed; border-color: #4b5563; background: #111827; }
        @keyframes pulseNode { 0% { transform: scale(1) translateZ(0); } 50% { transform: scale(1.1) translateZ(0); } 100% { transform: scale(1) translateZ(0); } }

        #tree-tooltip { position: fixed; pointer-events: none; z-index: 3000; background: rgba(10, 10, 20, 0.95); border: 1px solid rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; width: 280px; box-shadow: 0 0 30px rgba(0,0,0,0.8); transform: translate(15px, 15px); display: none; backdrop-filter: blur(10px); }
        #tree-lines { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; overflow: visible !important; }
        line { stroke: #4b5563; stroke-width: 2; opacity: 0.3; transition: all 0.5s; stroke-linecap: round; }
        line.active { stroke: #e2e8f0; opacity: 0.6; stroke-width: 3; }

        #pet-container { position: fixed; inset: 0; pointer-events: none; z-index: 2500; }
        .game-pet { position: absolute; width: 60px; height: 60px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); font-size: 40px; pointer-events: auto; cursor: grab; user-select: none; display: flex; align-items: center; justify-content: center; background: transparent !important; transition: transform 0.2s ease, filter 0.2s ease; will-change: transform, left, top; transform: translateZ(0); }
        .game-pet:hover { transform: scale(1.15) translateZ(0); filter: brightness(1.2) drop-shadow(0 0 15px rgba(255,255,255,0.5)); z-index: 2600; }
        .game-pet:active { cursor: grabbing; transform: scale(0.95) translateZ(0); }
        .pet-label { position: absolute; top: 75%; left: 50%; transform: translateX(-50%); text-align: center; white-space: nowrap; line-height: 0.9; text-shadow: 0 2px 4px rgba(0,0,0,0.9), 0 0 2px black; pointer-events: none; z-index: 2501; }
        .diamond-text { color: #00ffff; text-shadow: 0 0 10px #00ffff, 0 0 20px rgba(0, 255, 255, 0.5); }
        .pet-smooth { transition: left 3s ease-in-out, top 3s ease-in-out; }
        .anim-float { animation: floatPet 4s ease-in-out infinite; }
        .anim-float-fast { animation: floatPet 2s ease-in-out infinite; }
        .anim-bounce { animation: bouncePet 1s infinite alternate; }
        .anim-pulse { animation: pulsePet 2s infinite; }
        .anim-shake { animation: shakePet 3s infinite; }
        @keyframes floatPet { 0%, 100% { transform: translateY(0) translateZ(0); } 50% { transform: translateY(-20px) translateZ(0); } }
        @keyframes bouncePet { 0% { transform: translateY(0) translateZ(0); } 100% { transform: translateY(-15px) translateZ(0); } }
        @keyframes pulsePet { 0% { transform: scale(1) translateZ(0); opacity: 0.8; } 50% { transform: scale(1.2) translateZ(0); opacity: 1; } 100% { transform: scale(1) translateZ(0); opacity: 0.8; } }
        @keyframes shakePet { 0%, 100% { transform: rotate(0deg) translateZ(0); } 25% { transform: rotate(5deg) translateZ(0); } 75% { transform: rotate(-5deg) translateZ(0); } }
        
        #pm-upgrade-btn { transition: all 0.1s ease-out; }
        .flash-success { background: #10b981 !important; border-color: #34d399 !important; transform: scale(1.02); filter: brightness(1.2); }
        .screen-falling { animation: crackAndFall 2s cubic-bezier(0.6, 0.05, 0.2, 1) forwards; pointer-events: none !important; }
        @keyframes crackAndFall { 0% { transform: translateY(0) rotate(0); opacity: 1; filter: contrast(1); } 10% { transform: translateY(20px) rotate(-1deg); opacity: 1; filter: contrast(1.2) brightness(1.5); } 100% { transform: translateY(150vh) rotate(5deg); opacity: 0; } }

        /* RESPONSIVE LAYOUT */
        .game-grid { display: grid; grid-template-columns: 350px 1fr 350px; grid-template-rows: 1fr; height: 100vh; gap: 1.5rem; padding: 1.5rem; box-sizing: border-box; position: relative; z-index: 10; transition: opacity 0.5s; }
        
        @media (max-width: 1024px) { 
            .game-grid { display: flex; flex-direction: column; overflow-y: auto; height: 100vh; grid-template-columns: 1fr; } 
            .left-area, .right-area { min-height: 500px; width: 100%; flex-shrink: 0; } 
            .center-area { min-height: 600px; order: -1; flex-shrink: 0; width: 100%; } 
            .side-tabs-container { right: 10px !important; top: 10px !important; flex-direction: row !important; height: auto !important; width: auto !important; } 
            .side-tab { writing-mode: horizontal-tb !important; padding: 8px 15px !important; border-radius: 8px !important; } 
            body { overflow-y: auto; } 
            .click-btn-container { width: 300px !important; height: 300px !important; }
        }

        .left-area { position: relative; height: 100%; min-height: 0; }
        .center-area { display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 1rem 0; height: 100%; }
        .right-area { display: flex; flex-direction: column; gap: 1rem; height: 100%; overflow: hidden; }
        .scroll-panel { overflow-y: auto; flex-grow: 1; scrollbar-width: thin; scrollbar-color: var(--accent) transparent; }
        .scroll-panel::-webkit-scrollbar { width: 4px; }
        .scroll-panel::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
        .side-tabs-container { position: absolute; right: -32px; top: 50px; display: flex; flex-direction: column; gap: 10px; z-index: 20; }
        .side-tab { border: 1px solid var(--border); border-left: none; padding: 15px 8px; border-radius: 0 12px 12px 0; cursor: pointer; writing-mode: vertical-lr; text-orientation: mixed; font-size: 10px; font-weight: 800; transition: all 0.2s; }
        .click-btn-container { transition: transform 0.05s active, background 0.5s ease; cursor: pointer; user-select: none; position: relative; background: var(--accent) !important; box-shadow: 0 0 25px rgba(168, 85, 247, 0.4); transform: translateZ(0); will-change: transform; }
        .click-btn-container:active { transform: scale(0.95) translateZ(0); }
        .click-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; pointer-events: none; transform: translateZ(0); }
        .upgrade-card, .ach-card, .prestige-card, .theme-card, .nametag-card { transition: all 0.2s; border: 1px solid var(--border); border-radius: 1rem; background: rgba(0,0,0,0.4); }
        .upgrade-card:hover:not(.disabled), .prestige-card:hover:not(.disabled), .theme-card:hover, .nametag-card:hover { background: rgba(59, 130, 246, 0.1); border-color: var(--accent); cursor: pointer; }
        .theme-card.active, .nametag-card.active { border-color: var(--accent); background: rgba(59, 130, 246, 0.2); border-width: 2px; }
        .upgrade-card.disabled, .prestige-card.disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(1); }
        .ach-card.locked { opacity: 0.3; filter: grayscale(1); }
        .ach-card.unlocked { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.4); box-shadow: 0 0 10px rgba(16,185,129,0.1); }
        .stat-row { display: flex; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid var(--border); }
        .bulk-btn.active, .shop-tab-btn.active, .style-tab-btn.active { background: var(--accent); color: white; }
        .float-text { position: absolute; color: var(--accent); font-weight: 800; font-size: 2rem; pointer-events: none; animation: floatUp 3s ease-out forwards; z-index: 100; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-150px); opacity: 0; } }
        /* Golden Vraj Update: High z-index, pointer-events auto */
        .golden-vraj { position: absolute; width: 80px; height: 80px; cursor: pointer; z-index: 10000; filter: drop-shadow(0 0 15px gold) brightness(1.5); animation: goldenFly 10s linear forwards; pointer-events: auto !important; }
        @keyframes goldenFly { 0% { left: -100px; top: 20%; } 100% { left: 110vw; top: 60%; } }
        .puff-effect { position: absolute; width: 100px; height: 100px; border-radius: 50%; background: radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,215,0,0) 70%); transform: translate(-50%, -50%) scale(0); animation: puffAnim 0.4s ease-out forwards; pointer-events: none; z-index: 10001; }
        @keyframes puffAnim { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2); opacity: 0; } }
        .prestige-btn { background: linear-gradient(135deg, var(--accent), #7c3aed); border: 2px solid rgba(255,255,255,0.2); transition: all 0.3s ease; }
        .lb-card { background: var(--glass); border: 1px solid var(--border); border-radius: 12px; }
        .lb-rank-1 { background: rgba(255, 215, 0, 0.2) !important; border-color: gold !important; }
        .lb-rank-2 { background: rgba(192, 192, 192, 0.2) !important; border-color: silver !important; }
        .lb-rank-3 { background: rgba(205, 127, 50, 0.2) !important; border-color: #cd7f32 !important; }
        #game-modal { z-index: 3000; position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); padding: 20px; }
        
        /* UPDATED: Multiplier Position - Bottom Right, Left of Chat (approx 370px) */
        #multiplier-display { position: fixed; bottom: 20px; right: 380px; z-index: 4000; pointer-events: none; display: flex; }
        @media (max-width: 1024px) { #multiplier-display { bottom: auto; top: 20px; right: 20px; } }
        .dev-tag { background: linear-gradient(to right, #ef4444, #f87171); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; margin-right: 5px; text-transform: uppercase; font-size: 0.7em; vertical-align: middle; }
        .beta-tag { background: linear-gradient(to right, #3b82f6, #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; margin-right: 5px; text-transform: uppercase; font-size: 0.7em; vertical-align: middle; }
        
        /* Achievement Popup */
        #achievement-popup {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(16, 185, 129, 0.1); backdrop-filter: blur(12px);
            border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 16px;
            padding: 12px 24px; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5), 0 0 10px rgba(16, 185, 129, 0.2);
            transition: bottom 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 4000; pointer-events: none; width: 350px;
        }
        #achievement-popup.show { bottom: 30px; }
        
        .nametag-classic { color: #fff; font-weight: bold; }
        .nametag-galaxy { background: linear-gradient(90deg, #ff00cc, #3333ff, #00ccff, #ff00cc); background-size: 300% 300%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: galaxyShine 2s linear infinite; font-weight: 900; filter: drop-shadow(0 0 3px rgba(51, 51, 255, 0.8)); position: relative; }
        .nametag-fire { background: linear-gradient(0deg, #f59e0b, #ef4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; filter: drop-shadow(0 -2px 4px rgba(239, 68, 68, 0.5)); }
        .nametag-ice { background: linear-gradient(180deg, #e0f2fe, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; text-shadow: 0 0 10px #3b82f6; }
        .nametag-gold { background: linear-gradient(45deg, #ffd700, #b8860b, #ffd700); background-size: 200%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; animation: textShine 4s ease infinite; filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.8)); }
        .nametag-matrix { color: #22c55e; font-family: 'Share Tech Mono', monospace; text-shadow: 0 0 5px #22c55e; font-weight: bold; }
        .nametag-neon { color: #fff; text-shadow: 0 0 5px #fff, 0 0 10px #f0f, 0 0 20px #f0f, 0 0 30px #f0f; font-weight: 900; }
        .nametag-ghost { color: rgba(255, 255, 255, 0.5); filter: blur(0.5px); text-shadow: 0 0 10px rgba(255, 255, 255, 0.8); }
        .nametag-royal { background: linear-gradient(to right, #eab308, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; font-family: 'Cinzel', serif; }
        .nametag-electric { color: #e0f2fe; text-shadow: 0 0 3px #0ea5e9, 0 0 10px #0ea5e9; font-style: italic; font-weight: 900; }
        .nametag-shadow { color: #000; text-shadow: 0 0 5px #fff; font-weight: 900; }
        @keyframes textShine { to { background-position: 200% center; } }
        @keyframes galaxyShine { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .nature-leaf { font-size: 20px; animation: fall 10s linear infinite; }
        .snow-flake { font-size: 15px; animation: fall 8s linear infinite; opacity: 0.8; }
        .sea-bubble { font-size: 15px; animation: rise 15s linear infinite; opacity: 0.6; }
        .star { position: absolute; border-radius: 50%; animation: twinkle 3s infinite ease-in-out; }
        @keyframes fall { 0% { transform: translateY(-20vh) translateX(0) rotate(0deg); opacity: 0; } 100% { transform: translateY(110vh) translateX(100px) rotate(360deg); opacity: 0; } }
        @keyframes rise { 0% { transform: translateY(110vh) translateX(0); opacity: 0; } 100% { transform: translateY(-20vh) translateX(-50px); opacity: 0; } }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
        
        .warp-transition { animation: warpIn 0.1s ease-out forwards; }
        @keyframes warpIn { 0% { transform: scale(0.95) translateY(10px); opacity: 0.9; filter: blur(5px); } 100% { transform: scale(1) translateY(0); opacity: 1; filter: blur(0); } }

        #pet-menu-modal { position: absolute; z-index: 5000; background: rgba(10, 15, 30, 0.95); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; backdrop-filter: blur(12px); padding: 12px; width: 240px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); pointer-events: auto; transition: opacity 0.1s ease, transform 0.1s ease; }
        #pet-menu-content { background: transparent; border: none; padding: 0; box-shadow: none; }
        #pet-menu-arrow { position: absolute; width: 12px; height: 12px; background: rgba(10, 15, 30, 0.95); transform: rotate(45deg); border: 1px solid rgba(255,255,255,0.2); z-index: -1; }
        .menu-top #pet-menu-arrow { bottom: -6px; left: 50%; margin-left: -6px; border-top: none; border-left: none; }
        .menu-bottom #pet-menu-arrow { top: -6px; left: 50%; margin-left: -6px; border-bottom: none; border-right: none; }
        .menu-left #pet-menu-arrow { right: -6px; top: 50%; margin-top: -6px; border-bottom: none; border-left: none; }
        .menu-right #pet-menu-arrow { left: -6px; top: 50%; margin-top: -6px; border-top: none; border-right: none; }

        /* ANTI CHEAT MODAL */
        #cheat-warning {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(20, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; color: #ef4444; font-family: 'Share Tech Mono', monospace;
        }
        .cheat-glitch { animation: glitch 0.3s infinite; }
        @keyframes glitch { 0% { transform: translate(0,0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(2px, -2px); } 60% { transform: translate(-2px, -2px); } 80% { transform: translate(2px, 2px); } 100% { transform: translate(0,0); } }
        
        #cheat-btn { transition: all 0.3s ease; }
        #cheat-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    </style>
</head>
<body class="select-none theme-classic" oncontextmenu="return false;">

    <canvas id="galaxy-canvas" class="hidden"></canvas>
    <div id="theme-overlay"></div>
    <div id="pet-container"></div>
    
    <div id="cheat-warning" class="hidden">
        <div class="absolute top-1/4 w-full text-center">
            <h1 class="text-6xl font-black mb-4 cheat-glitch">‚ö†Ô∏è DETECTION ‚ö†Ô∏è</h1>
            <p class="text-2xl font-bold mb-4 text-red-400">UNNATURAL CLICKING DETECTED</p>
            <p class="text-white/80 mb-2 text-sm max-w-lg mx-auto">We have detected automated clicking software, macros, or inhuman patterns.</p>
            <p class="text-white/80 mb-8 text-sm max-w-lg mx-auto">This is your <span class="font-bold text-white underline">FINAL WARNING</span>.</p>
            <p class="text-xs text-red-500 font-bold">STRIKE <span id="strike-count">1</span> / 2</p>
        </div>
        
        <div class="absolute bottom-24 w-full flex justify-center">
            <button id="cheat-btn" onclick="acknowledgeStrike()" disabled class="px-12 py-4 bg-red-600 hover:bg-red-500 text-white font-black rounded-lg transition-colors border border-red-400">
                I UNDERSTAND <span id="cheat-timer">(3)</span>
            </button>
        </div>
    </div>
    
    <div id="ban-screen" class="hidden fixed inset-0 z-[10000] bg-red-950/90 flex items-center justify-center text-center p-10">
        <div>
            <h1 class="text-6xl font-black text-red-500 mb-4">BANNED</h1>
            <p class="text-white/80 text-xl">You have been banned from Vraj Clicker 2.</p>
            <p class="text-white/50 text-sm mt-4">Reason: Violation of Terms</p>
            <button onclick="location.reload()" class="mt-8 px-6 py-2 bg-red-800 text-white rounded font-bold">Try Reconnect</button>
        </div>
    </div>

    <div class="fixed top-4 right-20 z-50 flex gap-2">
        <button id="music-toggle-btn" onclick="toggleMusic()" class="bg-white/10 p-2 rounded-full border border-white/20 hover:bg-white/20 backdrop-blur-md transition-all text-xl hidden">üéµ</button>
        <button id="global-mute-btn" onclick="toggleMute()" class="hidden bg-white/10 p-2 rounded-full border border-white/20 hover:bg-white/20 backdrop-blur-md transition-all text-xl">üîä</button>
    </div>

    <div id="achievement-popup">
        <div id="ach-popup-icon" class="text-4xl">üèÜ</div>
        <div>
            <p class="text-xs text-emerald-400 font-bold uppercase tracking-wider mb-1">Achievement Unlocked!</p>
            <p id="ach-popup-title" class="text-sm font-bold text-white">Title Here</p>
        </div>
    </div>

    <div id="ascension-tree-view">
        <div class="absolute top-0 w-full p-6 text-center z-20 bg-gradient-to-b from-black to-transparent pointer-events-none">
            <h1 class="text-4xl font-bold text-yellow-500 drop-shadow-lg" style="font-family: 'Cinzel', serif; letter-spacing: 2px;">HEAVENLY UPGRADES</h1>
            <p class="text-blue-300 text-lg font-bold mt-1">Fatflaps: <span id="tree-fatflaps" class="text-white">0</span> ü•û</p>
        </div>
        <div id="tree-container">
            <svg id="tree-lines"></svg>
        </div>
        <div id="tree-tooltip">
            <h3 class="font-bold text-white text-lg border-b border-white/20 pb-1 mb-1" id="tt-name">Title</h3>
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold px-2 py-0.5 rounded bg-gray-700 text-gray-300" id="tt-type">Type</span>
                <span class="text-xs font-black text-yellow-400" id="tt-cost">Cost</span>
            </div>
            <p class="text-xs text-gray-300 leading-relaxed" id="tt-desc">Description</p>
            <p class="text-[10px] text-gray-500 mt-2 italic" id="tt-quote">"Flavor text goes here."</p>
        </div>
        <div class="absolute bottom-10 z-20">
             <button onclick="reincarnate()" class="px-12 py-4 bg-gradient-to-t from-red-900 to-red-600 rounded-lg font-black text-white text-xl border-2 border-red-400 shadow-[0_0_20px_rgba(220,38,38,0.6)] hover:scale-105 transition-transform hover:shadow-[0_0_40px_rgba(220,38,38,0.8)]" style="font-family: 'Cinzel', serif;">
                REINCARNATE
            </button>
        </div>
    </div>

    <div id="owner-modal" class="hidden fixed inset-0 z-[4000] bg-black/90 flex items-center justify-center">
        <div class="glass p-8 rounded-3xl w-96 border border-red-500/50 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-black text-red-500 mb-4 text-center">DEV CONSOLE</h2>
            
            <div class="space-y-4 mb-6 pb-6 border-b border-white/10">
                <h3 class="text-sm font-bold text-white/50 uppercase">Self Actions</h3>
                <input type="number" id="cheat-amount" placeholder="Amount" class="w-full p-2 bg-black/50 border border-white/10 rounded text-white">
                <button onclick="cheatAddVrajs()" class="w-full bg-blue-600 p-2 rounded font-bold">Add Vrajs (Self)</button>
                <button onclick="cheatAddFatflaps()" class="w-full bg-purple-600 p-2 rounded font-bold">Add Fatflaps (Self)</button>
            </div>
            
            <div class="space-y-4">
                <h3 class="text-sm font-bold text-white/50 uppercase">User Management</h3>
                <input type="text" id="admin-target-user" placeholder="Target Username" class="w-full p-2 bg-black/50 border border-white/10 rounded text-white font-bold text-yellow-400">
                
                <div class="flex gap-2 mb-2">
                    <input type="text" id="admin-new-username" placeholder="New Username" class="w-full p-2 bg-black/50 border border-white/10 rounded text-white text-xs">
                    <button onclick="adminAction('rename')" class="bg-gray-600 px-3 rounded font-bold text-xs hover:bg-gray-500 whitespace-nowrap">Change Name</button>
                </div>

                <div class="flex gap-2 mb-4">
                    <input type="email" id="admin-reset-email" placeholder="Target Email for Password Reset" class="w-full p-2 bg-black/50 border border-white/10 rounded text-white text-xs">
                    <button onclick="adminTriggerPasswordReset()" class="bg-indigo-600 px-3 rounded font-bold text-xs hover:bg-indigo-500 whitespace-nowrap">Send Email</button>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <button onclick="adminAction('ban')" class="bg-red-600 p-2 rounded font-bold text-xs hover:bg-red-500">BAN USER</button>
                    <button onclick="adminAction('unban')" class="bg-emerald-600 p-2 rounded font-bold text-xs hover:bg-emerald-500">UNBAN USER</button>
                    <button onclick="adminAction('kick')" class="bg-orange-600 p-2 rounded font-bold text-xs hover:bg-orange-500">KICK USER</button>
                    <button onclick="adminAction('reset_progress')" class="bg-red-800 border border-red-500 p-2 rounded font-bold text-xs hover:bg-red-700 text-red-200">RESET PROGRESS</button>
                </div>
                
                <div class="flex gap-2 mt-4">
                    <select id="admin-stat-type" class="bg-black/50 border border-white/10 rounded text-white text-xs p-2 flex-1">
                        <option value="totalVrajs">Set Vrajs</option>
                        <option value="fatflaps">Set Fatflaps</option>
                        <option value="prestigeCount">Set Ascensions</option>
                    </select>
                    <input type="number" id="admin-stat-val" placeholder="Val" class="w-20 bg-black/50 border border-white/10 rounded text-white p-2 text-xs">
                </div>
                <button onclick="adminSetStat()" class="w-full bg-gray-600 p-2 rounded font-bold text-xs hover:bg-gray-500">SET STAT</button>

                <div class="pt-4 border-t border-white/10 mt-4">
                     <button onclick="adminGlobalRefresh()" class="w-full bg-blue-900/50 border border-blue-500 text-blue-300 p-2 rounded font-bold text-xs hover:bg-blue-800">GLOBAL REFRESH (ALL TABS)</button>
                </div>
            </div>

            <button onclick="document.getElementById('owner-modal').classList.add('hidden')" class="w-full bg-gray-800 p-2 rounded font-bold mt-6">Close Console</button>
        </div>
    </div>

    <div id="game-modal" class="hidden">
        <div class="glass p-8 rounded-3xl max-w-md w-full border-white/20 shadow-2xl">
            <h2 id="modal-title" class="text-2xl font-black mb-4">Title</h2>
            <div id="modal-content" class="text-sm opacity-80 mb-8 leading-relaxed">Content</div>
            <div id="modal-input-container" class="hidden mb-6">
                <input type="text" id="modal-text-input" placeholder="Type here..." class="w-full p-4 rounded-xl bg-gray-900 border border-gray-700 outline-none text-white">
            </div>
            <div id="modal-footer" class="flex gap-4">
                <button id="modal-cancel" class="flex-1 py-3 bg-gray-800 rounded-xl font-bold">Cancel</button>
                <button id="modal-confirm" class="flex-1 py-3 bg-blue-600 rounded-xl font-bold">Confirm</button>
            </div>
        </div>
    </div>

    <div id="pet-menu-modal" class="hidden">
        <div id="pet-menu-arrow"></div>
        <div id="pet-menu-content">
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-3">
                    <div id="pm-emoji" class="text-3xl filter drop-shadow-md">ü•ö</div>
                    <div>
                         <input type="text" id="pm-name" class="bg-transparent border-b border-white/10 w-28 text-sm font-bold focus:outline-none focus:border-white text-white" placeholder="Name">
                         <p class="text-xs font-bold text-blue-300 mt-0.5">Lvl <span id="pm-level">1</span></p>
                    </div>
                </div>
                <button onclick="closePetMenu()" class="text-white/30 hover:text-white text-sm font-bold">‚úï</button>
            </div>
            
            <div class="grid grid-cols-2 gap-2 mb-3">
                 <div class="bg-white/5 rounded-lg p-2 text-center border border-white/5">
                     <p class="text-[8px] text-gray-400 uppercase tracking-wider mb-1">EFFECT</p>
                     <p id="pm-effect" class="text-[9px] font-bold text-white leading-tight">...</p>
                 </div>
                 <div onclick="togglePetMode()" class="bg-white/5 rounded-lg p-2 text-center border border-white/5 cursor-pointer hover:bg-white/10 transition">
                     <p class="text-[8px] text-gray-400 uppercase tracking-wider mb-1">MODE</p>
                     <p id="pm-mode-btn" class="text-[9px] font-bold text-blue-300">ROAM</p>
                 </div>
            </div>

            <button onclick="upgradePet()" id="pm-upgrade-btn" class="w-full py-2 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-lg font-bold shadow-lg flex justify-between px-3 items-center hover:scale-[1.02]">
                <span class="text-[10px] uppercase">Upgrade</span>
                <span class="text-[9px] bg-black/20 px-1.5 py-0.5 rounded text-emerald-100" id="pm-cost">1k</span>
            </button>
        </div>
    </div>

    <div id="multiplier-display" class="hidden">
        <div class="glass p-3 rounded-2xl border-yellow-500/50 border flex items-center gap-3 shadow-xl">
            <span class="text-2xl">üåü</span>
            <div>
                <p class="text-[9px] font-bold text-yellow-400 tracking-tighter uppercase"><span id="multiplier-value">2x</span> MULTI ACTIVE</p>
                <p id="mult-timer" class="text-md font-black">03:00</p>
            </div>
        </div>
    </div>

    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass p-8 rounded-3xl shadow-2xl w-full max-w-md text-center">
            <h1 class="text-4xl font-extrabold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">Vraj Clicker 2</h1>
            <div id="auth-tabs" class="flex mb-6 bg-black/20 rounded-lg p-1">
                <button onclick="switchTab('login')" id="tab-login" class="flex-1 py-2 rounded-md font-semibold bg-blue-600">Login</button>
                <button onclick="switchTab('signup')" id="tab-signup" class="flex-1 py-2 rounded-md font-semibold opacity-50">Sign Up</button>
            </div>
            <div id="login-form" class="space-y-4">
                <input type="email" id="li-email" placeholder="Email" class="w-full p-4 rounded-xl bg-black/20 border border-white/10 outline-none">
                <input type="password" id="li-password" placeholder="Password" class="w-full p-4 rounded-xl bg-black/20 border border-white/10 outline-none">
                <button onclick="handleLogin()" class="w-full bg-blue-600 p-4 rounded-xl font-bold">Enter Game</button>
                <button onclick="handleGuest()" class="w-full bg-gray-700 p-4 rounded-xl font-bold text-sm">Play as Guest</button>
            </div>
            <div id="signup-form" class="hidden space-y-4">
                <input type="text" id="su-username" placeholder="Username" class="w-full p-4 rounded-xl bg-black/20 border border-white/10 outline-none">
                <input type="email" id="su-email" placeholder="Email" class="w-full p-4 rounded-xl bg-black/20 border border-white/10 outline-none">
                <input type="password" id="su-password" placeholder="Password" class="w-full p-4 rounded-xl bg-black/20 border border-white/10 outline-none">
                <button onclick="handleSignup()" class="w-full bg-emerald-600 p-4 rounded-xl font-bold">Create Account</button>
            </div>
            <div id="verify-notice" class="hidden flex flex-col items-center justify-center space-y-4 py-4">
                <h2 class="text-2xl font-black text-yellow-400">Verify Your Email</h2>
                <p class="text-white/80 text-sm mb-4">We sent a link to your inbox.<br>Please check your <b>Spam Folder</b> too!</p>
                <button onclick="resendVerification()" id="resend-btn" class="bg-white/10 border border-white/20 p-3 rounded-xl font-bold w-full hover:bg-white/20 transition">Resend Email</button>
                <button onclick="location.reload()" class="bg-emerald-600 p-3 rounded-xl font-bold w-full shadow-lg hover:scale-105 transition">I've Verified!</button>
                <button onclick="backToLogin()" class="text-xs text-white/50 hover:text-white underline mt-2">Wrong Email? Go Back</button>
            </div>
        </div>
    </div>

    <div id="game-screen" class="hidden h-screen overflow-hidden">
        <div class="game-grid" id="main-grid">
            <div class="left-area">
                <div class="glass rounded-3xl flex flex-col h-full overflow-hidden relative z-10">
                    <div id="panel-shop" class="left-panel-content flex flex-col h-full overflow-hidden">
                        <div class="p-4 border-b border-white/10 bg-white/5 space-y-3 flex-shrink-0">
                            <h3 class="font-bold">üè™ Vraj Shop</h3>
                            <div class="flex bg-black/40 rounded-lg p-1 text-[10px] font-bold">
                                <button onclick="setBulk(1)" id="bulk-1" class="bulk-btn flex-1 py-1 rounded active">1X</button>
                                <button onclick="setBulk(10)" id="bulk-10" class="bulk-btn flex-1 py-1 rounded">10X</button>
                                <button onclick="setBulk(100)" id="bulk-100" class="bulk-btn flex-1 py-1 rounded">100X</button>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="setShopTab('clicker')" id="shop-tab-clicker" class="shop-tab-btn flex-1 py-2 rounded-lg text-[10px] font-bold bg-white/5 active">CLICKERS</button>
                                <button onclick="setShopTab('passive')" id="shop-tab-passive" class="shop-tab-btn flex-1 py-2 rounded-lg text-[10px] font-bold bg-white/5">PASSIVE</button>
                            </div>
                        </div>
                        <div id="shop-list" class="scroll-panel p-4 space-y-3"></div>
                    </div>
                    
                    <div id="panel-prestige" class="left-panel-content hidden h-full flex flex-col overflow-hidden">
                        <div class="p-6 border-b border-white/10 bg-white/5 flex-shrink-0 text-center">
                            <h3 class="font-bold text-purple-400 text-xl mb-2">üìà Ascension</h3>
                            <p class="text-[10px] opacity-60 uppercase font-bold mb-4">Reset progress for permanent power</p>
                            <div class="w-full bg-black/40 h-6 rounded-full overflow-hidden border border-white/10 relative mb-4">
                                <div id="prestige-bar" class="h-full bg-gradient-to-r from-purple-600 to-blue-500 transition-all duration-300" style="width: 0%"></div>
                                <span id="prestige-percent" class="absolute inset-0 flex items-center justify-center text-[10px] font-black text-white">0%</span>
                            </div>
                            <button id="prestige-btn" onclick="openPrestigeModal()" class="prestige-btn w-full py-4 rounded-2xl font-black text-white shadow-lg transform active:scale-95 transition-all">
                                ASCEND <span id="prestige-gain-display">(+0 Fatflaps)</span>
                            </button>
                            <p class="text-[9px] opacity-50 mt-2 italic">Next Fatflap costs: <span id="next-prestige-cost">1,000,000</span></p>
                        </div>
                        <div id="prestige-shop-list" class="scroll-panel p-4 space-y-3"></div>
                    </div>

                    <div id="panel-achievements" class="left-panel-content hidden h-full flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-white/10 bg-white/5 flex-shrink-0">
                            <h3 class="font-bold text-purple-400 mb-2">üèÜ Achievements</h3>
                            <div class="w-full bg-black/40 h-4 rounded-full overflow-hidden border border-white/5">
                                <div id="ach-progress-bar" class="h-full bg-gradient-to-r from-purple-500 to-blue-500 transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <p class="text-[10px] font-bold opacity-60 mt-1 uppercase tracking-widest text-right">
                                Completed: <span id="ach-count">0</span> / <span id="ach-total">0</span>
                            </p>
                        </div>
                        <div id="ach-list" class="scroll-panel p-4 space-y-2"></div>
                    </div>

                    <div id="panel-style" class="left-panel-content hidden h-full flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-white/10 bg-white/5 space-y-3 flex-shrink-0">
                            <h3 class="font-bold text-pink-400">üé® Style Studio</h3>
                            <div class="flex gap-2">
                                <button onclick="setStyleTab('vrajs')" id="style-tab-vrajs" class="style-tab-btn flex-1 py-2 rounded-lg text-[9px] font-bold bg-white/5">VRAJ'S</button>
                                <button onclick="setStyleTab('names')" id="style-tab-names" class="style-tab-btn flex-1 py-2 rounded-lg text-[9px] font-bold bg-white/5">NAME TAGS</button>
                                <button onclick="setStyleTab('themes')" id="style-tab-themes" class="style-tab-btn flex-1 py-2 rounded-lg text-[9px] font-bold bg-white/5 active">THEMES</button>
                            </div>
                        </div>
                        <div id="style-list" class="scroll-panel p-4 space-y-3"></div>
                    </div>

                    <div id="panel-stats" class="left-panel-content hidden h-full flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-white/10 bg-white/5 flex-shrink-0">
                            <h3 class="font-bold text-emerald-400">üìä Statistics</h3>
                        </div>
                        <div class="scroll-panel p-2 space-y-1 text-sm">
                            <div class="stat-row"><span>Time Played</span><span id="stat-time-played" class="font-bold">0s</span></div>
                            <div class="stat-row"><span>Total Vrajs</span><span id="stat-total-vrajs" class="font-bold">0</span></div>
                            <div class="stat-row"><span>Manual Clicks</span><span id="stat-manual-clicks" class="font-bold">0</span></div>
                            <div class="stat-row"><span>Total Crits</span><span id="stat-total-crits" class="font-bold text-red-400">0</span></div>
                            <div class="stat-row"><span>Upgrades</span><span id="stat-upgrades-bought" class="font-bold">0</span></div>
                            <div class="stat-row"><span>Golden Caught</span><span id="stat-golden-caught" class="font-bold">0</span></div>
                            <div class="stat-row"><span>Messages Sent</span><span id="stat-chats-sent" class="font-bold">0</span></div>
                            <div class="stat-row"><span>Ascensions</span><span id="stat-prestige-count" class="text-purple-400 font-bold">0</span></div>
                            <div class="p-2 border-b border-white/10"><p class="text-xs font-bold text-purple-400 uppercase tracking-widest">Multipliers</p></div>
                            <div class="stat-row"><span>Click Power %</span><span id="stat-mult-click" class="text-yellow-400 font-bold">100%</span></div>
                            <div class="stat-row"><span>Passive Gen %</span><span id="stat-mult-passive" class="text-blue-400 font-bold">100%</span></div>
                        </div>
                    </div>

                    <div id="panel-settings" class="left-panel-content hidden h-full p-6 flex flex-col justify-between">
                        <div class="space-y-6">
                            <h3 class="font-bold opacity-50 text-xl mb-4">‚öôÔ∏è System</h3>
                            <div class="space-y-3">
                                <button onclick="triggerAccountReset()" class="w-full p-4 bg-red-600/10 border border-red-600/30 text-red-500 rounded-xl text-left text-sm font-bold hover:bg-red-600/20 transition">
                                    Reset Account Progress
                                </button>
                                <button id="dev-menu-btn" onclick="document.getElementById('owner-modal').classList.remove('hidden')" class="hidden w-full p-4 bg-purple-900/20 border border-purple-500/30 text-purple-400 rounded-xl text-left text-sm font-bold">
                                    [DEV] Owner Menu
                                </button>
                            </div>
                        </div>
                        <button onclick="logoutAction()" class="w-full bg-gray-800 text-gray-400 p-4 rounded-xl font-bold border border-white/5">Sign Out</button>
                    </div>
                </div>
                <div class="side-tabs-container">
                    <div id="tab-shop" onclick="switchSideTab('shop')" class="side-tab active">SHOP</div>
                    <div id="tab-prestige" onclick="switchSideTab('prestige')" class="side-tab locked">ASCEND</div>
                    <div id="tab-achievements" onclick="switchSideTab('achievements')" class="side-tab">GOALS</div>
                    <div id="tab-style" onclick="switchSideTab('style')" class="side-tab">STYLE</div>
                    <div id="tab-stats" onclick="switchSideTab('stats')" class="side-tab">STATS</div>
                    <div id="tab-settings" onclick="switchSideTab('settings')" class="side-tab">SYSTEM</div>
                </div>
            </div>

            <div class="center-area">
                <div class="text-center">
                    <div id="fatflap-display" class="mb-2 flex items-center justify-center gap-2 hidden">
                        <span class="text-2xl">ü•û</span>
                        <span id="fatflap-count" class="text-2xl font-black text-purple-400">0</span>
                        <span class="text-[10px] font-bold text-purple-500/80 uppercase">Fatflaps</span>
                    </div>
                    <h2 id="score" class="text-7xl font-black drop-shadow-lg">0 Vrajs</h2>
                    <p id="vps-display" class="text-emerald-400 font-bold tracking-widest text-sm uppercase">0 VPS</p>
                    <p id="ppc-display" class="font-bold text-[10px] mt-1 opacity-80">1 Vrajs Per Click</p>
                </div>
                
                <div class="flex flex-col items-center gap-4">
                    <div id="clicker-container" class="click-btn-container w-[450px] h-[450px] rounded-full p-1 shadow-2xl">
                        <div class="w-full h-full rounded-full overflow-hidden border-8 border-black/80 transition-colors duration-500 bg-black">
                            <img src="image_0.png" class="click-img">
                        </div>
                    </div>
                    <div class="glass px-6 py-2 rounded-full border border-white/10">
                        <p class="text-xs font-black tracking-widest uppercase opacity-60">Total Multiplier: <span id="icon-mult-display" class="text-yellow-400">1.0x</span></p>
                    </div>
                </div>

                <div class="w-full max-w-xs text-center pb-8">
                    <div class="glass p-3 rounded-2xl text-xs opacity-60">User: <span id="user-display" class="font-bold">...</span></div>
                </div>
            </div>

            <div class="right-area">
                <div class="glass rounded-3xl flex-1 flex flex-col overflow-hidden min-h-[300px]">
                    <div class="p-4 bg-white/5 font-bold text-purple-400 flex-shrink-0">üèÜ Leaderboard</div>
                    <div id="leaderboard-list" class="scroll-panel p-4 space-y-2"></div>
                </div>
                <div class="glass rounded-3xl flex-1 flex flex-col overflow-hidden min-h-[300px]">
                    <div class="p-4 bg-white/5 font-bold text-emerald-400 flex-shrink-0">üí¨ Global Chat</div>
                    <div id="chat-box" class="scroll-panel p-4 flex flex-col text-sm"></div>
                    <form id="chat-form" class="p-3 bg-white/5 flex gap-2 flex-shrink-0">
                        <input type="text" id="chat-input" placeholder="Type..." class="flex-grow bg-black/40 border border-white/10 p-2 rounded-lg text-xs outline-none">
                        <button class="bg-emerald-600 px-3 py-2 rounded-lg text-xs font-bold text-white">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously, onAuthStateChanged, sendEmailVerification, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection, query, where, orderBy, limit, onSnapshot, getDocs, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import * as THREE from 'three';

        const firebaseConfig = { apiKey: "AIzaSyDwg2ZSpQspAD-o19AZCOHcrl9VnYc_sdk", authDomain: "vraj-clicker-2.firebaseapp.com", projectId: "vraj-clicker-2", storageBucket: "vraj-clicker-2.firebasestorage.app", messagingSenderId: "162243172716", appId: "1:162243172716:web:874a1f8be471a9f0d83b49" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const clickSound = new Audio('click.mp3');
        const achievementSound = new Audio('achievement.mp3');
        const sirenSound = new Audio('siren.mp3'); 
        const bgm = new Audio('bgm.mp3');
        bgm.loop = true;
        bgm.volume = 0.4;
        sirenSound.volume = 0.8;

        // --- AUTH CONSTANTS ---
        const DEV_EMAIL = "jaash08@gmail.com";
        const TESTER_EMAILS = [
            "gabrielspiteri820@gmail.com",
            "haydenrcordell@gmail.com",
            "hexege9960@dretnar.com"
        ];

        // LOAD MUTE STATE FROM LOCAL STORAGE
        let isMuted = localStorage.getItem('vraj_mute_state') === 'true';
        let isMusicPlaying = false;
        
        function playSfx() { if(isMuted) return; clickSound.currentTime = 0; clickSound.play().catch(()=>{}); }
        function playAchSfx() { if(isMuted) return; achievementSound.currentTime = 0; achievementSound.play().catch(()=>{}); }

        // FORCE MUSIC START LOGIC (REFRESH PROOF)
        if(!isMuted) {
            const tryPlay = () => {
                bgm.play().then(() => {
                    isMusicPlaying = true;
                    updateMusicUI();
                }).catch(() => {
                    // Autoplay blocked. Wait for interaction.
                    const unlockAudio = () => {
                        bgm.play().then(() => {
                            isMusicPlaying = true;
                            updateMusicUI();
                            // Remove listeners once successful
                            document.removeEventListener('click', unlockAudio);
                            document.removeEventListener('touchstart', unlockAudio);
                            document.removeEventListener('keydown', unlockAudio);
                        });
                    };
                    document.addEventListener('click', unlockAudio);
                    document.addEventListener('touchstart', unlockAudio);
                    document.addEventListener('keydown', unlockAudio);
                });
            };
            tryPlay();
        }

        function updateMusicUI() {
            document.getElementById('music-toggle-btn').style.opacity = isMuted ? '0.5' : '1';
            document.getElementById('global-mute-btn').innerText = isMuted ? 'üîá' : 'üîä';
        }
        updateMusicUI();

        window.toggleMute = () => {
            isMuted = !isMuted;
            localStorage.setItem('vraj_mute_state', isMuted);
            updateMusicUI();
            if(isMuted) { bgm.pause(); isMusicPlaying = false; }
            else { bgm.play().catch(()=>{}); isMusicPlaying = true; }
        };

        window.toggleMusic = () => {
            if(isMusicPlaying) {
                bgm.pause(); isMusicPlaying = false; isMuted = true;
            } else {
                bgm.play().catch(()=>{}); isMusicPlaying = true; isMuted = false;
            }
            localStorage.setItem('vraj_mute_state', isMuted);
            updateMusicUI();
        };

        // --- UPDATED NUMBER FORMATTING ---
        const suffixes = [
            "", "K", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "Dc", 
            "Ud", "Dd", "Td", "Qad", "Qid", "Sd", "Spd", "Od", "Nd", "Vg", 
            "Uvg", "Dvg", "Tvg", "Qavg", "Qivg", "Svg", "Spvg", "Ovg", "Nvg", "Tg",
            "Utg", "Dtg", "Ttg", "Qatg", "Qitg", "Stg", "Sptg", "Otg", "Ntg", "Qg",
            "Uqg", "Dqg", "Tqg", "Qaqg", "Qiqg", "Sqg", "Spqg", "Oqg", "Nqg"
        ];

        function formatNumber(num) {
            if (num === undefined || num === null) return "0";
            if (num < 1000) { 
                return Number.isInteger(num) ? num.toString() : num.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 });
            }
            
            // Log10 of number to determine tier
            const tier = Math.floor(Math.log10(num) / 3);
            
            if (tier === 0) return Math.floor(num).toLocaleString();
            
            // Get suffix
            const suffix = suffixes[tier];
            
            // Scale the number
            const scale = Math.pow(10, tier * 3);
            const scaled = num / scale;
            
            // If suffix exists, return it
            if (suffix !== undefined) {
                return scaled.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " " + suffix;
            } else {
                // Fallback to Scientific for massive numbers > Nqg (1e153)
                return num.toExponential(2).replace('+', '');
            }
        }

        // --- GALAXY 3D ENGINE ---
        let galaxyScene, galaxyCamera, galaxyRenderer, worldGroup, galaxyActive = false;
        function initGalaxy() {
            if (galaxyRenderer) return;
            const canvas = document.getElementById('galaxy-canvas');
            galaxyScene = new THREE.Scene();
            galaxyCamera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 2000);
            galaxyCamera.position.set(0, 18, 90);
            galaxyRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: false, powerPreference: "high-performance", alpha: true });
            galaxyRenderer.setSize(window.innerWidth, window.innerHeight);
            galaxyRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            worldGroup = new THREE.Group(); worldGroup.position.y = 8; galaxyScene.add(worldGroup);
            const vShader = `attribute float size; varying vec3 vColor; void main() { vColor = color; vec4 mvPosition = modelViewMatrix * vec4(position, 1.0); gl_PointSize = size * (250.0 / -mvPosition.z); gl_Position = projectionMatrix * mvPosition; }`;
            const fShader = `varying vec3 vColor; void main() { float d = distance(gl_PointCoord, vec2(0.5)); if (d > 0.5) discard; float strength = pow(1.0 - d * 2.1, 2.5); gl_FragColor = vec4(vColor, strength * 0.9); }`;
            const count = 150000; const geo = new THREE.BufferGeometry(); const pos = new Float32Array(count * 3), cols = new Float32Array(count * 3), sizes = new Float32Array(count); const cIn = new THREE.Color('#ffe1b0'), cOut = new THREE.Color('#3366ff');
            for (let i = 0; i < count; i++) { const i3 = i * 3, r = Math.random() * 75, bAngle = (i % 2) * Math.PI, spin = r * 0.22; const rX = Math.pow(Math.random(), 3) * (Math.random() < 0.5 ? 1 : -1) * 4, rY = Math.pow(Math.random(), 3) * (Math.random() < 0.5 ? 1 : -1) * 2, rZ = Math.pow(Math.random(), 3) * (Math.random() < 0.5 ? 1 : -1) * 4; pos[i3] = Math.cos(bAngle + spin) * r + rX; pos[i3+1] = rY; pos[i3+2] = Math.sin(bAngle + spin) * r + rZ; const mixed = cIn.clone().lerp(cOut, r/75); cols[i3] = mixed.r; cols[i3+1] = mixed.g; cols[i3+2] = mixed.b; sizes[i] = Math.random() * 1.2 + 0.3; }
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3)); geo.setAttribute('color', new THREE.BufferAttribute(cols, 3)); geo.setAttribute('size', new THREE.BufferAttribute(sizes, 1)); worldGroup.add(new THREE.Points(geo, new THREE.ShaderMaterial({ vertexShader: vShader, fragmentShader: fShader, transparent: true, blending: THREE.AdditiveBlending, depthWrite: false, vertexColors: true })));
            window.addEventListener('resize', () => { galaxyCamera.aspect = window.innerWidth / window.innerHeight; galaxyCamera.updateProjectionMatrix(); galaxyRenderer.setSize(window.innerWidth, window.innerHeight); });
        }
        function animateGalaxy() { if (!galaxyActive) return; requestAnimationFrame(animateGalaxy); worldGroup.rotation.y += 0.0015; galaxyRenderer.render(galaxyScene, galaxyCamera); }
        initGalaxy();

        window.showAlert = (title, content, onConfirm = null, isConfirm = false, isReset = false) => {
            const modal = document.getElementById('game-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerHTML = content;
            modal.classList.remove('hidden');
            document.getElementById('modal-cancel').classList.toggle('hidden', !isConfirm);
            document.getElementById('modal-input-container').classList.toggle('hidden', !isReset);
            if(isReset) document.getElementById('modal-text-input').value = "";
            document.getElementById('modal-cancel').onclick = () => modal.classList.add('hidden');
            document.getElementById('modal-confirm').onclick = () => { if(isReset) { if(document.getElementById('modal-text-input').value === currentUsername) { modal.classList.add('hidden'); if(onConfirm) onConfirm(); } else { alert("Incorrect."); } } else { modal.classList.add('hidden'); if(onConfirm) onConfirm(); } };
        };

        let score = 0, vps = 0, ppc = 1, bulkAmount = 1, currentShopTab = 'clicker', currentStyleTab = 'themes';
        let totalVrajs = 0, totalClicks = 0, totalUpgrades = 0, settingsClicked = 0, goldenVrajsCaught = 0, chatsSent = 0, timePlayed = 0, totalCrits = 0;
        let goldenMultiplier = 1, multTimeRemaining = 0;
        let prestigeCount = 0, fatflaps = 0, ownedPrestigeUpgrades = [], ascensionUnlocked = false;
        // UPDATED: Added variable to track spent total Vrajs for Ascension logic
        let prestigeCostDeduction = 0; 
        
        let currentUser = null, currentUsername = "Guest", activeTheme = 'classic', activeNametag = 'classic';
        let clickIntervals = [], lastClickTime = Date.now(), hasWarned = false;
        let savedTime = 0, sessionStartTime = Date.now(), isDev = false, isTester = false; 
        let equippedStyles = new Set();
        let isTop10 = false;
        let leaderboardRank = 9999;
        let achievementPercent = 0;
        let clickTimestamps = []; // New tracker for CPS achievements

        // --- NOTIFICATIONS & STATE ---
        let hasNewAch = false;
        let hasNewShop = false;
        let hasNewStyle = false;

        // --- AUTO CLICKER DETECTION SYSTEM ---
        let cheatStrikes = 0;
        let isInputBlocked = false;
        let clickHistory = [];
        const HISTORY_SIZE = 64; 
        
        let mouseDownTime = 0;

        function detectAutoClicker(e) {
            const now = Date.now();
            // 1. Input Data Collection
            const x = e.clientX || 0;
            const y = e.clientY || 0;
            
            clickHistory.push({ t: now, x: x, y: y });
            if (clickHistory.length > HISTORY_SIZE) clickHistory.shift();
            
            // Need full buffer to analyze trends
            if (clickHistory.length < HISTORY_SIZE) return false;

            // Extract Intervals
            const intervals = [];
            for (let i = 1; i < clickHistory.length; i++) {
                intervals.push(clickHistory[i].t - clickHistory[i-1].t);
            }

            // --- LAYER 1: BASIC STATISTICS ---
            const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
            const cps = 1000 / avgInterval;
            
            // Safety: Humans can click slowly without triggering anything.
            if (cps < 6) return false; 
            
            // Hard Cap (Machine Gun): > 30 CPS sustained
            if (cps > 30) return true;

            // Standard Deviation (Consistency)
            const variance = intervals.reduce((a, b) => a + Math.pow(b - avgInterval, 2), 0) / intervals.length;
            const stdDev = Math.sqrt(variance);

            // --- LAYER 2: ROBOTIC CONSISTENCY ---
            // Humans typically have >15ms jitter even when trying to be consistent.
            // Macro recorders (even with small delays) often have <5ms jitter or exactly 0.
            if (stdDev < 5) return true;

            // --- LAYER 3: HESITATION DETECTION ---
            // Humans pause or stutter. The gap between the fastest and slowest click is significant.
            // Bots often have a "flat" distribution.
            const minInt = Math.min(...intervals);
            const maxInt = Math.max(...intervals);
            
            // "Flat" Distribution Check:
            // If the difference between slowest and fastest click is tiny (<20ms) at high speeds
            if (cps > 10 && (maxInt - minInt) < 20) return true;

            // --- LAYER 4: LONG-TERM VARIANCE & FATIGUE ---
            // Humans drift. They speed up and slow down (Fatigue).
            // Split history in two halves.
            const mid = Math.floor(intervals.length / 2);
            const firstHalfAvg = intervals.slice(0, mid).reduce((a,b)=>a+b,0) / mid;
            const secondHalfAvg = intervals.slice(mid).reduce((a,b)=>a+b,0) / (intervals.length - mid);
            
            const drift = Math.abs(firstHalfAvg - secondHalfAvg);
            
            // If clicking fast (>12 CPS) and average speed drifted less than 0.5ms over ~60 clicks
            // That is statistically impossible for a human finger.
            // Note: We check stdDev > 10 to ensure we catch "random offset" bots that are artificially high variance
            // but average out perfectly over time.
            if (cps > 12 && drift < 0.5 && stdDev > 10) return true;

            // --- LAYER 5: CURSOR CORRELATION (Entropy Check) ---
            // Check if cursor moves. Laptop users might be still, but rarely PIXEL perfect for 64 clicks.
            // However, we only flag if they are ALSO clicking suspiciously fast/consistent.
            let spatialDist = 0;
            for(let i=1; i<clickHistory.length; i++) {
                spatialDist += Math.abs(clickHistory[i].x - clickHistory[i-1].x) + Math.abs(clickHistory[i].y - clickHistory[i-1].y);
            }
            
            // If perfectly still (0 movement) AND extremely consistent (stdDev < 12)
            // (Standard human consistent is ~20-30ms. <12ms is pro/bot territory. Still mouse + <12ms = Bot)
            if (spatialDist === 0 && stdDev < 12) return true;

            return false;
        }

        function triggerCheatStrike() {
            if(isInputBlocked) return;
            isInputBlocked = true;
            cheatStrikes++;
            
            sirenSound.currentTime = 0;
            sirenSound.play().catch(() => {}); // Plays Siren

            document.getElementById('strike-count').innerText = cheatStrikes;
            document.getElementById('cheat-warning').classList.remove('hidden');
            
            if(cheatStrikes >= 2) {
                setTimeout(() => { signOut(auth).then(() => location.reload()); }, 3000);
            } else {
                startWarningCooldown();
            }
        }

        function startWarningCooldown() {
            const btn = document.getElementById('cheat-btn');
            btn.disabled = true;
            let count = 3;
            btn.innerHTML = `WAIT (${count})`;
            
            const timer = setInterval(() => {
                count--;
                if(count <= 0) {
                    clearInterval(timer);
                    btn.disabled = false;
                    btn.innerHTML = "I UNDERSTAND";
                    sirenSound.pause(); // Stop siren when they can click
                    sirenSound.currentTime = 0;
                } else {
                    btn.innerHTML = `WAIT (${count})`;
                }
            }, 1000);
        }

        window.acknowledgeStrike = () => {
            if(cheatStrikes >= 2) return; 
            isInputBlocked = false;
            clickHistory = [];
            document.getElementById('cheat-warning').classList.add('hidden');
        };

        // --- PET DATA SYSTEM & DRAG STATE ---
        let petsState = {}; 
        let selectedPetId = null, dragTargetId = null, dragStartPos = { x: 0, y: 0 }, isDragActive = false, dragOffset = { x: 0, y: 0 };
        let cachedElements = null;
        function getCachedElements() { if (!cachedElements) { cachedElements = { score: document.getElementById('score'), vpsDisplay: document.getElementById('vps-display'), ppcDisplay: document.getElementById('ppc-display'), iconMultDisplay: document.getElementById('icon-mult-display'), fatflapDisplay: document.getElementById('fatflap-display'), fatflapCount: document.getElementById('fatflap-count'), tabPrestige: document.getElementById('tab-prestige') }; } return cachedElements; }

        const upgradeData = [
            { name: "Vraj Finger", baseCost: 50, basePower: 0.2, emoji: "‚òùÔ∏è" }, 
            { name: "Vraj Sprout", baseCost: 150, basePower: 1, emoji: "üå±" }, // 300 -> 150
            { name: "Vraj Nanobots", baseCost: 2000, basePower: 4, emoji: "ü§è" }, 
            { name: "Vraj Cursor", baseCost: 3750, basePower: 15, emoji: "üñ±Ô∏è" }, // 7500 -> 3750
            { name: "Vraj Magnet", baseCost: 30000, basePower: 50, emoji: "üß≤" }, 
            { name: "Vraj Drone", baseCost: 100000, basePower: 200, emoji: "üöÅ" }, // 200000 -> 100000
            { name: "Vraj Keyboard", baseCost: 1000000, basePower: 750, emoji: "‚å®Ô∏è" }, 
            { name: "Vraj Coffee", baseCost: 3000000, basePower: 3000, emoji: "‚òï" }, // 6000000 -> 3000000
            { name: "Vraj Juice", baseCost: 35000000, basePower: 12000, emoji: "üßÉ" }, 
            { name: "Vraj Potion", baseCost: 100000000, basePower: 50000, emoji: "üß™" }, // 200000000 -> 100000000
            { name: "Vraj Botnet", baseCost: 800000000, basePower: 180000, emoji: "üåê" }, 
            { name: "Vraj Garden", baseCost: 2250000000, basePower: 800000, emoji: "üåø" }, // 4.5b -> 2.25b
            { name: "Vraj Tuner", baseCost: 25000000000, basePower: 3500000, emoji: "üéöÔ∏è" }, 
            { name: "Vraj Typist", baseCost: 60000000000, basePower: 15000000, emoji: "üíª" }, // 120b -> 60b
            { name: "Vraj Automaton", baseCost: 720000000000, basePower: 70000000, emoji: "ü§ñ" }, 
            { name: "Vraj Smoothie", baseCost: 1800000000000, basePower: 300000000, emoji: "ü•§" }, // 3.6t -> 1.8t
            { name: "Vraj Console", baseCost: 22500000000000, basePower: 1200000000, emoji: "üïπÔ∏è" }, 
            { name: "Vraj Lab", baseCost: 60000000000000, basePower: 5000000000, emoji: "‚öóÔ∏è" }, // 120t -> 60t
            { name: "Vraj Brewery", baseCost: 720000000000000, basePower: 20000000000, emoji: "üç∫" }, 
            { name: "Vraj Workshop", baseCost: 2.0e+15, basePower: 80000000000, emoji: "üõ†Ô∏è" }, // 4e15 -> 2e15
            { name: "Vraj Network", baseCost: 2.0e+16, basePower: 350000000000, emoji: "üì°" }, 
            { name: "Vraj Reactor", baseCost: 5.5e+16, basePower: 1.5e12, emoji: "‚öõÔ∏è" }, // 1.1e17 -> 5.5e16
            { name: "Vraj Meadow", baseCost: 6.2e+17, basePower: 6e12, emoji: "üåæ" }, 
            { name: "Vraj Terminal", baseCost: 1.5e+18, basePower: 2.5e13, emoji: "üñ•Ô∏è" }, // 3.0e18 -> 1.5e18
            { name: "Vraj Hive", baseCost: 1.7e+19, basePower: 1e14, emoji: "üêú" }, 
            { name: "Vraj Factory", baseCost: 4.5e+19, basePower: 4.5e14, emoji: "üè≠" }, // 9e19 -> 4.5e19
            { name: "Vraj Collider", baseCost: 4.8e+20, basePower: 2e15, emoji: "üî¨" }, 
            { name: "Vraj Extract", baseCost: 1.4e+21, basePower: 9e15, emoji: "üßâ" }, // 2.8e21 -> 1.4e21
            { name: "Vraj Deck", baseCost: 1.5e+22, basePower: 4e16, emoji: "üéÆ" }, 
            { name: "Vraj Assembly", baseCost: 4.0e+22, basePower: 1.8e17, emoji: "ü§ù" }, // 8.0e22 -> 4.0e22
            { name: "Vraj Mainframe", baseCost: 4.5e+23, basePower: 8e17, emoji: "üíΩ" }, 
            { name: "Vraj Singularity", baseCost: 1.25e+24, basePower: 3.5e18, emoji: "üåÄ" }, // 2.5e24 -> 1.25e24
            { name: "Vraj Forest", baseCost: 1.4e+25, basePower: 1.5e19, emoji: "üå≤" }, 
            { name: "Vraj Supercomp", baseCost: 3.0e+25, basePower: 6e19, emoji: "üíæ" }, // 6.0e25 -> 3.0e25
            { name: "Vraj Colony", baseCost: 3.5e+26, basePower: 2.5e20, emoji: "üêú" }, 
            { name: "Vraj Megaplant", baseCost: 1.0e+27, basePower: 1e21, emoji: "üèóÔ∏è" }, // 2.0e27 -> 1.0e27
            { name: "Vraj Accelerator", baseCost: 1.1e+28, basePower: 4.5e21, emoji: "üöÄ" }, 
            { name: "Vraj Serum", baseCost: 3.0e+28, basePower: 2e22, emoji: "üíâ" }, // 6.0e28 -> 3.0e28
            { name: "Vraj Interface", baseCost: 3.6e+29, basePower: 9e22, emoji: "üß©" }, 
            { name: "Vraj Genome", baseCost: 1.05e+30, basePower: 4e23, emoji: "üß¨" }, // 2.1e30 -> 1.05e30
            { name: "Vraj Roast", baseCost: 1.1e+31, basePower: 1.8e24, emoji: "üå∞" }, 
            { name: "Vraj Forge", baseCost: 3.15e+32, basePower: 8e24, emoji: "üóúÔ∏è" }, // 6.3e31 -> 3.15e31
            { name: "Vraj Datasphere", baseCost: 1.5e32, basePower: 3.5e25, emoji: "üåê" }
        ];

        const prestigeTreeData = [];
        const addNode = (id, name, cost, desc, emoji, parent, type, boost = 0, effect = null) => { prestigeTreeData.push({ id, name, cost, desc, emoji, parent, type, boost, effect }); };

        addNode('origin', 'The Big Bang', 1, 'Where it all begins. Unlocks the potential.', 'üåå', null, 'root', 0.1);
        addNode('mute_upg', 'Divine Silence', 49999995, 'Unlocks a Mute Button.', 'üîá', 'origin', 'special', 0, 'mute_unlock');
        addNode('c1', 'Iron Finger', 5, '+20% Click Power', 'üëÜ', 'origin', 'click', 0.2); addNode('crit1', 'Precision Strike', 25, 'Unlock Critical Hits (10% Chance, 5x Dmg)', 'üéØ', 'c1', 'click', 0, 'crit_unlock'); addNode('crit2', 'Lethal Tempo', 125, 'Crit Multiplier +50%', '‚öîÔ∏è', 'crit1', 'click', 0, 'crit_dmg'); addNode('crit3', 'Eagle Eye', 750, 'Crit Chance +5%', 'üëÅÔ∏è', 'crit2', 'click', 0, 'crit_chance'); addNode('crit4', 'Devastation', 4000, 'Crit Multiplier x2', 'ü©∏', 'crit3', 'click', 0, 'crit_mult_2');
        addNode('pow1', 'Titanium Mouse', 37, '+50% Click Power', 'üñ±Ô∏è', 'c1', 'click', 0.5); addNode('pow2', 'Cybernetic Joints', 187, '+100% Click Power', 'ü¶æ', 'pow1', 'click', 1.0); addNode('pow3', 'Plasma Clicks', 1200, '+200% Click Power', '‚ö°', 'pow2', 'click', 2.0); addNode('pow4', 'God Finger', 10000, '+500% Click Power', 'üå©Ô∏è', 'pow3', 'click', 5.0);
        addNode('p1', 'Auto Alignment', 5, '+20% VPS', '‚öôÔ∏è', 'origin', 'passive', 0.2); addNode('syn1', 'Building Synergy', 25, '+1% VPS per Building Owned', 'üèóÔ∏è', 'p1', 'passive', 0, 'syn_build'); addNode('syn2', 'Network Effect', 150, '+10% VPS', 'üåê', 'syn1', 'passive', 0.1); addNode('syn3', 'Hive Mind', 900, '+50% VPS', 'üß†', 'syn2', 'passive', 0.5);
        addNode('off1', 'Time Bank', 37, 'Gain 50% production while offline', '‚è≥', 'p1', 'passive', 0, 'offline_50'); addNode('off2', 'Temporal Shift', 300, 'Offline Cap increased to 24h', 'üï∞Ô∏è', 'off1', 'passive', 0, 'offline_24h');
        addNode('g1', 'Shiny Sight', 12, 'Golden Vrajs spawn 2x as often', '‚ú®', 'origin', 'golden', 0, 'spawn_2x'); addNode('g2', 'Midas Touch', 62, 'Golden Vrajs give 3x Multiplier', 'üëë', 'g1', 'golden', 0, 'mult_3x'); addNode('g3', 'Treasure Hunter', 300, 'Golden Vrajs last 5s longer', 'üíé', 'g2', 'golden', 0, 'dur_5s'); addNode('g4', 'Leprechaun Blood', 1500, 'Golden Vrajs give 5x Multiplier', 'üçÄ', 'g3', 'golden', 0, 'mult_5x');
        addNode('u1', 'Haggler', 25, 'Shop prices -5%', 'üè∑Ô∏è', 'origin', 'synergy', 0, 'disc_5'); addNode('u2', 'Trophy Hunter', 125, '+20% Multiplier per Achievement', 'üèÜ', 'u1', 'synergy', 0, 'ach_scale'); addNode('u4', 'Black Hole Market', 4000, 'Shop prices -10%', 'üï≥Ô∏è', 'u2', 'synergy', 0, 'disc_10');
        addNode('pet1', 'Mysterious Egg', 1500, 'Unlocks a companion...', 'ü•ö', 'origin', 'pet', 0, 'pet_egg'); addNode('pet2', 'Hatchling', 6000, 'The egg cracks! (+2x Passive)', 'üê£', 'pet1', 'pet', 1.0, 'pet_hatch'); addNode('pet7', 'Time Dragon', 20000, 'Golden Vrajs last +30s', 'üêâ', 'pet2', 'pet', 0, 'pet_dragon'); addNode('pet4', 'Void Wisp', 50000, 'Click Power increases with AFK time', 'üëª', 'pet7', 'pet', 0, 'pet_void'); addNode('pet5', 'Cosmic Slime', 125000, 'Passive generation +10x', 'üü£', 'pet4', 'pet', 9.0, 'pet_slime'); addNode('pet6', 'Mecha Vraj', 375000, 'Click Power +5x', 'ü§ñ', 'pet5', 'pet', 4.0, 'pet_mech'); addNode('pet3', 'Golden Guardian', 750000, 'Auto-clicks Golden Vrajs!', 'üëº', 'pet6', 'pet', 0, 'pet_gold');
        
        addNode('c_combo1', 'Combo Starter', 900, 'Click Power +20%', 'ü•ä', 'c1', 'click', 0.2); addNode('c_combo2', 'Rhythm Strike', 2400, 'Click Power +30%', 'üéµ', 'c_combo1', 'click', 0.3); addNode('c_combo3', 'Flow State', 10000, 'Click Power +50%', 'üåä', 'c_combo2', 'click', 0.5); addNode('c_hyper', 'Hyper Clicks', 30000, 'Click Power +100%', '‚è©', 'c_combo3', 'click', 1.0); addNode('c_titan', 'Titan Grip', 125000, 'Click Power +200%', '‚úä', 'c_hyper', 'click', 2.0); addNode('crit_fatal', 'Fatal Wounds', 8000, 'Crit Multiplier +2.5x', 'üíî', 'crit2', 'click', 0, 'crit_dmg_2'); addNode('crit_bounty', 'Headhunter', 20000, 'Crit Chance +5%', 'üíÄ', 'crit3', 'click', 0, 'crit_chance_2'); addNode('crit_execute', 'Executioner', 75000, 'Crit Multiplier +5x', 'ü™ì', 'crit_fatal', 'click', 0, 'crit_dmg_3'); addNode('c_frenzy', 'Click Frenzy', 500000, 'Click Power +300%', 'ü§¨', 'c_titan', 'click', 3.0); addNode('c_godhand', 'Hand of God', 25000000, 'Click Power +1000%', '‚úã', 'c_frenzy', 'click', 10.0);
        addNode('p_factory', 'Factory Overclock', 1500, 'Passive Gen +20%', 'üè≠', 'p1', 'passive', 0.2); addNode('p_quantum', 'Quantum Computing', 6000, 'Passive Gen +30%', '‚öõÔ∏è', 'p_factory', 'passive', 0.3); addNode('p_ai', 'AI Management', 20000, 'Passive Gen +50%', 'ü§ñ', 'p_quantum', 'passive', 0.5); addNode('p_fusion', 'Cold Fusion', 75000, 'Passive Gen +100%', 'üîã', 'p_ai', 'passive', 1.0); addNode('p_dyson', 'Dyson Sphere', 250000, 'Passive Gen +200%', 'üåû', 'p_fusion', 'passive', 2.0); addNode('off_cryo', 'Cryo Sleep', 8000, 'Offline Time Cap +2h', '‚ùÑÔ∏è', 'off2', 'passive', 0, 'off_cap_2'); addNode('off_sim', 'Neural Sim', 32000, 'Offline Rate +20%', 'üß†', 'off_cryo', 'passive', 0, 'off_rate'); addNode('p_invest', 'Compound Interest', 750000, 'Passive Gen +150%', 'üìà', 'p_dyson', 'passive', 1.5); addNode('p_market', 'Stock Market', 5000000, 'Passive Gen +250%', 'üìâ', 'p_invest', 'passive', 2.5); addNode('p_printing', 'Money Printer', 50000000, 'Passive Gen +500%', 'üñ®Ô∏è', 'p_market', 'passive', 5.0);
        addNode('g_clover', 'Four Leaf Clover', 600, 'Spawn Rate +10%', 'üçÄ', 'g1', 'golden', 0, 'spawn_10'); addNode('g_dice', 'Loaded Dice', 4000, 'Spawn Rate +15%', 'üé≤', 'g_clover', 'golden', 0, 'spawn_15'); addNode('g_charm', 'Lucky Charm', 20000, 'Spawn Rate +20%', 'üßø', 'g_dice', 'golden', 0, 'spawn_20'); addNode('g_coin', 'Golden Coin', 75000, 'Golden Multiplier +1x', 'ü™ô', 'g2', 'golden', 0, 'mult_1'); addNode('g_bar', 'Golden Bar', 200000, 'Golden Multiplier +2x', 'üç´', 'g_coin', 'golden', 0, 'mult_2'); addNode('g_vault', 'Golden Vault', 10000, 'Duration +5s', 'üè¶', 'g3', 'golden', 0, 'dur_5'); addNode('g_time', 'Time Dilation', 50000, 'Duration +10s', '‚åõ', 'g_vault', 'golden', 0, 'dur_10'); addNode('g_greed', 'Greed is Good', 1000000, 'Golden Multiplier +5x', 'ü§ë', 'g_bar', 'golden', 0, 'mult_5'); addNode('g_alchemy', 'Alchemy', 2500000, 'Spawn Rate +25%', '‚öóÔ∏è', 'g_charm', 'golden', 0, 'spawn_25'); addNode('g_midas2', 'True Midas', 25000000, 'Golden Multiplier +10x', 'ü§¥', 'g_greed', 'golden', 0, 'mult_10');
        addNode('u_tax', 'Tax Evasion', 20000, 'Shop Prices -5%', 'üèÉ', 'u1', 'synergy', 0, 'disc_5_2'); addNode('u_lobby', 'Lobbying', 100000, 'Shop Prices -5%', 'ü§ù', 'u_tax', 'synergy', 0, 'disc_5_3'); addNode('u_monopoly', 'Monopoly', 500000, 'Shop Prices -10%', 'üé©', 'u_lobby', 'synergy', 0, 'disc_10_2'); addNode('syn_fat1', 'Fatflap Power', 10000, 'Global Multiplier +10%', 'ü•û', 'syn3', 'synergy', 0.1); addNode('syn_fat2', 'Fatflap Mastery', 50000, 'Global Multiplier +20%', 'üë®‚Äçüç≥', 'syn_fat1', 'synergy', 0.2); addNode('syn_asc1', 'Ascension Power', 250000, 'Global Multiplier +25%', 'üÜô', 'syn_fat2', 'synergy', 0.25); addNode('syn_pure', 'Pure Energy', 750000, 'Global Multiplier +50%', '‚ú®', 'syn_asc1', 'synergy', 0.5); addNode('syn_void', 'Void Energy', 2500000, 'Global Multiplier +100%', '‚ö´', 'syn_pure', 'synergy', 1.0); addNode('u_bulk2', 'Wholesale', 10000000, 'Shop Prices -5%', 'üì¶', 'u_monopoly', 'synergy', 0, 'disc_5_4');
        addNode('el_fire', 'Fire Essence', 150000, 'Click Power +50%', 'üî•', 'c_hyper', 'click', 0.5); addNode('el_water', 'Water Essence', 150000, 'Passive Gen +50%', 'üíß', 'p_fusion', 'passive', 0.5); addNode('el_earth', 'Earth Essence', 150000, 'Shop Prices -5%', 'ü™®', 'u_lobby', 'synergy', 0, 'disc_5_5'); addNode('el_air', 'Air Essence', 150000, 'Crit Chance +5%', 'üí®', 'crit_bounty', 'click', 0, 'crit_chance_3'); addNode('el_light', 'Light Essence', 150000, 'Golden Spawn +10%', 'üïØÔ∏è', 'g_charm', 'golden', 0, 'spawn_10_2'); addNode('el_dark', 'Dark Essence', 375000, 'Global Multiplier +20%', 'üåë', 'syn_asc1', 'synergy', 0.2); addNode('spec_one', 'The One', 50000000, 'Global Multiplier +200%', 'üï∂Ô∏è', 'syn_void', 'synergy', 2.0); addNode('spec_neo', 'Matrix Code', 125000000, 'Passive Gen +300%', 'üü©', 'p_printing', 'passive', 3.0); addNode('spec_trinity', 'Holy Trinity', 125000000, 'Click Power +300%', '‚úùÔ∏è', 'c_godhand', 'click', 3.0); addNode('spec_omega', 'Omega Point', 500000000, 'Global Multiplier +500%', 'Œ©', 'spec_one', 'synergy', 5.0);

        // --- UPDATED ACHIEVEMENT GENERATION ---
        const achievements = [];
        const createAch = (id, title, desc, type, target, extra = {}) => achievements.push({ id, title, desc, type, target, unlocked: false, ...extra });

        const clickTitles = [
            "Finger Twitch", "Button Masher", "Mouse Warmer", "Carpal Tunnel", "Rapid Fire", 
            "Machine Gun", "Sonic Boom", "Light Speed", "Warp Drive", "Hyperspace",
            "Time Bender", "Reality Breaker", "Finger of Steel", "Titanium Click", "Diamond Touch",
            "Star Crusher", "Black Hole Poker", "Dimension Poker", "God's Finger", "The One",
            "Keyboard Destroyer", "Mouse Obliterator", "Clicking Legend", "Mythical Tapper", "Cosmic Clicker",
            "Universal Prodder", "Multiversal Touch", "Omnipotent Finger", "The Final Click", "Infinity Tapper"
        ];
        // Updated Clicks Curve: Max 400k
        let cAcc = 100; 
        for(let i=0; i<30; i++) { 
            let target = Math.min(400000, Math.floor(cAcc));
            createAch(`click-${i}`, clickTitles[i] || `Click God ${i+1}`, `Click ${formatNumber(target)} times.`, 'clicks', target, {cat: 'click'}); 
            cAcc *= 1.8;
            if(target >= 400000) break; 
        }

        const vrajTitles = [
            "Pocket Change", "Piggy Bank", "Allowance", "Payday", "Wallet Full",
            "Mattress Stuffer", "Bank Account", "Investor", "Day Trader", "Market Mover",
            "CEO", "Tycoon", "Magnate", "Baron", "Oligarch",
            "Monopoly", "Money Printer", "Treasury", "National Debt", "Global Economy",
            "Planet Buyer", "Solar System Owner", "Galactic Emperor", "Universal Banker", "Multiverse Funder",
            "Reality Owner", "Vraj Millionaire", "Vraj Billionaire", "Vraj Trillionaire", "Vraj Quadrillionaire",
            "Vraj Quintillionaire", "Vraj Sextillionaire", "Vraj Septillionaire", "Vraj Octillionaire", "Vraj Nonillionaire",
            "Vraj Decillionaire", "Vraj Undecillionaire", "Vraj Duodecillionaire", "Vraj Tredecillionaire", "Vraj Quattuordecillionaire",
            "Matter Owner", "Energy Owner", "Time Owner", "Space Owner", "Concept Owner",
            "Void Filler", "Abyss Owner", "Existence Buyer", "The Vraj Singularity", "Vraj God"
        ];
        // Updated Vraj Curve: Max 5e50
        let vAcc = 1000; 
        for(let i=0; i<50; i++) { 
             let target = vAcc;
             if (target > 5e50) target = 5e50;
             createAch(`total-${i}`, vrajTitles[i] || `Vraj Lord ${i+1}`, `Earn ${formatNumber(target)} Total Vrajs.`, 'totalVrajs', target, {cat: 'eco'}); 
             vAcc *= 10;
             if(target >= 5e50) break;
        }

        const vpsTitles = [
            "Trickle", "Flow", "Stream", "River", "Waterfall",
            "Flood", "Tsunami", "Ocean", "Planetary Flow", "Stellar Ejection",
            "Supernova Output", "Black Hole Accretion", "Quasar Beam", "Gamma Burst", "Big Bang Echo",
            "Reality Leak", "Dimensional Torrent", "Timeline Flood", "Entropy Reversal", "Perpetual Motion",
            "Infinite Power", "Unstoppable", "Overwhelming", "Catastrophic Production", "Apocalyptic Yield",
            "Divine Creation", "Cosmic Fabrication", "Universal Assembly", "Multiversal Factory", "The Source"
        ];
        // Updated VPS Curve: Max 1e30
        let vpsAcc = 100;
        for(let i=0; i<30; i++) {
            let target = vpsAcc;
            if (target > 1e30) target = 1e30;
            createAch(`vps-${i}`, vpsTitles[i] || `Generator ${i+1}`, `Reach ${formatNumber(target)} VPS.`, 'vps', target, {cat: 'eco'});
            vpsAcc *= 15;
            if(target >= 1e30) break;
        }

        const playTitles = ["Newbie", "Casual", "Regular", "Dedicated", "Addict", "No Life", "Time Lord", "Chronos", "Eternal", "Timeless"];
        [5, 15, 30, 60, 120, 240, 360, 480, 600, 900].forEach((m, i) => createAch(`play-${m}`, playTitles[i] || `Player ${i+1}`, `Play for ${m} minutes.`, 'timePlayed', m, {cat: 'misc'}));

        const goldTitles = ["Lucky", "Clover Finder", "Leprechaun", "Pot of Gold", "Midas Touch", "Golden Goose", "Treasure Hunter", "Gold Rush", "El Dorado", "King Solomon", "Dragon Hoard", "Golden God", "Aurum Rex", "Shiny Master", "The Alchemist"];
        // Updated Golden Curve: Max 1000
        let gAcc = 5; 
        for(let i=0; i<15; i++) { 
            let target = Math.min(1000, Math.floor(gAcc));
            createAch(`gold-${i}`, goldTitles[i] || `Lucky ${i}`, `Catch ${target} Golden Vrajs.`, 'golden', target, {cat: 'eco'}); 
            gAcc *= 2;
            if(target >= 1000) break;
        }

        const chatTitles = ["Hello World", "Talkative", "Spammer", "Town Crier", "Orator", "Bard", "Voice of Reason", "Shoutmaster", "Megaphone", "Telepath"];
        // Updated Chat Curve: Max 1000
        [1, 10, 25, 50, 100, 200, 300, 500, 750, 1000].forEach((c, i) => createAch(`chat-${c}`, chatTitles[i], `Send ${c} chat messages.`, 'chat', c, {cat: 'misc'}));

        const ascTitles = ["Reborn", "Awakened", "Enlightened", "Ascended", "Phoenix", "Celestial", "Divine", "Transcendent", "Omniscient", "Higher Being", "Dimensional Walker", "Plane Shifter", "Reality Weaver", "Time Traveler", "The Alpha"];
        // Updated Ascension Curve: Max 5,000,000
        let pAcc = 1; 
        for(let i=0; i<15; i++) { 
            let target = Math.min(5000000, Math.floor(pAcc));
            createAch(`asc-${i}`, ascTitles[i], `Ascend ${target.toLocaleString()} times.`, 'prestige', target, {cat: 'asc'}); 
            pAcc *= 5; 
            if(target >= 5000000) break;
        }

        const critTitles = ["Ouch!", "Critical Hit", "Bullseye", "Deadshot", "Sniper", "Assassin", "Executioner", "Devastator", "Annihilator", "One Hit Kill"];
        // Updated Crit Curve: Max 100,000
        let critAcc = 10;
        for(let i=0; i<10; i++) {
             let target = Math.min(100000, Math.floor(critAcc));
             createAch(`crit-${i}`, critTitles[i] || `Critter ${i+1}`, `Land ${target.toLocaleString()} Critical Hits.`, 'crit', target, {cat: 'click'});
             critAcc *= 4;
             if(target >= 100000) break;
        }

        createAch('cps-7', 'Fast Fingers', 'Reach 7 clicks per second.', 'cps', 7, {cat: 'click'});
        createAch('cps-10', 'Blurry Fingers', 'Reach 10 clicks per second.', 'cps', 10, {cat: 'click'});
        createAch('cps-12', 'Light Speed', 'Reach 12 clicks per second.', 'cps', 12, {cat: 'click'});

        createAch('lb-top-5', 'Climbing High', 'Reach Rank 5 on the Leaderboard.', 'lbTop5', 1, {cat: 'misc'});
        createAch('lb-top-3', 'Podium Finish', 'Reach Rank 3 on the Leaderboard.', 'lbTop3', 1, {cat: 'misc'});
        createAch('lb-top-1', 'The Very Best', 'Reach Rank 1 on the Leaderboard.', 'lbTop1', 1, {cat: 'misc'});

        ['pet1','pet2','pet3','pet4','pet5','pet6','pet7'].forEach(pid => { 
            const pName = prestigeTreeData.find(n=>n.id===pid).name;
            createAch(`pet-max-${pid}`, `Max ${pName}`, `Level this pet to max.`, 'petMax', pid, {cat: 'pet'}); 
        });
        createAch('pet-all-max', 'Beast Master', 'Get ALL pets to max level.', 'petAllMax', 1, {cat: 'pet'});
        createAch('pet-all-sit', 'Classroom', 'Make ALL pets sit at once.', 'petMode', 'sit', {cat: 'pet'});
        createAch('pet-all-roam', 'Zoo Break', 'Make ALL pets roam at once.', 'petMode', 'roam', {cat: 'pet'});
        createAch('pet-5', 'Trainer', 'Upgrade any pet to Level 5.', 'petLevel', 5, {cat: 'pet'});
        createAch('style-all', 'Fashionista', 'Equip all 15 themes at least once.', 'styleAll', 15, {cat: 'misc'});
        createAch('leaderboard-10', 'Elite 10', 'Reach Top 10 on Leaderboard.', 'lbTop10', 1, {cat: 'misc'});
        createAch('tree-20', 'Expanding Mind', 'Buy 20 Ascension Upgrades.', 'treeCount', 20, {cat: 'asc'});
        createAch('tree-all', 'Omnipotent', 'Buy ALL Ascension Upgrades.', 'treeAll', 1, {cat: 'asc'});
        
        upgradeData.forEach((u, i) => { createAch(`buy-${i+1}-100`, `${u.name} Master`, `Buy 100 ${u.name}s.`, 'upgradeCount', 100, { upgIdx: i, cat: 'shop' }); });
        createAch('buy-all-100', 'Completionist', 'Buy 100 of EVERY shop upgrade.', 'upgradeAllCount', 100, {cat: 'shop'});

        const upgrades = upgradeData.map((u, i) => ({ id: i+1, ...u, owned: 0, cost: u.baseCost, isClickUpgrade: (i+1)%2!==0 }));
        
        const themes = [
            { id: 'classic', name: 'Classic Dark', emoji: 'üåë', req: 0 },
            { id: 'light', name: 'Clean Light', emoji: '‚òÄÔ∏è', req: 0 },
            { id: 'midnight', name: 'Midnight Deep', emoji: 'üåå', req: 5 },
            { id: 'pink', name: 'Rose Petal', emoji: 'üå∏', req: 10 },
            { id: 'yellow', name: 'Golden', emoji: 'üü°', req: 15 },
            { id: 'orange', name: 'Sunset', emoji: 'üü†', req: 20 },
            { id: 'green', name: 'Emerald', emoji: 'üü¢', req: 25 },
            { id: 'blue', name: 'Oceanic Blue', emoji: 'üîµ', req: 30 },
            { id: 'purple', name: 'Royal', emoji: 'üü£', req: 35 },
            { id: 'red', name: 'Crimson', emoji: 'üî¥', req: 45 },
            { id: 'snowy', name: 'Snowy Peak', emoji: '‚ùÑÔ∏è', req: 50 },
            { id: 'nature', name: 'Nature Forest', emoji: 'üåø', req: 60 },
            { id: 'sea', name: 'Deep Sea', emoji: 'üåä', req: 70 },
            { id: 'starry', name: 'Starry Sky', emoji: '‚ú®', req: 80 },
            { id: 'milkyway', name: 'Milky Way', emoji: 'üåå', req: 90 }
        ].sort((a,b) => a.req - b.req);

        const nameTagsData = [
            { id: 'classic', name: 'Classic', class: 'nametag-classic', emoji: 'üë§', req: 0 },
            { id: 'ghost', name: 'Phantom', class: 'nametag-ghost', emoji: 'üëª', req: 10 },
            { id: 'matrix', name: 'Hacker', class: 'nametag-matrix', emoji: 'üíª', req: 20 },
            { id: 'ice', name: 'Frost', class: 'nametag-ice', emoji: 'üßä', req: 30 },
            { id: 'fire', name: 'Inferno', class: 'nametag-fire', emoji: 'üî•', req: 40 },
            { id: 'gold', name: 'Midas', class: 'nametag-gold', emoji: 'üèÜ', req: 50 },
            { id: 'electric', name: 'Spark', class: 'nametag-electric', emoji: '‚ö°', req: 60 },
            { id: 'royal', name: 'Royal', class: 'nametag-royal', emoji: 'üëë', req: 70 },
            { id: 'shadow', name: 'Void', class: 'nametag-shadow', emoji: '‚ö´', req: 80 },
            { id: 'galaxy', name: 'Galaxy', class: 'nametag-galaxy', emoji: 'üåå', req: 90 }
        ].sort((a,b) => a.req - b.req);

        function calculateMultipliers() {
            let clickPct = 100, passivePct = 100, globalMult = 1 + (fatflaps * 0.5);
            prestigeTreeData.filter(u => ownedPrestigeUpgrades.includes(u.id)).forEach(u => { if(['root','synergy','golden','special'].includes(u.type) && u.boost) globalMult += u.boost; });
            let treeClick = 0, treePassive = 0;
            prestigeTreeData.filter(u => ownedPrestigeUpgrades.includes(u.id)).forEach(u => {
                if(u.type === 'click' && u.boost) treeClick += u.boost;
                if(u.type === 'passive' && u.boost) treePassive += u.boost;
                if(u.type === 'pet') {
                     let mult = 1;
                     if(petsState[u.id]) mult = 1 + ((petsState[u.id].level - 1) * 0.1); 
                     if(u.boost) {
                         if(u.id === 'pet5') treePassive += (u.boost * mult);
                         else if(u.id === 'pet6') treeClick += (u.boost * mult);
                         else if(u.id === 'pet2') treePassive += (u.boost * mult);
                     }
                     if(u.id === 'pet4') {
                         const now = Date.now(), diffMs = now - lastClickTime, diffMins = Math.max(0, diffMs / 60000);
                         const wispBonus = (0.02 * mult) * diffMins; 
                         treeClick += Math.min(wispBonus, (0.02 * mult * 1440));
                     }
                }
            });
            clickPct = (1 + treeClick) * globalMult * 100; passivePct = (1 + treePassive) * globalMult * 100;
            if(hasTree('crit_mult_2')) clickPct *= 2; 
            return { click: clickPct, passive: passivePct };
        }

        function getTotalMultiplier() {
            // UPDATED: Halved ascension multiplier from 0.5 to 0.25 per level
            let mult = 1 + (prestigeCount * 0.25);
            prestigeTreeData.filter(u => ownedPrestigeUpgrades.includes(u.id)).forEach(u => { if(u.boost) mult += u.boost; });
            if(hasTree('u2')) { const achCount = achievements.filter(a => a.unlocked).length; mult += (achCount * 0.20); }
            return mult;
        }
        
        function hasTree(id) { return ownedPrestigeUpgrades.includes(id); }

        window.switchSideTab = (tab) => {
            document.querySelectorAll('.left-panel-content').forEach(p => { p.classList.add('hidden'); p.classList.remove('warp-transition'); });
            document.querySelectorAll('.side-tab').forEach(t => t.classList.remove('active'));
            const target = document.getElementById('panel-'+tab); target.classList.remove('hidden'); void target.offsetWidth; target.classList.add('warp-transition');
            document.getElementById('tab-'+tab).classList.add('active');
            
            if(tab === 'achievements') renderAchievements(); if(tab === 'stats') updateStatsUI();
            if(tab === 'prestige') renderPrestigeShop(); if(tab === 'style') renderStylePanel();
        };
        
        setInterval(() => { const statsPanel = document.getElementById('panel-stats'); if(statsPanel && !statsPanel.classList.contains('hidden')) { updateStatsUI(); } }, 1000);

        window.setBulk = (amt) => { bulkAmount = amt; document.querySelectorAll('.bulk-btn').forEach(b => b.classList.remove('active')); document.getElementById('bulk-'+amt).classList.add('active'); updateUI(); };
        window.setShopTab = (tab) => { currentShopTab = tab; document.querySelectorAll('.shop-tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('shop-tab-'+tab).classList.add('active'); renderShop(); updateUI(); };
        window.setStyleTab = (tab) => { currentStyleTab = tab; document.querySelectorAll('.style-tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('style-tab-'+tab).classList.add('active'); renderStylePanel(); };

        function getBulkCost(baseCost, count) { 
            let total = 0; let temp = baseCost; 
            let discount = 1.0;
            if (hasTree('u1')) discount *= 0.95; if (hasTree('u_tax')) discount *= 0.95; if (hasTree('u_lobby')) discount *= 0.95; if (hasTree('el_earth')) discount *= 0.95; if (hasTree('u_bulk2')) discount *= 0.95; if (hasTree('u4')) discount *= 0.90; if (hasTree('u_monopoly')) discount *= 0.90;
            for(let i=0; i<count; i++) { total += Math.floor(temp * discount); temp = Math.ceil(temp * 1.15); } 
            return total; 
        }

        window.buyUpgrade = (id) => {
            const upg = upgrades.find(u => u.id === id);
            const cost = getBulkCost(upg.cost, bulkAmount);
            if (score >= cost) {
                score -= cost;
                if (upg.isClickUpgrade) ppc += (upg.basePower * bulkAmount); else vps += (upg.basePower * bulkAmount);
                upg.owned += bulkAmount; totalUpgrades += bulkAmount;
                for(let i=0; i<bulkAmount; i++) upg.cost = Math.ceil(upg.cost * 1.15);
                updateUI(); playSfx(); checkAchievements();
            }
        };

        window.clickVraj = (e) => {
            if(e.type === 'mousedown') {
                mouseDownTime = Date.now();
                return;
            }
            // Removed clickHoldTimes push for better mobile compatibility

            if(isInputBlocked) return;
            // UPDATED: Pass the event to the new detector
            if(detectAutoClicker(e)) {
                triggerCheatStrike();
                return;
            }

            const now = Date.now();
            
            // CPS Calculation
            clickTimestamps.push(now);
            clickTimestamps = clickTimestamps.filter(t => now - t < 1000);

            lastClickTime = now; totalClicks++;
            let mult = getTotalMultiplier(); let isCrit = false;
            let critChance = 0.1; if (hasTree('crit3')) critChance += 0.05; if (hasTree('crit_bounty')) critChance += 0.05; if (hasTree('el_air')) critChance += 0.05;
            if(hasTree('crit1') && Math.random() < critChance) {
                let critMult = 5; if(hasTree('crit2')) critMult += 2.5; if(hasTree('crit_fatal')) critMult += 2.5; if(hasTree('crit_execute')) critMult += 5.0; 
                if(hasTree('crit4')) critMult *= 2;
                mult *= critMult; isCrit = true; totalCrits++;
            }
            const gain = ppc * mult * goldenMultiplier; score += gain; totalVrajs += gain; playSfx(); updateUI(); checkAchievements();
            const text = document.createElement('div'); text.className = 'float-text'; 
            text.innerText = (isCrit ? 'CRIT! +' : '+') + formatNumber(gain);
            if(isCrit) { text.style.color = '#ef4444'; text.style.fontSize = '3rem'; }
            const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            text.style.left = (clientX - 10) + 'px'; text.style.top = (clientY - 20) + 'px';
            document.body.appendChild(text); setTimeout(() => text.remove(), 3000); 
        };

        const clickerContainer = document.getElementById('clicker-container');
        clickerContainer.addEventListener('mousedown', window.clickVraj);
        // Fixed: Use mouseup listener correctly instead of onclick
        clickerContainer.addEventListener('mouseup', window.clickVraj);

        function getPrestigeData() {
            // UPDATED: Use totalVrajs minus already spent value to prevent infinite prestige loops
            let tempScore = totalVrajs - prestigeCostDeduction;
            if (tempScore < 0) tempScore = 0;

            let tempPrestige = prestigeCount; 
            let levelsToGain = 0;
            let totalCostSpent = 0;
            
            // Updated: Removed the loop cap as requested.
            // This loop calculates gain based on lifetime Vrajs minus previously spent Vrajs.
            while(true) {
                let linear = 1000000 * (tempPrestige + 1); 
                let expBase = 1.0002; // Base < 20k
                
                if (tempPrestige >= 550000) {
                    expBase = 1.000008;
                } else if (tempPrestige >= 150000) {
                    expBase = 1.00005;
                } else if (tempPrestige >= 20000) {
                    expBase = 1.00008;
                }

                let exponential = Math.pow(expBase, tempPrestige);
                let cost = linear * exponential;
                
                if (tempScore >= cost) { 
                    tempScore -= cost; 
                    totalCostSpent += cost;
                    tempPrestige++; 
                    levelsToGain++; 
                } 
                else { 
                    return { 
                        gain: levelsToGain, 
                        nextCost: cost, 
                        percent: Math.min((tempScore / cost) * 100, 100), 
                        spent: totalCostSpent 
                    }; 
                }
            }
        }

        window.openPrestigeModal = () => {
            const pData = getPrestigeData();
            if (pData.gain === 0) return;
            // UPDATED: Text reflects 25% boost now
            window.showAlert("Ascend to the Heavens?", `You are about to gain <span class="text-purple-400 font-bold">${pData.gain.toLocaleString()} Fatflap(s)</span>.<br><br>Each Ascension gives a <b>25% permanent boost</b>.<br><br>Ascending will <b>RESET</b> all your Vrajs and standard Upgrades.`, () => handlePrestige(), true);
        };

        window.handlePrestige = () => {
            const pData = getPrestigeData();
            if (pData.gain > 0) {
                fatflaps += pData.gain; 
                prestigeCount += pData.gain;
                
                // UPDATED: Track spent Vrajs so you can't re-spend them
                prestigeCostDeduction += pData.spent;

                score = 0; vps = 0; ppc = 1;
                upgrades.forEach((u, i) => {
                    u.owned = 0; u.cost = u.baseCost;
                    if (ownedPrestigeUpgrades.includes("p3") && i === 0) {
                        u.owned = 50; for(let k=0; k<50; k++) u.cost = Math.ceil(u.cost * 1.15);
                        vps += (u.basePower * 50);
                    }
                });
                const tree = document.getElementById('ascension-tree-view');
                const game = document.getElementById('game-screen');
                game.classList.add('screen-falling');
                setTimeout(() => { tree.classList.add('active'); renderAscensionTree(); }, 1000);
                updateUI(); renderPrestigeShop(); renderShop(); checkAchievements();
            }
        };
        
        window.reincarnate = () => {
            const tree = document.getElementById('ascension-tree-view');
            const game = document.getElementById('game-screen');
            tree.classList.remove('active');
            game.classList.remove('screen-falling');
            checkPets();
            setTimeout(() => { updateUI(); renderShop(); }, 500);
        };
        
        function checkPets() {
            const container = document.getElementById('pet-container');
            const petNodes = prestigeTreeData.filter(n => n.type === 'pet' && ownedPrestigeUpgrades.includes(n.id));
            petNodes.forEach(node => {
                if (node.id === 'pet1' && ownedPrestigeUpgrades.includes('pet2')) return;
                if(!petsState[node.id]) { petsState[node.id] = { id: node.id, name: node.name, level: 1, mode: 'sit', x: 20 + Math.random()*60, y: 20 + Math.random()*60 }; }
                let el = document.getElementById(`pet-${node.id}`);
                if(!el) {
                    el = document.createElement('div'); el.id = `pet-${node.id}`; el.innerText = node.emoji;
                    let anim = 'anim-float';
                    if(node.id === 'pet1') anim = 'anim-bounce'; if(node.id === 'pet3') anim = 'anim-float-fast'; if(node.id === 'pet4') anim = 'anim-pulse'; if(node.id === 'pet5') anim = 'anim-bounce'; if(node.id === 'pet6') anim = 'anim-shake'; if(node.id === 'pet7') anim = 'anim-float-fast';
                    el.className = `game-pet ${anim}`;
                    el.addEventListener('mousedown', (e) => { if (e.button !== 0) return; if(dragTargetId !== null && dragTargetId !== node.id) { dragTargetId = null; isDragActive = false; } dragTargetId = node.id; dragStartPos = { x: e.clientX, y: e.clientY }; isDragActive = false; const rect = el.getBoundingClientRect(); dragOffset = { x: e.clientX - rect.left, y: e.clientY - rect.top }; el.classList.remove('pet-smooth'); e.stopPropagation(); e.preventDefault(); });
                    container.appendChild(el);
                }
                el.style.left = petsState[node.id].x + '%'; el.style.top = petsState[node.id].y + '%';
                updatePetLabel(node.id);
            });
            if (ownedPrestigeUpgrades.includes('pet2')) { const eggEl = document.getElementById('pet-pet1'); if(eggEl) eggEl.remove(); }
        }

        function updatePetLabel(id) {
            const el = document.getElementById(`pet-${id}`); if(!el) return;
            let label = el.querySelector('.pet-label'); if(!label) { label = document.createElement('div'); label.className = 'pet-label'; el.appendChild(label); }
            const data = petsState[id]; const maxLevel = id === 'pet3' ? 1 : 10; const isMaxed = data.level >= maxLevel; const nameClass = isMaxed ? 'diamond-text' : 'text-white';
            label.innerHTML = `<span class="text-xs font-bold ${nameClass} shadow-black drop-shadow-md">${data.name}</span><br><span class="text-[8px] text-yellow-300 font-bold shadow-black drop-shadow-md">Lvl ${data.level}</span>`;
        }
        
        window.openPetMenu = (id) => {
            const menuModal = document.getElementById('pet-menu-modal');
            if(!menuModal.classList.contains('hidden') && selectedPetId !== id) { closePetMenu(); }
            dragTargetId = null; isDragActive = false; selectedPetId = id; const data = petsState[id]; const node = prestigeTreeData.find(n => n.id === id);
            document.getElementById('pm-emoji').innerText = node.emoji; document.getElementById('pm-name').value = data.name;
            updatePetMenuUI();
            document.getElementById('pm-name').onchange = (e) => { petsState[id].name = e.target.value; updatePetLabel(id); };
            menuModal.classList.remove('hidden'); repositionPetMenu();
        };

        window.closePetMenu = () => { const menuModal = document.getElementById('pet-menu-modal'); menuModal.classList.add('hidden'); selectedPetId = null; dragTargetId = null; isDragActive = false; dragStartPos = { x: 0, y: 0 }; dragOffset = { x: 0, y: 0 }; };
        
        function repositionPetMenu() {
            if(!selectedPetId) return;
            const menuEl = document.getElementById('pet-menu-modal'); const petEl = document.getElementById(`pet-${selectedPetId}`); if(!petEl || menuEl.classList.contains('hidden')) return;
            menuEl.classList.remove('menu-top', 'menu-bottom', 'menu-left', 'menu-right'); let arrowClass = 'menu-top'; 
            const rect = petEl.getBoundingClientRect(); const menuWidth = 240; const menuHeight = 180; const gap = 15;
            let top = rect.top - menuHeight - gap; let left = rect.left + (rect.width/2) - (menuWidth/2);
            if (top < 10) { top = rect.bottom + gap; arrowClass = 'menu-bottom'; } if(left < 10) { left = 10; } if(left + menuWidth > window.innerWidth) { left = window.innerWidth - menuWidth - 10; }
            menuEl.style.top = top + 'px'; menuEl.style.left = left + 'px'; menuEl.style.transform = 'none'; menuEl.classList.add(arrowClass);
        }
        
        window.addEventListener('mousedown', (e) => { const menu = document.getElementById('pet-menu-modal'); if(!menu.classList.contains('hidden') && !e.target.closest('#pet-menu-modal') && !e.target.closest('.game-pet')) { closePetMenu(); } });

        function updatePetMenuUI() {
            if(!selectedPetId) return;
            const data = petsState[selectedPetId]; const node = prestigeTreeData.find(n => n.id === selectedPetId);
            const modeBtn = document.getElementById('pm-mode-btn');
            modeBtn.innerText = data.mode === 'sit' ? 'SITTING' : 'ROAMING';
            modeBtn.className = data.mode === 'sit' ? 'text-[9px] font-bold text-gray-300' : 'text-[9px] font-bold text-blue-300';
            let desc = node.desc; let mult = 1 + ((data.level - 1) * 0.1); 
            if(node.id === 'pet5') desc = `Passive Gen +${(10 * mult).toFixed(1)}x`; else if(node.id === 'pet6') desc = `Click Power +${(5 * mult).toFixed(1)}x`; else if(node.id === 'pet7') desc = `Golden Vrajs +${(30 + (data.level-1)*2)}s`; else if(node.id === 'pet2') desc = `Passive Gen +${(2 * mult).toFixed(1)}x`; else if(node.id === 'pet1') desc = `Just an egg. Might hatch?`; else if(node.id === 'pet3') desc = `Auto-clicks Golden Vrajs!`; else if(node.id === 'pet4') desc = `Click Power +${(2 * data.level).toFixed(0)}% per min AFK`; else desc = node.desc + ` (Lvl Bonus: +${((mult-1)*100).toFixed(0)}%)`;
            document.getElementById('pm-effect').innerText = desc;
            const baseCost = node.cost * 10; const cost = Math.floor(baseCost * Math.pow(50, data.level)); 
            const btn = document.getElementById('pm-upgrade-btn'); const maxLevel = node.id === 'pet3' ? 1 : 10; const isMax = data.level >= maxLevel; const canUpgrade = ['pet2','pet4','pet5','pet6','pet7'].includes(node.id); 
            if(isMax) { btn.innerHTML = `<span class="text-xs">MAX LEVEL</span>`; btn.className = "w-full py-3 bg-gray-700 rounded-lg font-bold shadow-lg flex justify-center items-center opacity-50 cursor-not-allowed"; btn.onclick = null; } else if (!canUpgrade) { btn.innerHTML = `<span class="text-xs">MAX POWER</span>`; btn.className = "w-full py-3 bg-gray-700 rounded-lg font-bold shadow-lg flex justify-center items-center opacity-50 cursor-not-allowed"; btn.onclick = null; } else { btn.innerHTML = `<span class="text-xs">LEVEL UP</span><span class="text-[9px] bg-black/20 px-2 py-0.5 rounded text-emerald-100" id="pm-cost">${formatNumber(cost)} Vrajs</span>`; btn.className = "w-full py-3 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-lg font-bold shadow-lg flex justify-between px-3 items-center hover:scale-[1.02]"; btn.onclick = upgradePet; }
            document.getElementById('pm-level').innerText = `${data.level} / ${maxLevel}`;
        }

        window.togglePetMode = () => { if(!selectedPetId) return; petsState[selectedPetId].mode = petsState[selectedPetId].mode === 'sit' ? 'roam' : 'sit'; updatePetMenuUI(); checkAchievements(); };
        window.upgradePet = () => { if(!selectedPetId) return; const data = petsState[selectedPetId]; const node = prestigeTreeData.find(n => n.id === selectedPetId); const maxLevel = node.id === 'pet3' ? 1 : 10; if(data.level >= maxLevel) return; const baseCost = node.cost * 10; const cost = Math.floor(baseCost * Math.pow(50, data.level)); if(score >= cost) { score -= cost; data.level++; playSfx(); const btn = document.getElementById('pm-upgrade-btn'); btn.classList.add('flash-success'); setTimeout(() => btn.classList.remove('flash-success'), 100); updateUI(); updatePetMenuUI(); updatePetLabel(selectedPetId); checkAchievements(); } };

        window.addEventListener('mousemove', (e) => {
            if(dragTargetId) {
                const dist = Math.sqrt(Math.pow(e.clientX - dragStartPos.x, 2) + Math.pow(e.clientY - dragStartPos.y, 2)); if(dist > 5) isDragActive = true; 
                if(isDragActive) { const el = document.getElementById(`pet-${dragTargetId}`); const container = document.getElementById('pet-container'); const rect = container.getBoundingClientRect(); let rawX = e.clientX - rect.left - dragOffset.x; let rawY = e.clientY - rect.top - dragOffset.y; let x = (rawX / rect.width) * 100; let y = (rawY / rect.height) * 100; x = Math.max(0, Math.min(95, x)); y = Math.max(0, Math.min(95, y)); if(el) { el.style.left = x + '%'; el.style.top = y + '%'; petsState[dragTargetId].x = x; petsState[dragTargetId].y = y; if(selectedPetId === dragTargetId) { repositionPetMenu(); } } }
            }
        });

        window.addEventListener('mouseup', (e) => {
            if(dragTargetId) {
                const menuModal = document.getElementById('pet-menu-modal'); const isMenuOpen = !menuModal.classList.contains('hidden'); const isMenuForThisPet = selectedPetId === dragTargetId;
                if(!isDragActive) { if(isMenuOpen && isMenuForThisPet) { closePetMenu(); } else { openPetMenu(dragTargetId); } } else { if(petsState[dragTargetId].mode === 'roam') { const el = document.getElementById(`pet-${dragTargetId}`); if(el) el.classList.add('pet-smooth'); } }
                dragTargetId = null; isDragActive = false;
            }
        });
        window.addEventListener('mouseleave', () => { dragTargetId = null; isDragActive = false; });
        setInterval(() => { Object.keys(petsState).forEach(id => { const p = petsState[id]; if(p.mode === 'roam' && dragTargetId === null) { if(Math.random() < 0.3) { p.x = Math.random() * 90; p.y = Math.random() * 90; const el = document.getElementById(`pet-${id}`); if(el) { if(!el.classList.contains('pet-smooth')) el.classList.add('pet-smooth'); el.style.left = p.x + '%'; el.style.top = p.y + '%'; } } } }); }, 2000); 

        window.cheatAddVrajs = () => { const amt = parseInt(document.getElementById('cheat-amount').value) || 0; score += amt; updateUI(); renderShop(); checkAchievements(); };
        window.cheatAddFatflaps = () => { const amt = parseInt(document.getElementById('cheat-amount').value) || 0; fatflaps += amt; updateUI(); };
        window.triggerAccountReset = () => { window.showAlert("üíÄ EXTREME RESET", `This will delete ALL Vrajs, Upgrades, Fatflaps, and Achievements.<br><br>To confirm, type your username: <b class='text-red-400'>${currentUsername}</b>`, () => executeFullReset(), true, true); };
        async function executeFullReset() { if(currentUser && !currentUser.isAnonymous) { await deleteDoc(doc(db, "leaderboard", currentUser.uid)); } location.reload(); }

        // --- NEW ADMIN FUNCTIONS ---
        
        // Find user ID by username
        async function findUserByUsername(username) {
            const q = query(collection(db, "leaderboard"), where("username", "==", username), limit(1));
            const snapshot = await getDocs(q);
            if(snapshot.empty) return null;
            return snapshot.docs[0].id;
        }

        window.adminAction = async (action) => {
            if(!isDev) return;
            const targetName = document.getElementById('admin-target-user').value;
            if(!targetName) { alert("Please enter a username."); return; }
            
            const uid = await findUserByUsername(targetName);
            if(!uid) { alert("User not found."); return; }
            
            try {
                const userRef = doc(db, "leaderboard", uid);
                
                if(action === 'ban') {
                    await updateDoc(userRef, { banned: true });
                    alert(`Banned ${targetName}`);
                } else if(action === 'unban') {
                    await updateDoc(userRef, { banned: false });
                    alert(`Unbanned ${targetName}`);
                } else if(action === 'kick') {
                    await updateDoc(userRef, { forceKick: Date.now() });
                    alert(`Kicked ${targetName}`);
                } else if(action === 'reset_progress') {
                    // UPDATED: More Prominent Confirmation
                    if(confirm("‚ö† WARNING: ACCOUNT RESET INITIATED ‚ö†\n\nThis will completely wipe ALL Vrajs, Fatflaps, and Upgrades for " + targetName.toUpperCase() + ".\n\nARE YOU ABSOLUTELY SURE?")) {
                        await updateDoc(userRef, {
                            score: 0, vps: 0, ppc: 1, totalVrajs: 0, totalClicks: 0,
                            totalUpgrades: 0, goldenVrajsCaught: 0, prestigeCount: 0,
                            fatflaps: 0, ownedPrestigeUpgrades: [], 
                            upgStates: [], achStates: [], petsState: {}, equippedStyles: [],
                            forceRefresh: Date.now() 
                        });
                        alert(`Successfully Reset ${targetName}`);
                    }
                } else if(action === 'rename') {
                    const newName = document.getElementById('admin-new-username').value;
                    if(!newName) { alert("Enter a new username"); return; }
                    await updateDoc(userRef, { username: newName });
                    await updateDoc(doc(db, "users", uid), { username: newName });
                    alert(`Renamed to ${newName}`);
                }
            } catch(e) {
                alert("PERMISSION DENIED: Ensure your UID in the Firestore Rules exactly matches your current account UID.");
            }
        };

        window.adminTriggerPasswordReset = async () => {
            if(!isDev) return;
            const email = document.getElementById('admin-reset-email').value;
            if(!email) { alert("Please enter the target email."); return; }
            
            try {
                await sendPasswordResetEmail(auth, email);
                alert(`Password reset email sent to ${email}`);
            } catch(e) {
                alert("Error: " + e.message);
            }
        };

        window.adminSetStat = async () => {
             if(!isDev) return;
             const targetName = document.getElementById('admin-target-user').value;
             const statType = document.getElementById('admin-stat-type').value;
             const val = parseFloat(document.getElementById('admin-stat-val').value);
             
             if(!targetName || isNaN(val)) { alert("Invalid inputs."); return; }
             
             const uid = await findUserByUsername(targetName);
             if(!uid) { alert("User not found."); return; }
             
             try {
                 await updateDoc(doc(db, "leaderboard", uid), { [statType]: val });
                 alert(`Set ${statType} to ${val} for ${targetName}`);
             } catch(e) {
                 alert("PERMISSION DENIED: Ensure your UID in the Firestore Rules exactly matches your current account UID.");
             }
        };

        window.adminGlobalRefresh = async () => {
             if(!isDev) return;
             if(confirm("Are you sure you want to refresh EVERYONE'S browser tab?")) {
                 await setDoc(doc(db, "system", "global"), { forceRefreshAll: Date.now() }, { merge: true });
                 alert("Global refresh signal sent.");
             }
        };

        window.buyPrestigeUpgrade = (id) => {
            const upg = prestigeTreeData.find(u => u.id === id); const parentOwned = upg.parent === null || ownedPrestigeUpgrades.includes(upg.parent);
            if (fatflaps >= upg.cost && !ownedPrestigeUpgrades.includes(id) && parentOwned) { fatflaps -= upg.cost; ownedPrestigeUpgrades.push(id); renderPrestigeShop(); updateUI(); renderAscensionTree(); checkAchievements(); }
        };

        function renderPrestigeShop() {
            const list = document.getElementById('prestige-shop-list');
            list.innerHTML = prestigeTreeData.filter(u => ownedPrestigeUpgrades.includes(u.id)).map(u => { return `<div class="prestige-card glass p-4 flex justify-between items-center opacity-50"><div class="flex items-center gap-3"><span class="text-2xl">${u.emoji}</span><div><p class="font-bold text-sm text-purple-300">${u.name}</p><p class="text-[9px] opacity-60">${u.desc}</p></div></div><div class="text-right"><p class="text-xs font-bold text-yellow-500">OWNED</p></div></div>`; }).join('');
            if (list.innerHTML === '') list.innerHTML = '<p class="text-xs text-center opacity-50 py-4">No upgrades purchased yet. Ascend to access the Tree.</p>';
        }
        
        function renderAscensionTree() {
            const treeContent = document.getElementById('tree-container'); const linesSvg = document.getElementById('tree-lines'); document.getElementById('tree-fatflaps').innerText = fatflaps;
            const existingNodes = treeContent.querySelectorAll('.tree-node'); existingNodes.forEach(n => n.remove()); linesSvg.innerHTML = ''; 
            const centerX = window.innerWidth / 2; const centerY = window.innerHeight / 2; const positions = {};
            const placeNodes = (parentId, x, y, angleStart, angleRange) => {
                const children = prestigeTreeData.filter(n => n.parent === parentId); if (children.length === 0) return;
                const step = angleRange / children.length; let currentAngle = angleStart - (angleRange / 2) + (step / 2);
                children.forEach((child, index) => {
                    const dist = parentId === 'origin' ? 180 : 130; 
                    const nx = x + Math.cos(currentAngle) * dist; const ny = y + Math.sin(currentAngle) * dist; positions[child.id] = { x: nx, y: ny };
                    const parentIsOwned = parentId === 'origin' || ownedPrestigeUpgrades.includes(parentId);
                    if (parentIsOwned) { createNodeElement(child, nx, ny); drawLine(x, y, nx, ny, child); if (ownedPrestigeUpgrades.includes(child.id)) { placeNodes(child.id, nx, ny, currentAngle, Math.PI / 2.2); } }
                    currentAngle += step;
                });
            };
            const createNodeElement = (u, x, y) => {
                const node = document.createElement('div'); const isOwned = ownedPrestigeUpgrades.includes(u.id); const parentOwned = u.parent === null || ownedPrestigeUpgrades.includes(u.parent); const canAfford = fatflaps >= u.cost; const isLocked = !parentOwned;
                let stateClass = ''; if(isOwned) stateClass = 'owned'; else if(isLocked) stateClass = 'locked'; else if(canAfford) stateClass = 'available'; else stateClass = 'locked opacity-50';
                node.className = `tree-node type-${u.type} ${stateClass}`; node.style.left = `${x - 30}px`; node.style.top = `${y - 30}px`; node.innerText = u.emoji;
                if(!isOwned && !isLocked && canAfford) { node.onclick = () => buyPrestigeUpgrade(u.id); }
                node.onmousemove = (e) => { const tt = document.getElementById('tree-tooltip'); document.getElementById('tt-name').innerText = u.name; document.getElementById('tt-type').innerText = u.type.toUpperCase(); document.getElementById('tt-cost').innerText = isOwned ? "Owned" : `${u.cost} Fatflaps`; document.getElementById('tt-desc').innerText = u.desc; tt.style.display = 'block'; tt.style.left = `${e.clientX + 20}px`; tt.style.top = `${e.clientY + 20}px`; };
                node.onmouseleave = () => { document.getElementById('tree-tooltip').style.display = 'none'; };
                treeContent.appendChild(node);
            };
            const drawLine = (x1, y1, x2, y2, child) => { const line = document.createElementNS("http://www.w3.org/2000/svg", "line"); line.setAttribute("x1", x1); line.setAttribute("y1", y1); line.setAttribute("x2", x2); line.setAttribute("y2", y2); if (ownedPrestigeUpgrades.includes(child.id) || (ownedPrestigeUpgrades.includes(child.parent) && fatflaps >= child.cost)) { line.classList.add('active'); } linesSvg.appendChild(line); };
            const rootNode = prestigeTreeData.find(n => n.id === 'origin'); positions['origin'] = { x: centerX, y: centerY }; createNodeElement(rootNode, centerX, centerY); placeNodes('origin', centerX, centerY, Math.PI / 2, Math.PI * 2); 
        }

        window.setTheme = (theme) => {
            document.body.className = `select-none theme-${theme}`; activeTheme = theme;
            const canvas = document.getElementById('galaxy-canvas');
            if (theme === 'milkyway') { initGalaxy(); if(canvas) { canvas.classList.remove('hidden'); galaxyActive = true; animateGalaxy(); } } else { if(canvas) { canvas.classList.add('hidden'); galaxyActive = false; } }
            initThemeEffects(theme); renderStylePanel(); equippedStyles.add(theme); checkAchievements();
        };
        
        window.equipNametag = (id) => { activeNametag = id; renderStylePanel(); updateUI(); };

        function initThemeEffects(theme) {
            const container = document.getElementById('theme-overlay'); container.innerHTML = '';
            if(['nature', 'snowy', 'sea', 'starry', 'pink'].includes(theme)) {
                const count = theme === 'starry' ? 100 : 30;
                for(let i=0; i<count; i++) {
                    const p = document.createElement('div'); p.className = 'particle'; const left = Math.random() * 100; const delay = -(Math.random() * 15); p.style.left = left + '%'; p.style.animationDelay = delay + 's';
                    if(theme === 'nature' || theme === 'pink') { const types = theme === 'nature' ? ['üçÇ','üçÉ','üçÅ'] : ['üå∏']; p.innerText = types[Math.floor(Math.random()*types.length)]; p.className += ' nature-leaf'; p.style.fontSize = (Math.random() * 15 + 10) + 'px'; } else if(theme === 'snowy') { p.innerText = '‚ùÑÔ∏è'; p.className += ' snow-flake'; const s = Math.random() * 10 + 5; p.style.fontSize = s + 'px'; } else if(theme === 'sea') { p.innerText = 'ü´ß'; p.className += ' sea-bubble'; const s = Math.random() * 15 + 5; p.style.fontSize = s + 'px'; } else if(theme === 'starry') { p.className = 'star'; const s = Math.random() * 3 + 1; p.style.width = s + 'px'; p.style.height = s + 'px'; p.style.top = Math.random() * 100 + '%'; const roll = Math.random(); let color = roll < 0.75 ? '#ffffff' : (roll < 0.9 ? '#6366f1' : '#f87171'); p.style.backgroundColor = color; p.style.boxShadow = `0 0 ${s*4}px ${color}`; }
                    container.appendChild(p);
                }
            }
        }

        function renderStylePanel() {
            const list = document.getElementById('style-list');
            if (currentStyleTab === 'themes') {
                list.innerHTML = themes.map(t => {
                    const unlocked = achievementPercent >= t.req;
                    const active = activeTheme === t.id;
                    return `
                    <div onclick="${unlocked ? `setTheme('${t.id}')` : ''}" class="theme-card glass p-4 flex justify-between items-center ${active ? 'active' : ''} ${!unlocked ? 'opacity-50 cursor-not-allowed' : ''}">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${t.emoji}</span>
                            <div>
                                <p class="font-bold text-sm">${t.name}</p>
                                <p class="text-[9px] opacity-60">${unlocked ? 'Visual overhaul for the game.' : `<span class="text-red-400 font-bold">üîí Requires ${t.req}% Achievements</span>`}</p>
                            </div>
                        </div>
                        <span class="font-bold text-xs">${active ? 'EQUIPPED' : (unlocked ? 'EQUIP' : 'LOCKED')}</span>
                    </div>`;
                }).join('');
            } else if (currentStyleTab === 'names') {
                list.innerHTML = nameTagsData.map(n => {
                    const unlocked = achievementPercent >= n.req;
                    const active = activeNametag === n.id;
                    return `
                    <div onclick="${unlocked ? `equipNametag('${n.id}')` : ''}" class="nametag-card glass p-4 flex justify-between items-center ${active ? 'active' : ''} ${!unlocked ? 'opacity-50 cursor-not-allowed' : ''}">
                         <div class="flex items-center gap-3">
                            <span class="text-2xl">${n.emoji}</span>
                            <div>
                                <p class="font-bold text-lg ${n.class}">${n.name}</p>
                                <p class="text-[9px] opacity-60">${unlocked ? 'Chat Name Effect' : `<span class="text-red-400 font-bold">üîí Requires ${n.req}% Achievements</span>`}</p>
                            </div>
                        </div>
                        <span class="font-bold text-xs">${active ? 'EQUIPPED' : (unlocked ? 'EQUIP' : 'LOCKED')}</span>
                    </div>`;
                }).join('');
            } else { list.innerHTML = `<div class="p-8 text-center opacity-50 text-xs font-bold uppercase tracking-widest">Available in future updates</div>`; }
        }

        window.trackSettingClick = () => { settingsClicked++; };

        // --- ACHIEVEMENT LOGIC ---
        const achPopupQueue = [];
        let isPopupShowing = false;

        function checkAchievements() {
            // FIX: Don't check achievements if user is logged out
            if(!currentUser) return;

            let changed = false;
            // Get current CPS for achievement check
            const currentCPS = clickTimestamps.length;
            
            // Calculate total time played across all sessions
            const actualTotalMinutes = (savedTime + (Date.now() - sessionStartTime)) / 60000;

            achievements.forEach(ach => {
                if (ach.unlocked) return;
                let meets = false;
                if (ach.type === 'clicks' && totalClicks >= ach.target) meets = true;
                if (ach.type === 'totalVrajs' && totalVrajs >= ach.target) meets = true;
                if (ach.type === 'vps' && vps >= ach.target) meets = true;
                
                // FIXED TIME PLAYED CHECK
                if (ach.type === 'timePlayed' && actualTotalMinutes >= ach.target) meets = true; 
                
                if (ach.type === 'golden' && goldenVrajsCaught >= ach.target) meets = true;
                if (ach.type === 'chat' && chatsSent >= ach.target) meets = true;
                if (ach.type === 'prestige' && prestigeCount >= ach.target) meets = true;
                if (ach.type === 'crit' && totalCrits >= ach.target) meets = true;
                if (ach.type === 'cps' && currentCPS >= ach.target) meets = true;

                // Check Leaderboard Rank
                if (ach.type === 'lbTop10' && leaderboardRank <= 10) meets = true;
                if (ach.type === 'lbTop5' && leaderboardRank <= 5) meets = true;
                if (ach.type === 'lbTop3' && leaderboardRank <= 3) meets = true;
                if (ach.type === 'lbTop1' && leaderboardRank <= 1) meets = true;

                if (ach.type === 'petMax' && petsState[ach.target] && petsState[ach.target].level >= (ach.target==='pet3'?1:10)) meets = true;
                if (ach.type === 'petAllMax') {
                    const allPets = ['pet1','pet2','pet3','pet4','pet5','pet6','pet7'];
                    if(allPets.every(pid => petsState[pid] && petsState[pid].level >= (pid==='pet3'?1:10))) meets = true;
                }
                if (ach.type === 'petMode') {
                     const allPets = ['pet1','pet2','pet3','pet4','pet5','pet6','pet7'];
                     const activePets = allPets.filter(pid => petsState[pid]);
                     if(activePets.length > 0 && activePets.every(pid => petsState[pid].mode === ach.target)) meets = true;
                }
                if (ach.type === 'petLevel') {
                     if(Object.values(petsState).some(p => p.level >= ach.target)) meets = true;
                }
                if (ach.type === 'styleAll' && equippedStyles.size >= ach.target) meets = true;
                if (ach.type === 'treeCount' && ownedPrestigeUpgrades.length >= ach.target) meets = true;
                if (ach.type === 'treeAll' && ownedPrestigeUpgrades.length >= prestigeTreeData.length) meets = true;
                if (ach.type === 'upgradeCount' && upgrades[ach.upgIdx].owned >= ach.target) meets = true;
                if (ach.type === 'upgradeAllCount') {
                    if(upgrades.every(u => u.owned >= ach.target)) meets = true;
                }

                if (meets) { ach.unlocked = true; changed = true; queueAchievementPopup(ach); }
            });
            
            // Calculate Achievement Percent
            const completedCount = achievements.filter(a => a.unlocked).length;
            achievementPercent = Math.floor((completedCount / achievements.length) * 100);
            
            if(changed) {
                renderAchievements();
            }
        }

        function queueAchievementPopup(ach) {
            achPopupQueue.push(ach);
            processPopupQueue();
        }

        function processPopupQueue() {
            if(isPopupShowing || achPopupQueue.length === 0) return;
            isPopupShowing = true;
            const ach = achPopupQueue.shift();
            const popup = document.getElementById('achievement-popup');
            document.getElementById('ach-popup-title').innerText = ach.title;
            playAchSfx();
            popup.classList.add('show');
            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => { isPopupShowing = false; processPopupQueue(); }, 600);
            }, 3000);
        }

        function updateStatsUI() {
            const mults = calculateMultipliers();
            document.getElementById('stat-total-vrajs').innerText = formatNumber(Math.floor(totalVrajs));
            document.getElementById('stat-manual-clicks').innerText = totalClicks.toLocaleString();
            document.getElementById('stat-total-crits').innerText = totalCrits.toLocaleString();
            document.getElementById('stat-upgrades-bought').innerText = totalUpgrades.toLocaleString();
            document.getElementById('stat-golden-caught').innerText = goldenVrajsCaught.toLocaleString();
            document.getElementById('stat-prestige-count').innerText = prestigeCount.toLocaleString();
            document.getElementById('stat-mult-click').innerText = mults.click.toFixed(0) + "%";
            document.getElementById('stat-mult-passive').innerText = mults.passive.toFixed(0) + "%";
            
            const currentSessionTime = Date.now() - sessionStartTime;
            const totalMs = savedTime + currentSessionTime;
            const d = Math.floor(totalMs / 86400000); const h = Math.floor((totalMs % 86400000) / 3600000); const m = Math.floor((totalMs % 3600000) / 60000); const s = Math.floor((totalMs % 60000) / 1000);
            let timeStr = ''; if(d > 0) timeStr += `${d}d `; timeStr += `${h}h ${m}m ${s}s`;
            document.getElementById('stat-time-played').innerText = timeStr;
            document.getElementById('stat-chats-sent').innerText = chatsSent.toLocaleString();
        }

        function renderAchievements() {
            const list = document.getElementById('ach-list');
            const completed = achievements.filter(a => a.unlocked).length; const total = achievements.length;
            document.getElementById('ach-count').innerText = completed; document.getElementById('ach-total').innerText = total;
            document.getElementById('ach-progress-bar').style.width = `${(completed/total)*100}%`;
            
            const categories = {
                'click': 'Clicking & Combat',
                'eco': 'Economy & Wealth',
                'shop': 'Shop & Upgrades',
                'pet': 'Companions',
                'asc': 'Ascension & Beyond',
                'misc': 'Social & Misc'
            };

            let html = `<div class="p-4 mb-2 bg-gradient-to-r from-emerald-500/20 to-transparent border-l-4 border-emerald-500 rounded-r-xl">
                            <p class="font-black text-lg text-emerald-400 uppercase tracking-widest drop-shadow-md">Total Progress: ${achievementPercent}%</p>
                        </div>`;

            // Helper to get current progress value
            const getCurrentValue = (ach) => {
                if(ach.type === 'clicks') return totalClicks;
                if(ach.type === 'totalVrajs') return totalVrajs;
                if(ach.type === 'vps') return vps;
                if(ach.type === 'timePlayed') return (savedTime + (Date.now() - sessionStartTime)) / 60000;
                if(ach.type === 'golden') return goldenVrajsCaught;
                if(ach.type === 'chat') return chatsSent;
                if(ach.type === 'prestige') return prestigeCount;
                if(ach.type === 'crit') return totalCrits;
                if(ach.type === 'cps') return clickTimestamps.length;
                if(ach.type === 'upgradeCount') return upgrades[ach.upgIdx].owned;
                if(ach.type === 'treeCount') return ownedPrestigeUpgrades.length;
                return null;
            };

            for(const [key, name] of Object.entries(categories)) {
                const grp = achievements.filter(a => a.cat === key).sort((a,b) => (b.unlocked - a.unlocked));
                if(grp.length === 0) continue;
                html += `<div class="w-full p-2 mt-4 mb-2 bg-gradient-to-r from-emerald-900/50 to-transparent border-b border-emerald-500/30">
                            <p class="font-black text-xs uppercase tracking-widest text-emerald-400 drop-shadow-md">${name}</p>
                         </div>`;
                
                html += grp.map(ach => {
                    // UPDATED: Progress Bar Logic
                    let progressBarHTML = '';
                    if(!ach.unlocked) {
                        const val = getCurrentValue(ach);
                        if(val !== null && typeof ach.target === 'number') {
                            const pct = Math.min(100, Math.max(0, (val / ach.target) * 100));
                            // Only show bar if percent is meaningful (>1%)
                            if(pct > 0) {
                                progressBarHTML = `<div class="w-16 h-1.5 bg-black/50 rounded-full overflow-hidden ml-2 border border-white/5"><div class="h-full bg-emerald-500 transition-all duration-500" style="width:${pct}%"></div></div>`;
                            }
                        }
                    }

                    return `
                    <div class="ach-card glass p-3 flex items-center justify-between ${ach.unlocked ? 'unlocked' : 'locked'}">
                        <div class="flex-grow pr-2">
                            <div class="flex justify-between items-center mb-0.5">
                                <p class="text-xs font-bold">${ach.title}</p>
                                ${progressBarHTML}
                            </div>
                            <p class="text-[9px] opacity-60">${ach.desc}</p>
                        </div>
                        ${ach.unlocked ? '<span class="text-emerald-400">‚úÖ</span>' : '<span class="opacity-30">üîí</span>'}
                    </div>`;
                }).join('');
            }
            list.innerHTML = html;
        }

        function createPuff(x, y) {
            const puff = document.createElement('div');
            puff.className = 'puff-effect';
            puff.style.left = x + 'px';
            puff.style.top = y + 'px';
            document.body.appendChild(puff);
            setTimeout(() => puff.remove(), 400);
        }

        function spawnGoldenVraj() {
            if (document.querySelector('.golden-vraj')) return;
            const golden = document.createElement('img'); golden.src = 'image_0.png'; golden.className = 'golden-vraj';
            const caught = () => { 
                // Visual Effect
                const rect = golden.getBoundingClientRect();
                createPuff(rect.left + rect.width/2, rect.top + rect.height/2);
                
                goldenVrajsCaught++; 
                activateMultiplier(); 
                golden.remove(); 
                checkAchievements(); 
            };
            // UPDATED: Standard click handler
            golden.onclick = (e) => { e.stopPropagation(); caught(); };
            
            // UPDATED: Pet Logic calls caught() which includes Puff now
            if(hasTree('pet3')) { setTimeout(() => { if(golden.parentNode) caught(); }, 1000); }
            document.body.appendChild(golden); setTimeout(() => { if(golden.parentNode) golden.remove(); }, 10000);
        }

        function activateMultiplier() { 
            let mult = 2; // Default 2x from clicking it
            if(hasTree('g2')) mult += 1; if(hasTree('g_coin')) mult += 1; if(hasTree('g_bar')) mult += 2; if(hasTree('g_greed')) mult += 5; if(hasTree('g_midas2')) mult += 10;
            
            // UPDATED: Fixed Duration 3 mins, stacking with upgrades
            let duration = 180; 
            if(hasTree('g3')) duration += 5; if(hasTree('g_vault')) duration += 5; if(hasTree('g_time')) duration += 10; if(hasTree('pet7')) duration += (30 + ((petsState['pet7']?.level||1)-1)*2); 
            
            goldenMultiplier = mult; multTimeRemaining = duration; 
            document.getElementById('multiplier-value').innerText = mult + 'x'; 
            document.getElementById('multiplier-display').classList.remove('hidden'); updateUI(); 
        }

        setInterval(() => {
            timePlayed++;
            if (multTimeRemaining > 0) {
                multTimeRemaining--;
                const mins = Math.floor(multTimeRemaining / 60); const secs = multTimeRemaining % 60;
                document.getElementById('mult-timer').innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
                if (multTimeRemaining === 0) { goldenMultiplier = 1; document.getElementById('multiplier-display').classList.add('hidden'); updateUI(); }
            }
            let spawnChance = 0.005; if(hasTree('g1')) spawnChance += 0.005; if(hasTree('g_clover')) spawnChance += 0.001; if(hasTree('g_dice')) spawnChance += 0.0015; if(hasTree('g_charm')) spawnChance += 0.002; if(hasTree('g_alchemy')) spawnChance += 0.0025; if(hasTree('el_light')) spawnChance += 0.001;
            if (Math.random() < spawnChance) spawnGoldenVraj();
            const pData = getPrestigeData(); const bar = document.getElementById('prestige-bar');
            if(bar) {
                bar.style.width = pData.percent + '%'; document.getElementById('prestige-percent').innerText = Math.floor(pData.percent) + '%';
                document.getElementById('prestige-gain-display').innerText = `(+${pData.gain.toLocaleString()} Fatflaps)`; document.getElementById('prestige-btn').disabled = pData.gain === 0;
                document.getElementById('next-prestige-cost').innerText = formatNumber(pData.nextCost);
            }
            checkAchievements(); // Frequent check for time-based/passive achievements
        }, 1000);

        let currentVisibleLimit = 0; 
        function updateUI() {
            const cached = getCachedElements(); const totalMult = getTotalMultiplier();
            cached.score.innerText = formatNumber(Math.floor(score)) + " Vrajs";
            let currentVps = vps * totalMult; if(hasTree('p2a')) currentVps += (currentVps * (upgradesBoughtCount * 0.01)); 
            cached.vpsDisplay.innerText = formatNumber(currentVps) + " VPS"; 
            cached.ppcDisplay.innerText = formatNumber(ppc * totalMult) + " Vrajs Per Click"; 
            cached.iconMultDisplay.innerText = totalMult.toFixed(1) + "x";
            if (fatflaps > 0 || prestigeCount > 0) { cached.fatflapDisplay.classList.remove('hidden'); cached.fatflapCount.innerText = fatflaps.toLocaleString(); }
            if(totalVrajs >= 5000000 || ascensionUnlocked) { ascensionUnlocked = true; cached.tabPrestige.classList.remove('locked'); }

            const filtered = upgrades.filter(u => currentShopTab === 'clicker' ? u.isClickUpgrade : !u.isClickUpgrade);
            let showLimit = 0;
            for(let i = 0; i < filtered.length; i++) { showLimit = i; const u = filtered[i]; const cost = getBulkCost(u.cost, bulkAmount); if (u.owned > 0 || score >= cost) { continue; } else { break; } }
            
            if (showLimit > currentVisibleLimit) { renderShop(); } else { const visibleUpgrades = filtered.slice(0, currentVisibleLimit + 1); visibleUpgrades.forEach(u => { const el = document.getElementById(`upg-${u.id}`); if (el) { const bCost = getBulkCost(u.cost, bulkAmount); el.classList.toggle('disabled', score < bCost); document.getElementById(`cost-${u.id}`).innerText = formatNumber(bCost); document.getElementById(`owned-${u.id}`).innerText = u.owned.toLocaleString(); } }); }
            
            let displayHTML = currentUsername;
            if(activeNametag !== 'classic') { const tagData = nameTagsData.find(n => n.id === activeNametag); if(tagData) { displayHTML = `<span class="${tagData.class}">${currentUsername}</span>`; } }
            if(isDev) displayHTML = `<span class="dev-tag">[DEV]</span> ${displayHTML}`;
            // UPDATED: Tester Tag Logic for Main UI
            else if(isTester) displayHTML = `<span class="beta-tag text-blue-400">[BETA]</span> ${displayHTML}`;
            
            document.getElementById('user-display').innerHTML = displayHTML;
            if(hasTree('mute_upg')) { document.getElementById('global-mute-btn').classList.remove('hidden'); }
        }

        function renderShop() {
            const shop = document.getElementById('shop-list'); const filtered = upgrades.filter(u => currentShopTab === 'clicker' ? u.isClickUpgrade : !u.isClickUpgrade);
            let showLimit = 0; for(let i = 0; i < filtered.length; i++) { showLimit = i; const u = filtered[i]; const cost = getBulkCost(u.cost, bulkAmount); if (u.owned > 0 || score >= cost) { continue; } else { break; } }
            currentVisibleLimit = showLimit; const toShow = filtered.slice(0, showLimit + 1);
            shop.innerHTML = toShow.map(u => {
                const bCost = getBulkCost(u.cost, bulkAmount); const canAfford = score >= bCost;
                return ` <div id="upg-${u.id}" onclick="buyUpgrade(${u.id})" class="upgrade-card glass p-4 flex justify-between items-center ${canAfford ? '' : 'disabled'}"> <div class="flex items-center gap-3"> <span class="text-2xl">${u.emoji}</span> <div> <p class="font-bold text-sm">${u.name}</p> <p class="text-[10px] text-emerald-400">+${formatNumber(u.basePower)} ${u.isClickUpgrade?'PPC':'VPS'}</p> </div> </div> <div class="text-right"> <p class="text-xs font-bold opacity-80" id="cost-${u.id}">${formatNumber(u.cost)}</p> <p class="text-[9px] opacity-60">Owned: <span id="owned-${u.id}">${u.owned}</span></p> </div> </div>`;
            }).join('');
        }

        setInterval(() => { if (vps > 0) { score += (vps * getTotalMultiplier() * goldenMultiplier) / 10; totalVrajs += (vps * getTotalMultiplier() * goldenMultiplier) / 10; const cached = getCachedElements(); cached.score.innerText = formatNumber(Math.floor(score)) + " Vrajs"; } }, 100);
        setInterval(() => { if (vps > 0 || score > 0) { updateUI(); } }, 500);

        window.switchTab = (t) => { document.getElementById('login-form').classList.toggle('hidden', t !== 'login'); document.getElementById('signup-form').classList.toggle('hidden', t !== 'signup'); document.getElementById('tab-login').classList.toggle('bg-blue-600', t === 'login'); document.getElementById('tab-signup').classList.toggle('bg-blue-600', t === 'signup'); };
        window.handleSignup = async () => { const u = document.getElementById('su-username').value, e = document.getElementById('su-email').value, p = document.getElementById('su-password').value; try { const c = await createUserWithEmailAndPassword(auth, e, p); await setDoc(doc(db, "users", c.user.uid), { username: u }); await sendEmailVerification(c.user); /* REMOVED ALERT TO PREVENT DUPLICATE POPUP */ } catch (err) { window.showAlert("Error", err.message); } };
        window.handleLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('li-email').value, document.getElementById('li-password').value); } catch (err) { window.showAlert("Error", err.message); } };
        window.handleGuest = () => signInAnonymously(auth);
        window.logoutAction = () => window.showAlert("Logout", "Are you sure you want to sign out?", () => signOut(auth), true);

        // --- NEW FUNCTIONS FOR VERIFICATION SCREEN ---
        window.resendVerification = async () => {
             if(currentUser) {
                 const btn = document.getElementById('resend-btn');
                 try {
                     await sendEmailVerification(currentUser);
                     btn.innerText = "Sent!";
                     setTimeout(() => btn.innerText = "Resend Email", 5000);
                 } catch(e) { window.showAlert("Error", e.message); }
             }
        };

        window.backToLogin = async () => {
             await signOut(auth);
             location.reload();
        };

        // --- RESET LOCAL GAME STATE ---
        function resetLocalState() {
            score = 0; vps = 0; ppc = 1; totalVrajs = 0; totalClicks = 0; totalUpgrades = 0; goldenVrajsCaught = 0; 
            chatsSent = 0; timePlayed = 0; totalCrits = 0; prestigeCount = 0; fatflaps = 0;
            ownedPrestigeUpgrades = []; ascensionUnlocked = false; 
            // Reset Prestige Cost Tracker
            prestigeCostDeduction = 0;
            
            activeTheme = 'classic'; activeNametag = 'classic';
            petsState = {}; equippedStyles = new Set();
            upgrades.forEach(u => { u.owned = 0; u.cost = u.baseCost; });
            achievements.forEach(a => a.unlocked = false);
            
            // FIX: Clear Achievement Queue on logout
            achPopupQueue.length = 0;
            isPopupShowing = false;
            
            // IMMEDIATE UI RESET
            document.getElementById('score').innerText = '0 Vrajs';
            document.getElementById('vps-display').innerText = '0 VPS';
            document.getElementById('ppc-display').innerText = '1 Vrajs Per Click';
            document.getElementById('fatflap-count').innerText = '0';
            document.getElementById('fatflap-display').classList.add('hidden');
            document.getElementById('shop-list').innerHTML = '';
            document.getElementById('prestige-shop-list').innerHTML = '';
            document.getElementById('ach-list').innerHTML = '';
            document.getElementById('pet-container').innerHTML = ''; 
            
            setTheme('classic'); 
            bgm.pause(); bgm.currentTime = 0; isMusicPlaying = false; 
        }

        let kickCheckInterval = null;

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                if(!isMuted) { bgm.play().catch(()=>{}); isMusicPlaying = true; } // START MUSIC ON LOGIN

                // UPDATED: Permission Logic
                if (user.email === DEV_EMAIL) { 
                    isDev = true; 
                    document.getElementById('dev-menu-btn').classList.remove('hidden'); 
                }
                else if (TESTER_EMAILS.includes(user.email)) {
                    isTester = true;
                    // Note: Tester does NOT get Dev Menu
                }

                if (!user.isAnonymous && !user.emailVerified) { document.getElementById('verify-notice').classList.remove('hidden'); document.getElementById('login-form').classList.add('hidden'); document.getElementById('auth-tabs').classList.add('hidden'); } 
                else {
                    document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('game-screen').classList.remove('hidden');
                    if(user.isAnonymous) { currentUsername = "Guest_" + user.uid.substring(0,4); } 
                    else {
                        const snap = await getDoc(doc(db, "users", user.uid)); currentUsername = snap.exists() ? snap.data().username : "Vraj";
                        
                        // LISTEN FOR BAN/KICK SIGNALS
                        const userDocRef = doc(db, "leaderboard", user.uid);
                        onSnapshot(userDocRef, (s) => {
                            if(s.exists()) {
                                const d = s.data();
                                // Ban Logic
                                if(d.banned) {
                                    document.getElementById('game-screen').remove();
                                    document.getElementById('ban-screen').classList.remove('hidden');
                                    signOut(auth);
                                    return;
                                }
                                // Kick Logic (Check against session start)
                                if(d.forceKick && d.forceKick > sessionStartTime) {
                                    signOut(auth).then(() => location.reload());
                                    return;
                                }
                                // Refresh Logic
                                if(d.forceRefresh && d.forceRefresh > sessionStartTime) {
                                    location.reload();
                                    return;
                                }

                                // Update local stats
                                if(d.score !== undefined && d.score !== score) score = d.score;
                                if(d.fatflaps !== undefined && d.fatflaps !== fatflaps) fatflaps = d.fatflaps;
                                if(d.prestigeCount !== undefined && d.prestigeCount !== prestigeCount) prestigeCount = d.prestigeCount;
                            }
                        });

                        // GLOBAL COMMAND LISTENER
                        onSnapshot(doc(db, "system", "global"), (s) => {
                            if(s.exists()) {
                                const d = s.data();
                                if(d.forceRefreshAll && d.forceRefreshAll > sessionStartTime) {
                                    location.reload();
                                }
                            }
                        });

                        const save = await getDoc(doc(db, "leaderboard", user.uid)); 
                        if(save.exists()){ 
                            const d = save.data(); score = d.score || 0; vps = d.vps || 0; ppc = d.ppc || 1; totalVrajs = d.totalVrajs || 0; totalClicks = d.totalClicks || 0; totalUpgrades = d.totalUpgrades || 0; goldenVrajsCaught = d.goldenVrajsCaught || 0; 
                            savedTime = d.timePlayed || 0; totalCrits = d.totalCrits || 0; chatsSent = d.chatsSent || 0;
                            prestigeCount = d.prestigeCount || 0; fatflaps = d.fatflaps || 0; ownedPrestigeUpgrades = d.ownedPrestigeUpgrades || [];
                            // Load Prestige Cost Tracker
                            prestigeCostDeduction = d.prestigeCostDeduction || 0;

                            ascensionUnlocked = d.ascensionUnlocked || false; activeNametag = d.activeNametag || 'classic';
                            if(d.upgStates) d.upgStates.forEach((s, i) => { if(upgrades[i]) { upgrades[i].owned = s.owned; upgrades[i].cost = s.cost; } });
                            if(d.achStates) achievements.forEach((a, i) => { if(d.achStates[i]) a.unlocked = d.achStates[i]; });
                            if(d.activeTheme) setTheme(d.activeTheme);
                            if(d.petsState) petsState = d.petsState; 
                            if(d.equippedStyles) equippedStyles = new Set(d.equippedStyles);
                        }
                    }
                    renderShop(); renderAchievements(); renderPrestigeShop(); updateUI(); checkPets(); checkAchievements();
                    
                    setInterval(() => { if(currentUser && !currentUser.isAnonymous) {
                        const currentSession = Date.now() - sessionStartTime;
                        // UPDATED: Save isDev and isTester to leaderboard for public visibility
                        setDoc(doc(db, "leaderboard", currentUser.uid), { 
                            score, vps, ppc, totalVrajs, totalClicks, totalCrits, chatsSent, totalUpgrades, goldenVrajsCaught, 
                            timePlayed: savedTime + currentSession, username: currentUsername, 
                            upgStates: upgrades.map(u => ({ owned: u.owned, cost: u.cost })), 
                            achStates: achievements.map(a => a.unlocked), 
                            prestigeCount, fatflaps, ownedPrestigeUpgrades, activeTheme, activeNametag, 
                            ascensionUnlocked, petsState, equippedStyles: Array.from(equippedStyles), prestigeCostDeduction,
                            isDev: isDev, isTester: isTester 
                        }, { merge: true }); 
                    }}, 10000);
                    // UPDATED: Limit increased to 100
                    onSnapshot(query(collection(db, "leaderboard"), orderBy("totalVrajs", "desc"), limit(100)), (s) => {
                        let inTop = false;
                        document.getElementById('leaderboard-list').innerHTML = s.docs.map((d, i) => {
                            const dData = d.data(); 
                            if(d.id === currentUser.uid) { inTop = true; leaderboardRank = i + 1; }
                            
                            let rankClass = ""; let medal = ""; if (i === 0) { rankClass = "lb-rank-1"; medal = "ü•á"; } else if (i === 1) { rankClass = "lb-rank-2"; medal = "ü•à"; } else if (i === 2) { rankClass = "lb-rank-3"; medal = "ü•â"; }
                            let lbNameDisplay = dData.username; const tagData = nameTagsData.find(n => n.id === dData.activeNametag); if(tagData && dData.activeNametag !== 'classic') { lbNameDisplay = `<span class="${tagData.class}">${dData.username}</span>`; }
                            
                            // UPDATED: Tag Logic for Leaderboard
                            let tagHTML = "";
                            if (dData.isDev) tagHTML = `<span class="dev-tag mr-1 text-[8px]">[DEV]</span>`;
                            else if (dData.isTester) tagHTML = `<span class="beta-tag mr-1 text-[8px]">[BETA]</span>`;

                            return `<div class="lb-card p-3 flex items-center justify-between mb-2 ${rankClass}"><div class="flex items-center gap-3"><span class="text-xs font-black">#${i+1} ${medal}</span><div><p class="text-xs font-bold">${tagHTML}${lbNameDisplay}</p><p class="text-[9px] opacity-60 font-bold">${(dData.prestigeCount || 0)} Ascensions</p></div></div><div class="text-right"><p class="text-xs font-black text-blue-400">${formatNumber(Math.floor(dData.totalVrajs || 0))}</p></div></div>`;
                        }).join('');
                        isTop10 = inTop; checkAchievements();
                    });
                    
                    // --- UPDATED CHAT LOGIC WITH DEV TAG ---
                    // Fixed auto-scroll to bottom (newest messages)
                    const chatBox = document.getElementById('chat-box');
                    // UPDATED: Limit increased to 50
                    onSnapshot(query(collection(db, "globalChat"), orderBy("timestamp", "desc"), limit(50)), (s) => {
                        const wasAtBottom = chatBox.scrollHeight - chatBox.scrollTop === chatBox.clientHeight;
                        
                        // Reverse the array so oldest is at top, newest at bottom
                        const messages = s.docs.reverse();
                        
                        chatBox.innerHTML = messages.map(d => {
                            const dData = d.data();
                            let nameClass = "text-emerald-400 font-bold"; const tagData = nameTagsData.find(n => n.id === dData.nametag); if(tagData && dData.nametag !== 'classic') nameClass = tagData.class;
                            
                            // DEV TAG VISIBILITY CHECK
                            let devPrefix = "";
                            if(dData.isDev) {
                                devPrefix = `<span class="dev-tag text-[9px] mr-1">[DEV]</span>`;
                            } else if(dData.isTester) {
                                devPrefix = `<span class="beta-tag text-[9px] mr-1">[BETA]</span>`;
                            }

                            return `<div class="mb-1">${devPrefix}<span class="${nameClass}">${dData.username}:</span> ${dData.text}</div>`;
                        }).join('');

                        // Auto-scroll to bottom to see new message
                        chatBox.scrollTop = chatBox.scrollHeight;
                    });
                }
            } else { 
                resetLocalState();
                document.getElementById('auth-screen').classList.remove('hidden'); 
                document.getElementById('game-screen').classList.add('hidden'); 
            }
        });

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault(); const input = document.getElementById('chat-input'); if(!input.value.trim()) return;
            // UPDATED: Add isDev/isTester flag to chat message
            await addDoc(collection(db, "globalChat"), { text: input.value, username: currentUsername, nametag: activeNametag, isDev: isDev, isTester: isTester, timestamp: serverTimestamp() }); 
            chatsSent++; input.value = ""; checkAchievements();
        };

        // --- ASCENSION TREE DRAG & ZOOM ---
        let treeScale = 1, treePanX = 0, treePanY = 0, isDraggingTree = false, dragStartX, dragStartY;
        const treeContainerEl = document.getElementById('tree-container'); const treeViewEl = document.getElementById('ascension-tree-view');

        treeViewEl.addEventListener('wheel', (e) => {
            if(!treeViewEl.classList.contains('active')) return; e.preventDefault();
            const xs = (e.clientX - treePanX) / treeScale; const ys = (e.clientY - treePanY) / treeScale; const delta = -Math.sign(e.deltaY); const factor = 1.1; const newScale = delta > 0 ? treeScale * factor : treeScale / factor;
            if (newScale < 0.2 || newScale > 5) return;
            treeScale = newScale; treePanX = e.clientX - xs * treeScale; treePanY = e.clientY - ys * treeScale;
            treeContainerEl.style.transform = `translate(${treePanX}px, ${treePanY}px) scale(${treeScale})`; treeViewEl.style.backgroundPosition = `${treePanX}px ${treePanY}px`;
        }, { passive: false });

        treeViewEl.addEventListener('mousedown', (e) => { if(!treeViewEl.classList.contains('active')) return; if(e.target.closest('.tree-node') || e.target.closest('button')) return; isDraggingTree = true; dragStartX = e.clientX - treePanX; dragStartY = e.clientY - treePanY; treeContainerEl.style.cursor = 'grabbing'; });
        window.addEventListener('mousemove', (e) => { if(!isDraggingTree) return; e.preventDefault(); treePanX = e.clientX - dragStartX; treePanY = e.clientY - dragStartY; treeContainerEl.style.transform = `translate(${treePanX}px, ${treePanY}px) scale(${treeScale})`; treeViewEl.style.backgroundPosition = `${treePanX}px ${treePanY}px`; });
        window.addEventListener('mouseup', () => { isDraggingTree = false; treeContainerEl.style.cursor = 'grab'; });
    </script>
</body>
</html>
