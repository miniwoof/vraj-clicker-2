<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vraj Clicker 2</title>
    <link rel="icon" type="image/png" href="image_0.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Quicksand:wght@400;600&display=swap');
        
        :root {
            --bg-main: #070b14;
            --text-main: #e2e8f0;
            --accent: #3b82f6;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
            --panel-bg: rgba(7, 11, 20, 0.9);
            --transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- THEME DEFINITIONS --- */
        body.theme-light { --bg-main: #f8fafc; --text-main: #1e293b; --accent: #2563eb; --glass: rgba(255, 255, 255, 0.7); --border: rgba(0, 0, 0, 0.1); --panel-bg: rgba(241, 245, 249, 0.9); }
        body.theme-midnight { --bg-main: #010204; --text-main: #94a3b8; --accent: #3b82f6; --glass: rgba(255, 255, 255, 0.01); --border: rgba(255, 255, 255, 0.05); --panel-bg: rgba(1, 2, 4, 0.9); }
        body.theme-red { --bg-main: #1a0505; --text-main: #fecaca; --accent: #dc2626; --panel-bg: rgba(26, 5, 5, 0.9); }
        body.theme-orange { --bg-main: #1c0f05; --text-main: #fed7aa; --accent: #ea580c; --panel-bg: rgba(28, 15, 5, 0.9); }
        body.theme-yellow { --bg-main: #1a1605; --text-main: #fef08a; --accent: #ca8a04; --panel-bg: rgba(26, 22, 5, 0.9); }
        body.theme-green { --bg-main: #051a05; --text-main: #bbf7d0; --accent: #16a34a; --panel-bg: rgba(5, 26, 5, 0.9); }
        body.theme-blue { --bg-main: #0c1a2b; --text-main: #e0f2fe; --accent: #00d2ff; --panel-bg: rgba(12, 26, 43, 0.9); }
        body.theme-purple { --bg-main: #11051a; --text-main: #ddd6fe; --accent: #9333ea; --panel-bg: rgba(17, 5, 26, 0.9); }
        body.theme-pink { --bg-main: #1a0510; --text-main: #fce7f3; --accent: #f472b6; --panel-bg: rgba(26, 5, 16, 0.9); }
        body.theme-nature { --bg-main: #0d1a0d; --text-main: #ecfccb; --accent: #65a30d; --panel-bg: rgba(13, 26, 13, 0.9); }
        body.theme-sea { --bg-main: #082f49; --text-main: #e0f2fe; --accent: #0ea5e9; --panel-bg: rgba(8, 47, 73, 0.9); }
        body.theme-snowy { --bg-main: #1e293b; --text-main: #f1f5f9; --accent: #94a3b8; --panel-bg: rgba(30, 41, 59, 0.9); }
        body.theme-starry { --bg-main: #000000; --text-main: #ffffff; --accent: #6366f1; --panel-bg: rgba(0, 0, 0, 0.9); }
        
        /* Milky Way Theme Overrides */
        body.theme-milkyway { --bg-main: #000000; --text-main: #ffffff; --accent: #a855f7; --glass: rgba(0, 0, 0, 0.3); --border: rgba(168, 85, 247, 0.3); --panel-bg: rgba(0, 0, 0, 0.6); }
        .theme-milkyway .glass { border-color: rgba(168, 85, 247, 0.4); box-shadow: 0 0 20px rgba(124, 58, 237, 0.15); }
        .theme-milkyway .prestige-btn, 
        .theme-milkyway .bulk-btn.active, 
        .theme-milkyway .shop-tab-btn.active, 
        .theme-milkyway .style-tab-btn.active {
            background: #7c3aed !important;
            box-shadow: 0 0 15px #7c3aed, 0 0 5px #a855f7;
            border: 1px solid #c084fc;
        }
        .theme-milkyway #score { text-shadow: 0 0 20px rgba(168, 85, 247, 0.8); }
        
        /* Milky Way specific glow for clicker */
        .theme-milkyway .click-btn-container {
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.6), 0 0 60px rgba(124, 58, 237, 0.4), inset 0 0 20px rgba(168, 85, 247, 0.2);
            border-color: rgba(168, 85, 247, 0.8) !important;
        }

        /* Milky Way Leaderboard Transparency Fix */
        .theme-milkyway .lb-card {
            background: rgba(0, 0, 0, 0.2) !important; 
            border-color: rgba(168, 85, 247, 0.2);
        }

        body { font-family: 'Poppins', sans-serif; background: var(--bg-main); color: var(--text-main); margin: 0; height: 100vh; width: 100vw; overflow: hidden; transition: background 0.8s ease, color 0.5s ease; }
        .glass { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid var(--border); transition: var(--transition); }
        
        .left-panel-content { background: var(--panel-bg); transition: var(--transition); }
        .side-tab { background: rgba(0,0,0,0.4); color: var(--text-main); opacity: 0.8; }
        .side-tab.active { background: var(--accent); color: white; opacity: 1; transform: translateX(5px); }
        #score { color: var(--accent); transition: var(--transition); }

        /* Canvas Background */
        #galaxy-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 1; }
        .hidden { display: none !important; }

        /* Particle Overlay */
        #theme-overlay { position: fixed; inset: 0; pointer-events: none !important; z-index: 1; overflow: hidden; }
        .particle { position: absolute; pointer-events: none !important; will-change: transform; user-select: none; }

        /* Responsive Grid */
        .game-grid { display: grid; grid-template-columns: 350px 1fr 350px; grid-template-rows: 1fr; height: 100vh; gap: 1.5rem; padding: 1.5rem; box-sizing: border-box; position: relative; z-index: 10; }
        @media (max-width: 1200px) { .game-grid { grid-template-columns: 300px 1fr 300px; gap: 1rem; padding: 1rem; } }
        @media (max-width: 1024px) {
            .game-grid { display: flex; flex-direction: column; overflow-y: auto; height: 100vh; }
            .left-area, .right-area { min-height: 500px; width: 100%; }
            .center-area { min-height: 600px; order: -1; }
            .side-tabs-container { right: 10px !important; top: 10px !important; flex-direction: row !important; height: auto !important; width: auto !important; }
            .side-tab { writing-mode: horizontal-tb !important; padding: 8px 15px !important; border-radius: 8px !important; }
            body { overflow-y: auto; }
        }

        .left-area { position: relative; height: 100%; min-height: 0; }
        .center-area { display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 1rem 0; height: 100%; }
        .right-area { display: flex; flex-direction: column; gap: 1rem; height: 100%; overflow: hidden; }
        .scroll-panel { overflow-y: auto; flex-grow: 1; scrollbar-width: thin; scrollbar-color: var(--accent) transparent; }
        .scroll-panel::-webkit-scrollbar { width: 4px; }
        .scroll-panel::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
        
        .side-tabs-container { position: absolute; right: -32px; top: 50px; display: flex; flex-direction: column; gap: 10px; z-index: 20; }
        .side-tab { border: 1px solid var(--border); border-left: none; padding: 15px 8px; border-radius: 0 12px 12px 0; cursor: pointer; writing-mode: vertical-lr; text-orientation: mixed; font-size: 10px; font-weight: 800; transition: all 0.2s; }
        
        /* Main Clicker Styles */
        .click-btn-container { 
            transition: transform 0.05s active, background 0.5s ease; 
            cursor: pointer; 
            user-select: none; 
            position: relative; 
            background: var(--accent) !important; 
            box-shadow: 0 0 25px rgba(168, 85, 247, 0.4); /* Purple Glow Default */
        }
        .click-btn-container:active { transform: scale(0.95); }
        .click-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; pointer-events: none; }
        
        .upgrade-card, .ach-card, .prestige-card, .theme-card { transition: all 0.2s; border: 1px solid var(--border); border-radius: 1rem; background: rgba(0,0,0,0.4); }
        .upgrade-card:hover:not(.disabled), .prestige-card:hover:not(.disabled), .theme-card:hover { background: rgba(59, 130, 246, 0.1); border-color: var(--accent); cursor: pointer; }
        .theme-card.active { border-color: var(--accent); background: rgba(59, 130, 246, 0.2); border-width: 2px; }
        
        .upgrade-card.disabled, .prestige-card.disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(1); }
        .ach-card.locked { opacity: 0.3; filter: grayscale(1); }
        .ach-card.unlocked { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.4); }
        .stat-row { display: flex; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid var(--border); }
        
        .bulk-btn.active, .shop-tab-btn.active, .style-tab-btn.active { background: var(--accent); color: white; }
        
        /* Floating Text - Slower (3s) and Bigger (2rem) */
        .float-text { 
            position: absolute; 
            color: var(--accent); 
            font-weight: 800; 
            font-size: 2rem; 
            pointer-events: none; 
            animation: floatUp 3s ease-out forwards; 
            z-index: 100; 
        }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-150px); opacity: 0; } }
        
        .golden-vraj { position: absolute; width: 80px; height: 80px; cursor: pointer; z-index: 50; filter: drop-shadow(0 0 15px gold) brightness(1.5); animation: goldenFly 10s linear forwards; }
        @keyframes goldenFly { 0% { left: -100px; top: 20%; } 100% { left: 110vw; top: 60%; } }
        
        /* Fixed Prestige Button Gradient */
        .prestige-btn { 
            background: linear-gradient(135deg, var(--accent), #7c3aed); 
            border: 2px solid rgba(255,255,255,0.2); 
            transition: all 0.3s ease;
        }
        
        /* Leaderboard Medals */
        .lb-card { background: var(--glass); border: 1px solid var(--border); border-radius: 12px; }
        .lb-rank-1 { background: rgba(255, 215, 0, 0.2) !important; border-color: gold !important; }
        .lb-rank-2 { background: rgba(192, 192, 192, 0.2) !important; border-color: silver !important; }
        .lb-rank-3 { background: rgba(205, 127, 50, 0.2) !important; border-color: #cd7f32 !important; }

        #game-modal { z-index: 1000; position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); padding: 20px; }
        
        /* Multiplier Display Position - Moved left to avoid touching chat */
        #multiplier-display { position: fixed; bottom: 2rem; right: 400px; z-index: 100; pointer-events: none; }
        @media (max-width: 1024px) { #multiplier-display { bottom: auto; top: 20px; right: 20px; } }

        /* Theme Specific CSS Animations - FIXED to prevent sticking */
        .nature-leaf { font-size: 20px; animation: fall 10s linear infinite; }
        .snow-flake { font-size: 10px; animation: fall 8s linear infinite; opacity: 0.8; }
        .sea-bubble { font-size: 15px; animation: rise 15s linear infinite; opacity: 0.6; }
        .star { position: absolute; border-radius: 50%; animation: twinkle 3s infinite ease-in-out; }

        @keyframes fall {
            0% { transform: translateY(-20vh) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(110vh) translateX(100px) rotate(360deg); opacity: 0; }
        }
        @keyframes rise {
            0% { transform: translateY(110vh) translateX(0); opacity: 0; }
            10% { opacity: 0.5; }
            100% { transform: translateY(-20vh) translateX(-50px); opacity: 0; }
        }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
        
        /* Warp Transitions */
        .warp-transition { animation: warpIn 0.1s ease-out forwards; }
        @keyframes warpIn {
            0% { transform: scale(0.95) translateY(10px); opacity: 0.9; filter: blur(5px); }
            100% { transform: scale(1) translateY(0); opacity: 1; filter: blur(0); }
        }
    </style>
</head>
<body class="select-none theme-classic">

    <canvas id="galaxy-canvas" class="hidden"></canvas>
    <div id="theme-overlay"></div>

    <div id="game-modal" class="hidden">
        <div class="glass p-8 rounded-3xl max-w-md w-full border-white/20 shadow-2xl">
            <h2 id="modal-title" class="text-2xl font-black mb-4">Title</h2>
            <div id="modal-content" class="text-sm opacity-80 mb-8 leading-relaxed">Content</div>
            <div id="modal-input-container" class="hidden mb-6">
                <input type="text" id="modal-text-input" placeholder="Type here..." class="w-full p-4 rounded-xl bg-gray-900 border border-gray-700 outline-none text-white">
            </div>
            <div id="modal-footer" class="flex gap-4">
                <button id="modal-cancel" class="flex-1 py-3 bg-gray-800 rounded-xl font-bold">Cancel</button>
                <button id="modal-confirm" class="flex-1 py-3 bg-blue-600 rounded-xl font-bold">Confirm</button>
            </div>
        </div>
    </div>

    <div id="multiplier-display" class="hidden">
        <div class="glass p-3 rounded-2xl border-yellow-500/50 border flex items-center gap-3 shadow-xl">
            <span class="text-2xl">üåü</span>
            <div>
                <p class="text-[9px] font-bold text-yellow-400 tracking-tighter uppercase">2X MULTI ACTIVE</p>
                <p id="mult-timer" class="text-md font-black">03:00</p>
            </div>
        </div>
    </div>

    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass p-8 rounded-3xl shadow-2xl w-full max-w-md text-center">
            <h1 class="text-4xl font-extrabold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">Vraj Clicker 2</h1>
            <div id="auth-tabs" class="flex mb-6 bg-black/20 rounded-lg p-1">
                <button onclick="switchTab('login')" id="tab-login" class="flex-1 py-2 rounded-md font-semibold bg-blue-600">Login</button>
                <button onclick="switchTab('signup')" id="tab-signup" class="flex-1 py-2 rounded-md font-semibold opacity-50">Sign Up</button>
            </div>
            <div id="login-form" class="space-y-4">
                <input type="email" id="li-email" placeholder="Email" class="w-full p-4 rounded-xl bg-black/20 border border-white/10 outline-none">
                <input type="password" id="li-password" placeholder="Password" class="w-full p-4 rounded-xl bg-black/20 border border-white/10 outline-none">
                <button onclick="handleLogin()" class="w-full bg-blue-600 p-4 rounded-xl font-bold">Enter Game</button>
                <button onclick="handleGuest()" class="w-full bg-gray-700 p-4 rounded-xl font-bold text-sm">Play as Guest</button>
            </div>
            <div id="signup-form" class="hidden space-y-4">
                <input type="text" id="su-username" placeholder="Username" class="w-full p-4 rounded-xl bg-black/20 border border-white/10 outline-none">
                <input type="email" id="su-email" placeholder="Email" class="w-full p-4 rounded-xl bg-black/20 border border-white/10 outline-none">
                <input type="password" id="su-password" placeholder="Password" class="w-full p-4 rounded-xl bg-black/20 border border-white/10 outline-none">
                <button onclick="handleSignup()" class="w-full bg-emerald-600 p-4 rounded-xl font-bold">Create Account</button>
            </div>
            <div id="verify-notice" class="hidden py-6">
                <h2 class="text-xl font-bold text-yellow-400">Check Email</h2>
                <button onclick="location.reload()" class="bg-blue-600 p-3 rounded-xl font-bold w-full mt-4">I've Verified</button>
            </div>
        </div>
    </div>

    <div id="game-screen" class="hidden h-screen overflow-hidden">
        <div class="game-grid">
            <div class="left-area">
                <div class="glass rounded-3xl flex flex-col h-full overflow-hidden relative z-10">
                    <div id="panel-shop" class="left-panel-content flex flex-col h-full overflow-hidden">
                        <div class="p-4 border-b border-white/10 bg-white/5 space-y-3 flex-shrink-0">
                            <h3 class="font-bold">üè™ Vraj Shop</h3>
                            <div class="flex bg-black/40 rounded-lg p-1 text-[10px] font-bold">
                                <button onclick="setBulk(1)" id="bulk-1" class="bulk-btn flex-1 py-1 rounded active">1X</button>
                                <button onclick="setBulk(10)" id="bulk-10" class="bulk-btn flex-1 py-1 rounded">10X</button>
                                <button onclick="setBulk(100)" id="bulk-100" class="bulk-btn flex-1 py-1 rounded">100X</button>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="setShopTab('clicker')" id="shop-tab-clicker" class="shop-tab-btn flex-1 py-2 rounded-lg text-[10px] font-bold bg-white/5 active">CLICKERS</button>
                                <button onclick="setShopTab('passive')" id="shop-tab-passive" class="shop-tab-btn flex-1 py-2 rounded-lg text-[10px] font-bold bg-white/5">PASSIVE</button>
                            </div>
                        </div>
                        <div id="shop-list" class="scroll-panel p-4 space-y-3"></div>
                    </div>
                    
                    <div id="panel-prestige" class="left-panel-content hidden h-full flex flex-col overflow-hidden">
                        <div class="p-6 border-b border-white/10 bg-white/5 flex-shrink-0 text-center">
                            <h3 class="font-bold text-purple-400 text-xl mb-2">üìà Ascension</h3>
                            <p class="text-[10px] opacity-60 uppercase font-bold mb-4">Reset progress for permanent power</p>
                            <div class="w-full bg-black/40 h-6 rounded-full overflow-hidden border border-white/10 relative mb-4">
                                <div id="prestige-bar" class="h-full bg-gradient-to-r from-purple-600 to-blue-500 transition-all duration-300" style="width: 0%"></div>
                                <span id="prestige-percent" class="absolute inset-0 flex items-center justify-center text-[10px] font-black text-white">0%</span>
                            </div>
                            <button id="prestige-btn" onclick="openPrestigeModal()" class="prestige-btn w-full py-4 rounded-2xl font-black text-white shadow-lg transform active:scale-95 transition-all">
                                ASCEND <span id="prestige-gain-display">(+0 Fatflaps)</span>
                            </button>
                            <p class="text-[9px] opacity-50 mt-2 italic">Next Fatflap costs: <span id="next-prestige-cost">10,000</span></p>
                        </div>
                        <div id="prestige-shop-list" class="scroll-panel p-4 space-y-3"></div>
                    </div>

                    <div id="panel-achievements" class="left-panel-content hidden h-full flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-white/10 bg-white/5 flex-shrink-0">
                            <h3 class="font-bold text-purple-400 mb-2">üèÜ Achievements</h3>
                            <div class="w-full bg-black/40 h-4 rounded-full overflow-hidden border border-white/5">
                                <div id="ach-progress-bar" class="h-full bg-gradient-to-r from-purple-500 to-blue-500 transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <p class="text-[10px] font-bold opacity-60 mt-1 uppercase tracking-widest text-right">
                                Completed: <span id="ach-count">0</span> / <span id="ach-total">0</span>
                            </p>
                        </div>
                        <div id="ach-list" class="scroll-panel p-4 space-y-2"></div>
                    </div>

                    <div id="panel-style" class="left-panel-content hidden h-full flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-white/10 bg-white/5 space-y-3 flex-shrink-0">
                            <h3 class="font-bold text-pink-400">üé® Style Studio</h3>
                            <div class="flex gap-2">
                                <button onclick="setStyleTab('vrajs')" id="style-tab-vrajs" class="style-tab-btn flex-1 py-2 rounded-lg text-[9px] font-bold bg-white/5">VRAJ'S</button>
                                <button onclick="setStyleTab('names')" id="style-tab-names" class="style-tab-btn flex-1 py-2 rounded-lg text-[9px] font-bold bg-white/5">NAME TAGS</button>
                                <button onclick="setStyleTab('themes')" id="style-tab-themes" class="style-tab-btn flex-1 py-2 rounded-lg text-[9px] font-bold bg-white/5 active">THEMES</button>
                            </div>
                        </div>
                        <div id="style-list" class="scroll-panel p-4 space-y-3"></div>
                    </div>

                    <div id="panel-stats" class="left-panel-content hidden h-full flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-white/10 bg-white/5 flex-shrink-0">
                            <h3 class="font-bold text-emerald-400">üìä Statistics</h3>
                        </div>
                        <div class="scroll-panel p-2 space-y-1 text-sm">
                            <div class="stat-row"><span>Total Multiplier</span><span id="stat-total-mult" class="text-yellow-400 font-bold">1.0x</span></div>
                            <div class="stat-row"><span>Fatflaps</span><span id="stat-fatflaps" class="text-purple-400 font-bold">0</span></div>
                            <div class="stat-row"><span>Total Ascensions</span><span id="stat-prestige-count" class="text-purple-400 font-bold">0</span></div>
                            <div class="stat-row"><span>Total Vrajs Collected</span><span id="stat-total-vrajs" class="font-bold">0</span></div>
                            <div class="stat-row"><span>Manual Clicks</span><span id="stat-manual-clicks" class="font-bold">0</span></div>
                            <div class="stat-row"><span>Upgrades Bought</span><span id="stat-upgrades-bought" class="font-bold">0</span></div>
                            <div class="stat-row"><span>Golden Vrajs Caught</span><span id="stat-golden-caught" class="font-bold">0</span></div>
                            <div class="stat-row"><span>Time Played</span><span id="stat-time-played" class="font-bold">0m</span></div>
                        </div>
                    </div>

                    <div id="panel-settings" class="left-panel-content hidden h-full p-6 flex flex-col justify-between">
                        <div class="space-y-6">
                            <h3 class="font-bold opacity-50 text-xl mb-4">‚öôÔ∏è System</h3>
                            <div class="space-y-3">
                                <button onclick="trackSettingClick()" class="w-full p-4 glass rounded-xl text-left text-sm hover:bg-white/5 transition flex justify-between items-center">
                                    Check for Updates <span class="text-[10px] bg-blue-500/20 px-2 py-1 rounded">v2.5</span>
                                </button>
                                <button onclick="triggerAccountReset()" class="w-full p-4 bg-red-600/10 border border-red-600/30 text-red-500 rounded-xl text-left text-sm font-bold hover:bg-red-600/20 transition">
                                    Reset Account Progress
                                </button>
                            </div>
                        </div>
                        <button onclick="logoutAction()" class="w-full bg-gray-800 text-gray-400 p-4 rounded-xl font-bold border border-white/5">Sign Out</button>
                    </div>
                </div>
                <div class="side-tabs-container">
                    <div id="tab-shop" onclick="switchSideTab('shop')" class="side-tab active">SHOP</div>
                    <div id="tab-prestige" onclick="switchSideTab('prestige')" class="side-tab">ASCEND</div>
                    <div id="tab-achievements" onclick="switchSideTab('achievements')" class="side-tab">GOALS</div>
                    <div id="tab-style" onclick="switchSideTab('style')" class="side-tab">STYLE</div>
                    <div id="tab-stats" onclick="switchSideTab('stats')" class="side-tab">STATS</div>
                    <div id="tab-settings" onclick="switchSideTab('settings')" class="side-tab">SYSTEM</div>
                </div>
            </div>

            <div class="center-area">
                <div class="text-center">
                    <div id="fatflap-display" class="mb-2 flex items-center justify-center gap-2 hidden">
                        <span class="text-2xl">ü•û</span>
                        <span id="fatflap-count" class="text-2xl font-black text-purple-400">0</span>
                        <span class="text-[10px] font-bold text-purple-500/80 uppercase">Fatflaps</span>
                    </div>
                    <h2 id="score" class="text-7xl font-black drop-shadow-lg">0</h2>
                    <p id="vps-display" class="text-emerald-400 font-bold tracking-widest text-sm uppercase">0 VPS</p>
                    <p id="ppc-display" class="font-bold text-[10px] mt-1 opacity-80">1 Points Per Click</p>
                </div>
                
                <div class="flex flex-col items-center gap-4">
                    <div id="clicker-container" onclick="clickVraj(event)" class="click-btn-container w-[450px] h-[450px] rounded-full p-1 shadow-2xl">
                        <div class="w-full h-full rounded-full overflow-hidden border-8 border-black/80 transition-colors duration-500 bg-black">
                            <img src="image_0.png" class="click-img">
                        </div>
                    </div>
                    <div class="glass px-6 py-2 rounded-full border border-white/10">
                        <p class="text-xs font-black tracking-widest uppercase opacity-60">Total Multiplier: <span id="icon-mult-display" class="text-yellow-400">1.0x</span></p>
                    </div>
                </div>

                <div class="w-full max-w-xs text-center pb-8">
                    <div class="glass p-3 rounded-2xl text-xs opacity-60">User: <span id="user-display" class="font-bold">...</span></div>
                </div>
            </div>

            <div class="right-area">
                <div class="glass rounded-3xl flex-1 flex flex-col overflow-hidden min-h-[300px]">
                    <div class="p-4 bg-white/5 font-bold text-purple-400 flex-shrink-0">üèÜ Leaderboard</div>
                    <div id="leaderboard-list" class="scroll-panel p-4 space-y-2"></div>
                </div>
                <div class="glass rounded-3xl flex-1 flex flex-col overflow-hidden min-h-[300px]">
                    <div class="p-4 bg-white/5 font-bold text-emerald-400 flex-shrink-0">üí¨ Global Chat</div>
                    <div id="chat-box" class="scroll-panel p-4 flex flex-col-reverse text-sm"></div>
                    <form id="chat-form" class="p-3 bg-white/5 flex gap-2 flex-shrink-0">
                        <input type="text" id="chat-input" placeholder="Type..." class="flex-grow bg-black/40 border border-white/10 p-2 rounded-lg text-xs outline-none">
                        <button class="bg-emerald-600 px-3 py-2 rounded-lg text-xs font-bold text-white">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously, onAuthStateChanged, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, orderBy, limit, onSnapshot, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import * as THREE from 'three';

        const firebaseConfig = { apiKey: "AIzaSyDwg2ZSpQspAD-o19AZCOHcrl9VnYc_sdk", authDomain: "vraj-clicker-2.firebaseapp.com", projectId: "vraj-clicker-2", storageBucket: "vraj-clicker-2.firebasestorage.app", messagingSenderId: "162243172716", appId: "1:162243172716:web:874a1f8be471a9f0d83b49" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const clickSound = new Audio('click.mp3');
        function playSfx() { clickSound.currentTime = 0; clickSound.play().catch(()=>{}); }

        // --- GALAXY 3D ENGINE ---
        let galaxyScene, galaxyCamera, galaxyRenderer, worldGroup, galaxyActive = false;
        
        function initGalaxy() {
            if (galaxyRenderer) return;
            const canvas = document.getElementById('galaxy-canvas');
            galaxyScene = new THREE.Scene();
            galaxyCamera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 2000);
            galaxyCamera.position.set(0, 18, 90);

            galaxyRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: false, powerPreference: "high-performance", alpha: true });
            galaxyRenderer.setSize(window.innerWidth, window.innerHeight);
            galaxyRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            worldGroup = new THREE.Group();
            worldGroup.position.y = 8;
            galaxyScene.add(worldGroup);

            const vShader = `attribute float size; varying vec3 vColor; void main() { vColor = color; vec4 mvPosition = modelViewMatrix * vec4(position, 1.0); gl_PointSize = size * (250.0 / -mvPosition.z); gl_Position = projectionMatrix * mvPosition; }`;
            const fShader = `varying vec3 vColor; void main() { float d = distance(gl_PointCoord, vec2(0.5)); if (d > 0.5) discard; float strength = pow(1.0 - d * 2.1, 2.5); gl_FragColor = vec4(vColor, strength * 0.9); }`;

            const count = 150000;
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(count * 3), cols = new Float32Array(count * 3), sizes = new Float32Array(count);
            const cIn = new THREE.Color('#ffe1b0'), cOut = new THREE.Color('#3366ff');

            for (let i = 0; i < count; i++) {
                const i3 = i * 3, r = Math.random() * 75, bAngle = (i % 2) * Math.PI, spin = r * 0.22;
                const rX = Math.pow(Math.random(), 3) * (Math.random() < 0.5 ? 1 : -1) * 4, rY = Math.pow(Math.random(), 3) * (Math.random() < 0.5 ? 1 : -1) * 2, rZ = Math.pow(Math.random(), 3) * (Math.random() < 0.5 ? 1 : -1) * 4;
                pos[i3] = Math.cos(bAngle + spin) * r + rX; pos[i3+1] = rY; pos[i3+2] = Math.sin(bAngle + spin) * r + rZ;
                const mixed = cIn.clone().lerp(cOut, r/75); cols[i3] = mixed.r; cols[i3+1] = mixed.g; cols[i3+2] = mixed.b;
                sizes[i] = Math.random() * 1.2 + 0.3;
            }
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3)); geo.setAttribute('color', new THREE.BufferAttribute(cols, 3)); geo.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
            worldGroup.add(new THREE.Points(geo, new THREE.ShaderMaterial({ vertexShader: vShader, fragmentShader: fShader, transparent: true, blending: THREE.AdditiveBlending, depthWrite: false, vertexColors: true })));

            function createDust(color, density, spread) {
                const g = new THREE.BufferGeometry(); const p = new Float32Array(density * 3); const cArr = new Float32Array(density * 3); const c = new THREE.Color(color);
                for (let i = 0; i < density; i++) {
                    const i3 = i * 3; p[i3] = (Math.random() - 0.5) * spread; p[i3+1] = (Math.random() - 0.5) * spread * 0.3 - 15; p[i3+2] = (Math.random() - 0.5) * spread;
                    cArr[i3] = c.r; cArr[i3+1] = c.g; cArr[i3+2] = c.b;
                }
                g.setAttribute('position', new THREE.BufferAttribute(p, 3)); g.setAttribute('color', new THREE.BufferAttribute(cArr, 3));
                return new THREE.Points(g, new THREE.PointsMaterial({ size: 0.5, transparent: true, opacity: 0.2, vertexColors: true, blending: THREE.AdditiveBlending }));
            }
            worldGroup.add(createDust('#1a0033', 8000, 500)); worldGroup.add(createDust('#001133', 8000, 600));

            const starGeo = new THREE.BufferGeometry(); const starP = new Float32Array(10000 * 3);
            for(let i=0; i<30000; i++) starP[i] = (Math.random() - 0.5) * 1500;
            starGeo.setAttribute('position', new THREE.BufferAttribute(starP, 3));
            galaxyScene.add(new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0x333333, size: 0.3 })));

            window.addEventListener('resize', () => { galaxyCamera.aspect = window.innerWidth / window.innerHeight; galaxyCamera.updateProjectionMatrix(); galaxyRenderer.setSize(window.innerWidth, window.innerHeight); });
        }

        let mouseX = 0, mouseY = 0;
        window.addEventListener('mousemove', (e) => { mouseX = (e.clientX / window.innerWidth) - 0.5; mouseY = (e.clientY / window.innerHeight) - 0.5; });

        function animateGalaxy() {
            if (!galaxyActive) return;
            requestAnimationFrame(animateGalaxy);
            worldGroup.rotation.y += 0.0015;
            const tX = mouseY * 0.15, tZ = mouseX * 0.15;
            worldGroup.rotation.x += (tX - worldGroup.rotation.x) * 0.04;
            worldGroup.rotation.z += (tZ - worldGroup.rotation.z) * 0.04;
            galaxyRenderer.render(galaxyScene, galaxyCamera);
        }

        initGalaxy();

        window.showAlert = (title, content, onConfirm = null, isConfirm = false, isReset = false) => {
            const modal = document.getElementById('game-modal');
            const titleEl = document.getElementById('modal-title');
            const contentEl = document.getElementById('modal-content');
            const inputContainer = document.getElementById('modal-input-container');
            const cancelBtn = document.getElementById('modal-cancel');
            const confirmBtn = document.getElementById('modal-confirm');
            const textInput = document.getElementById('modal-text-input');
            
            titleEl.innerText = title;
            contentEl.innerHTML = content;
            modal.classList.remove('hidden');
            cancelBtn.classList.toggle('hidden', !isConfirm);
            inputContainer.classList.toggle('hidden', !isReset);
            
            if(isReset) textInput.value = "";
            
            cancelBtn.onclick = () => modal.classList.add('hidden');
            confirmBtn.onclick = () => {
                if(isReset) {
                    if(textInput.value === currentUsername) {
                        modal.classList.add('hidden');
                        if(onConfirm) onConfirm();
                    } else {
                        alert("Incorrect username. Reset cancelled.");
                    }
                } else {
                    modal.classList.add('hidden');
                    if(onConfirm) onConfirm();
                }
            };
        };

        let score = 0, vps = 0, ppc = 1, bulkAmount = 1, currentShopTab = 'clicker', currentStyleTab = 'themes';
        let totalVrajs = 0, totalClicks = 0, totalUpgrades = 0, settingsClicked = 0, goldenVrajsCaught = 0, chatsSent = 0, timePlayed = 0;
        let goldenMultiplier = 1, multTimeRemaining = 0;
        let prestigeCount = 0, fatflaps = 0, ownedPrestigeUpgrades = [];
        let currentUser = null, currentUsername = "Guest", activeTheme = 'classic';
        let clickIntervals = [], lastClickTime = 0, hasWarned = false;

        const upgradeData = [
            { name: "Vraj Finger", baseCost: 10, basePower: 0.2, emoji: "‚òùÔ∏è" },
            { name: "Vraj Sprout", baseCost: 20, basePower: 0.4, emoji: "üå±" },
            { name: "Vraj Cursor", baseCost: 50, basePower: 1, emoji: "üñ±Ô∏è" },
            { name: "Vraj Nanobots", baseCost: 80, basePower: 2, emoji: "ü§è" },
            { name: "Vraj Drone", baseCost: 120, basePower: 4, emoji: "üöÅ" },
            { name: "Vraj Magnet", baseCost: 210, basePower: 6, emoji: "üß≤" },
            { name: "Vraj Juice", baseCost: 336, basePower: 10, emoji: "üßÉ" },
            { name: "Vraj Keyboard", baseCost: 538, basePower: 15, emoji: "‚å®Ô∏è" },
            { name: "Vraj Potion", baseCost: 861, basePower: 30, emoji: "üß™" },
            { name: "Vraj Coffee", baseCost: 1378, basePower: 50, emoji: "‚òï" },
            { name: "Vraj Gear", baseCost: 2205, basePower: 100, emoji: "‚öôÔ∏è" },
            { name: "Vraj Botnet", baseCost: 3528, basePower: 120, emoji: "üåê" },
            { name: "Vraj Tuner", baseCost: 5645, basePower: 150, emoji: "üéöÔ∏è" },
            { name: "Vraj Garden", baseCost: 9032, basePower: 170, emoji: "üåø" },
            { name: "Vraj Typist", baseCost: 14451, basePower: 200, emoji: "üíª" },
            { name: "Vraj Swarm", baseCost: 23122, basePower: 250, emoji: "üêù" },
            { name: "Vraj Automaton", baseCost: 36995, basePower: 280, emoji: "ü§ñ" },
            { name: "Vraj Attractor", baseCost: 59192, basePower: 296, emoji: "üß≤" },
            { name: "Vraj Smoothie", baseCost: 94707, basePower: 474, emoji: "ü•§" },
            { name: "Vraj Console", baseCost: 151531, basePower: 758, emoji: "üïπÔ∏è" },
            { name: "Vraj Lab", baseCost: 242450, basePower: 1212, emoji: "‚öóÔ∏è" },
            { name: "Vraj Brewery", baseCost: 387920, basePower: 1940, emoji: "üç∫" },
            { name: "Vraj Workshop", baseCost: 620672, basePower: 3103, emoji: "üõ†Ô∏è" },
            { name: "Vraj Network", baseCost: 993075, basePower: 4965, emoji: "üì°" },
            { name: "Vraj Reactor", baseCost: 1588920, basePower: 7945, emoji: "‚öõÔ∏è" },
            { name: "Vraj Meadow", baseCost: 2542272, basePower: 12711, emoji: "üåæ" },
            { name: "Vraj Terminal", baseCost: 4067635, basePower: 20338, emoji: "üñ•Ô∏è" },
            { name: "Vraj Hive", baseCost: 6508216, basePower: 32541, emoji: "üêú" },
            { name: "Vraj Factory", baseCost: 10413146, basePower: 52066, emoji: "üè≠" },
            { name: "Vraj Collider", baseCost: 16661034, basePower: 83305, emoji: "üî¨" },
            { name: "Vraj Extract", baseCost: 26657654, basePower: 133288, emoji: "üßâ" },
            { name: "Vraj Deck", baseCost: 42652246, basePower: 213261, emoji: "üéÆ" },
            { name: "Vraj Chemworks", baseCost: 68243594, basePower: 341218, emoji: "üß´" },
            { name: "Vraj Distillery", baseCost: 109189750, basePower: 545949, emoji: "ü•É" },
            { name: "Vraj Assembly", baseCost: 174703600, basePower: 873518, emoji: "ü§ù" },
            { name: "Vraj Mainframe", baseCost: 279525760, basePower: 1397629, emoji: "üíΩ" },
            { name: "Vraj Singularity", baseCost: 447241216, basePower: 2236206, emoji: "üåÄ" },
            { name: "Vraj Forest", baseCost: 715585946, basePower: 3577930, emoji: "üå≤" },
            { name: "Vraj Supercomp", baseCost: 1144937514, basePower: 5724688, emoji: "üíæ" },
            { name: "Vraj Colony", baseCost: 1831900022, basePower: 9159501, emoji: "üêú" },
            { name: "Vraj Megaplant", baseCost: 2931040035, basePower: 14655200, emoji: "üèóÔ∏è" },
            { name: "Vraj Accelerator", baseCost: 4689664056, basePower: 23448320, emoji: "üöÄ" },
            { name: "Vraj Serum", baseCost: 7503462490, basePower: 37517312, emoji: "üíâ" },
            { name: "Vraj Interface", baseCost: 12005539984, basePower: 60027700, emoji: "üß©" },
            { name: "Vraj Genome", baseCost: 19208863974, basePower: 96044320, emoji: "üß¨" },
            { name: "Vraj Roast", baseCost: 30734182358, basePower: 153670912, emoji: "üå∞" },
            { name: "Vraj Forge", baseCost: 49174691773, basePower: 245873459, emoji: "üóúÔ∏è" },
            { name: "Vraj Datasphere", baseCost: 78679506837, basePower: 393397534, emoji: "üåê" }
        ];

        const prestigeUpgradeData = [
            { id: "p1", name: "Heavenly Clicks", cost: 1, desc: "Add +1.0 to your total multiplier forever.", emoji: "‚ú®" },
            { id: "p2", name: "Golden Aura", cost: 2, desc: "Golden Vrajs appear twice as often.", emoji: "‚òÄÔ∏è" },
            { id: "p3", name: "Persistent Vraj", cost: 5, desc: "Start every prestige with 50 Vraj Fingers.", emoji: "ü•û" }
        ];

        const achievements = [];
        [1, 100, 500, 1000, 5000, 10000, 50000, 100000, 500000, 1000000].forEach(n => achievements.push({ id: `click-${n}`, title: `${n.toLocaleString()} Clicks`, desc: `Click the Vraj ${n.toLocaleString()} times.`, target: n, type: 'clicks', unlocked: false }));
        upgradeData.forEach((u, i) => {
            achievements.push({ id: `buy-${i}-10`, title: `${u.name} Novice`, desc: `Own 10 ${u.name}s.`, target: 10, type: 'upgrade', upgIdx: i, unlocked: false });
            achievements.push({ id: `buy-${i}-50`, title: `${u.name} Expert`, desc: `Own 50 ${u.name}s.`, target: 50, type: 'upgrade', upgIdx: i, unlocked: false });
        });

        const upgrades = upgradeData.map((u, i) => ({ id: i+1, ...u, owned: 0, cost: u.baseCost, isClickUpgrade: (i+1)%2!==0 }));

        function getTotalMultiplier() {
            const ffBonus = fatflaps * 0.5;
            const upgradeBonus = ownedPrestigeUpgrades.includes("p1") ? 1.0 : 0;
            return (1 + ffBonus + upgradeBonus) * goldenMultiplier;
        }

        window.switchSideTab = (tab) => {
            document.querySelectorAll('.left-panel-content').forEach(p => {
                p.classList.add('hidden');
                p.classList.remove('warp-transition');
            });
            document.querySelectorAll('.side-tab').forEach(t => t.classList.remove('active'));
            
            const target = document.getElementById('panel-'+tab);
            target.classList.remove('hidden');
            void target.offsetWidth; 
            target.classList.add('warp-transition');
            
            document.getElementById('tab-'+tab).classList.add('active');
            if(tab === 'achievements') renderAchievements();
            if(tab === 'stats') updateStatsUI();
            if(tab === 'prestige') renderPrestigeShop();
            if(tab === 'style') renderStylePanel();
        };

        window.setBulk = (amt) => { bulkAmount = amt; document.querySelectorAll('.bulk-btn').forEach(b => b.classList.remove('active')); document.getElementById('bulk-'+amt).classList.add('active'); updateUI(); };
        window.setShopTab = (tab) => { currentShopTab = tab; document.querySelectorAll('.shop-tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('shop-tab-'+tab).classList.add('active'); renderShop(); updateUI(); };
        window.setStyleTab = (tab) => { currentStyleTab = tab; document.querySelectorAll('.style-tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('style-tab-'+tab).classList.add('active'); renderStylePanel(); };

        function getBulkCost(baseCost, count) { let total = 0; let temp = baseCost; for(let i=0; i<count; i++) { total += temp; temp = Math.ceil(temp * 1.15); } return total; }

        window.buyUpgrade = (id) => {
            const upg = upgrades.find(u => u.id === id);
            const cost = getBulkCost(upg.cost, bulkAmount);
            if (score >= cost) {
                score -= cost;
                if (upg.isClickUpgrade) ppc += (upg.basePower * bulkAmount); else vps += (upg.basePower * bulkAmount);
                upg.owned += bulkAmount; totalUpgrades += bulkAmount;
                for(let i=0; i<bulkAmount; i++) upg.cost = Math.ceil(upg.cost * 1.15);
                updateUI(); playSfx(); checkAchievements();
            }
        };

        window.clickVraj = (e) => {
            const now = Date.now();
            if (lastClickTime !== 0) {
                const diff = now - lastClickTime;
                clickIntervals.push(diff);
                if (clickIntervals.length > 30) {
                    clickIntervals.shift();
                    const avg = clickIntervals.reduce((a,b) => a+b) / clickIntervals.length;
                    const variance = clickIntervals.reduce((a,b) => a + Math.pow(b - avg, 2), 0) / clickIntervals.length;
                    if (variance < 6) { 
                        if (!hasWarned) { window.showAlert("‚ö†Ô∏è Anti-Cheat", "Bot behavior detected. Please click manually."); hasWarned = true; clickIntervals = []; return; } 
                        else { signOut(auth).then(() => location.reload()); return; } 
                    }
                }
            }
            lastClickTime = now; totalClicks++;
            const gain = ppc * getTotalMultiplier();
            score += gain; totalVrajs += gain; playSfx(); updateUI(); checkAchievements();
            
            const text = document.createElement('div');
            text.className = 'float-text'; text.innerText = '+' + Math.floor(gain).toLocaleString();
            const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            text.style.left = (clientX - 10) + 'px'; text.style.top = (clientY - 20) + 'px';
            document.body.appendChild(text); setTimeout(() => text.remove(), 2000); // 2s duration
        };

        function getPrestigeData() {
            let tempScore = score; let tempPrestige = prestigeCount; let levelsToGain = 0;
            while (true) {
                let cost = 10000 * Math.pow(1.5, tempPrestige);
                if (tempScore >= cost) { tempScore -= cost; tempPrestige++; levelsToGain++; } 
                else { return { gain: levelsToGain, remaining: tempScore, nextCost: cost, percent: Math.min((tempScore / cost) * 100, 100) }; }
            }
        }

        window.openPrestigeModal = () => {
            const pData = getPrestigeData();
            if (pData.gain === 0) return;
            window.showAlert("Ascend to the Heavens?", `You are about to gain <span class="text-purple-400 font-bold">${pData.gain} Fatflap(s)</span>.<br><br>Each Fatflap gives a <b>50% permanent boost</b>.<br><br>Ascending will <b>RESET</b> all your Vrajs and standard Upgrades.`, () => handlePrestige(), true);
        };

        window.handlePrestige = () => {
            const pData = getPrestigeData();
            if (pData.gain > 0) {
                fatflaps += pData.gain; prestigeCount += pData.gain;
                score = 0; vps = 0; ppc = 1;
                upgrades.forEach((u, i) => {
                    u.owned = 0; u.cost = u.baseCost;
                    if (ownedPrestigeUpgrades.includes("p3") && i === 0) {
                        u.owned = 50; for(let k=0; k<50; k++) u.cost = Math.ceil(u.cost * 1.15);
                        vps += (u.basePower * 50);
                    }
                });
                updateUI(); renderPrestigeShop();
            }
        };

        window.triggerAccountReset = () => {
            window.showAlert("üíÄ EXTREME RESET", `This will delete ALL Vrajs, Upgrades, Fatflaps, and Achievements.<br><br>To confirm, type your username: <b class='text-red-400'>${currentUsername}</b>`, () => executeFullReset(), true, true);
        };

        async function executeFullReset() { if(currentUser && !currentUser.isAnonymous) { await deleteDoc(doc(db, "leaderboard", currentUser.uid)); } location.reload(); }

        window.buyPrestigeUpgrade = (id) => {
            const upg = prestigeUpgradeData.find(u => u.id === id);
            if (fatflaps >= upg.cost && !ownedPrestigeUpgrades.includes(id)) {
                fatflaps -= upg.cost; ownedPrestigeUpgrades.push(id);
                renderPrestigeShop(); updateUI();
            }
        };

        function renderPrestigeShop() {
            const list = document.getElementById('prestige-shop-list');
            list.innerHTML = prestigeUpgradeData.map(u => {
                const isOwned = ownedPrestigeUpgrades.includes(u.id);
                return `<div onclick="${isOwned ? '' : `buyPrestigeUpgrade('${u.id}')`}" class="prestige-card glass p-4 flex justify-between items-center ${isOwned ? 'opacity-50' : (fatflaps < u.cost ? 'disabled' : '')}"><div class="flex items-center gap-3"><span class="text-2xl">${u.emoji}</span><div><p class="font-bold text-sm text-purple-300">${u.name}</p><p class="text-[9px] opacity-60">${u.desc}</p></div></div><div class="text-right"><p class="text-xs font-bold text-yellow-500">${isOwned ? 'OWNED' : u.cost + ' ü•û'}</p></div></div>`;
            }).join('');
        }

        window.setTheme = (theme) => {
            document.body.className = `select-none theme-${theme}`;
            activeTheme = theme;
            
            const canvas = document.getElementById('galaxy-canvas');
            if (theme === 'milkyway') {
                initGalaxy();
                if(canvas) {
                    canvas.classList.remove('hidden');
                    galaxyActive = true;
                    animateGalaxy();
                }
            } else {
                if(canvas) {
                    canvas.classList.add('hidden');
                    galaxyActive = false;
                }
            }

            initThemeEffects(theme);
            renderStylePanel();
        };

        function initThemeEffects(theme) {
            const container = document.getElementById('theme-overlay');
            container.innerHTML = '';
            
            if(['nature', 'snowy', 'sea', 'starry'].includes(theme)) {
                const count = theme === 'starry' ? 100 : 30;
                for(let i=0; i<count; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    const left = Math.random() * 100;
                    
                    // Fixed particle clipping by randomizing start delay and using negative delay to pre-warm animation
                    const delay = -(Math.random() * 15); 
                    
                    p.style.left = left + '%';
                    p.style.animationDelay = delay + 's';
                    
                    if(theme === 'nature') {
                        const types = ['üçÇ','üçÉ','üçÅ'];
                        p.innerText = types[Math.floor(Math.random()*3)];
                        p.className += ' nature-leaf';
                        p.style.fontSize = (Math.random() * 15 + 10) + 'px';
                    } else if(theme === 'snowy') {
                        p.innerText = '‚ùÑÔ∏èsnow';
                        p.className += ' snow-flake';
                        const s = Math.random() * 10 + 5;
                        p.style.fontSize = s + 'px';
                    } else if(theme === 'sea') {
                        p.innerText = 'üîµ';
                        p.className += ' sea-bubble';
                        const s = Math.random() * 15 + 5;
                        p.style.fontSize = s + 'px';
                    } else if(theme === 'starry') {
                        p.className = 'star';
                        const s = Math.random() * 3 + 1;
                        p.style.width = s + 'px'; p.style.height = s + 'px';
                        p.style.top = Math.random() * 100 + '%';
                        const roll = Math.random();
                        let color = roll < 0.75 ? '#ffffff' : (roll < 0.9 ? '#6366f1' : '#f87171');
                        p.style.backgroundColor = color;
                        p.style.boxShadow = `0 0 ${s*4}px ${color}`;
                    }
                    container.appendChild(p);
                }
            }
        }

        function renderStylePanel() {
            const list = document.getElementById('style-list');
            if (currentStyleTab === 'themes') {
                const themes = [
                    { id: 'milkyway', name: 'Milky Way', emoji: 'üåå' },
                    { id: 'classic', name: 'Classic Dark', emoji: 'üåë' },
                    { id: 'light', name: 'Clean Light', emoji: '‚òÄÔ∏è' },
                    { id: 'midnight', name: 'Midnight Deep', emoji: 'üåå' },
                    { id: 'red', name: 'Crimson', emoji: 'üî¥' },
                    { id: 'orange', name: 'Sunset', emoji: 'üü†' },
                    { id: 'yellow', name: 'Golden', emoji: 'üü°' },
                    { id: 'green', name: 'Emerald', emoji: 'üü¢' },
                    { id: 'blue', name: 'Oceanic Blue', emoji: 'üîµ' },
                    { id: 'pink', name: 'Rose Petal', emoji: 'üå∏' },
                    { id: 'purple', name: 'Royal', emoji: 'üü£' },
                    { id: 'starry', name: 'Starry Sky', emoji: '‚ú®' },
                    { id: 'nature', name: 'Nature Forest', emoji: 'üåø' },
                    { id: 'sea', name: 'Deep Sea', emoji: 'üåä' },
                    { id: 'snowy', name: 'Snowy Peak', emoji: '‚ùÑÔ∏è' }
                ];
                list.innerHTML = themes.map(t => `
                    <div onclick="setTheme('${t.id}')" class="theme-card glass p-4 flex justify-between items-center ${activeTheme === t.id ? 'active' : ''}">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${t.emoji}</span>
                            <div>
                                <p class="font-bold text-sm">${t.name}</p>
                                <p class="text-[9px] opacity-60">Visual overhaul for the game.</p>
                            </div>
                        </div>
                        <span class="font-bold text-xs">${activeTheme === t.id ? 'EQUIPPED' : 'EQUIP'}</span>
                    </div>
                `).join('');
            } else {
                list.innerHTML = `<div class="p-8 text-center opacity-50 text-xs font-bold uppercase tracking-widest">Available in future updates</div>`;
            }
        }

        window.trackSettingClick = () => { settingsClicked++; };

        function checkAchievements() {
            let changed = false;
            achievements.forEach(ach => {
                if (ach.unlocked) return;
                let meets = false;
                if (ach.type === 'clicks' && totalClicks >= ach.target) meets = true;
                if (ach.type === 'upgrade' && upgrades[ach.upgIdx].owned >= ach.target) meets = true;
                if (meets) { ach.unlocked = true; changed = true; }
            });
            if (changed) renderAchievements();
        }

        function updateStatsUI() {
            document.getElementById('stat-total-mult').innerText = getTotalMultiplier().toFixed(1) + "x";
            document.getElementById('stat-total-vrajs').innerText = Math.floor(totalVrajs).toLocaleString();
            document.getElementById('stat-manual-clicks').innerText = totalClicks.toLocaleString();
            document.getElementById('stat-upgrades-bought').innerText = totalUpgrades.toLocaleString();
            document.getElementById('stat-golden-caught').innerText = goldenVrajsCaught.toLocaleString();
            document.getElementById('stat-fatflaps').innerText = fatflaps.toLocaleString();
            document.getElementById('stat-prestige-count').innerText = prestigeCount.toLocaleString();
        }

        function renderAchievements() {
            const list = document.getElementById('ach-list');
            const completed = achievements.filter(a => a.unlocked).length;
            const total = achievements.length;
            document.getElementById('ach-count').innerText = completed;
            document.getElementById('ach-total').innerText = total;
            document.getElementById('ach-progress-bar').style.width = `${(completed/total)*100}%`;
            list.innerHTML = achievements.map(ach => `
                <div class="ach-card glass p-3 flex items-center justify-between ${ach.unlocked ? 'unlocked' : 'locked'}">
                    <div><p class="text-xs font-bold">${ach.title}</p><p class="text-[9px] opacity-60">${ach.desc}</p></div>
                    ${ach.unlocked ? '<span class="text-emerald-400">‚úÖ</span>' : '<span class="opacity-30">üîí</span>'}
                </div>`).join('');
        }

        function spawnGoldenVraj() {
            if (document.querySelector('.golden-vraj')) return;
            const golden = document.createElement('img'); golden.src = 'image_0.png'; golden.className = 'golden-vraj';
            golden.onclick = (e) => { e.stopPropagation(); goldenVrajsCaught++; activateMultiplier(); golden.remove(); };
            document.body.appendChild(golden); setTimeout(() => { if(golden) golden.remove(); }, 10000);
        }

        function activateMultiplier() { goldenMultiplier = 2; multTimeRemaining = 180; document.getElementById('multiplier-display').classList.remove('hidden'); updateUI(); }

        setInterval(() => {
            timePlayed++;
            if (multTimeRemaining > 0) {
                multTimeRemaining--;
                const mins = Math.floor(multTimeRemaining / 60); const secs = multTimeRemaining % 60;
                document.getElementById('mult-timer').innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
                if (multTimeRemaining === 0) { goldenMultiplier = 1; document.getElementById('multiplier-display').classList.add('hidden'); updateUI(); }
            }
            if (Math.random() < (ownedPrestigeUpgrades.includes("p2") ? 0.01 : 0.005)) spawnGoldenVraj();
            
            const pData = getPrestigeData();
            const bar = document.getElementById('prestige-bar');
            if(bar) {
                bar.style.width = pData.percent + '%';
                document.getElementById('prestige-percent').innerText = Math.floor(pData.percent) + '%';
                document.getElementById('prestige-gain-display').innerText = `(+${pData.gain} Fatflaps)`;
                document.getElementById('prestige-btn').disabled = pData.gain === 0;
                document.getElementById('next-prestige-cost').innerText = Math.floor(pData.nextCost).toLocaleString();
            }
        }, 1000);

        function updateUI() {
            const totalMult = getTotalMultiplier();
            document.getElementById('score').innerText = Math.floor(score).toLocaleString();
            document.getElementById('vps-display').innerText = (vps * totalMult).toLocaleString(undefined, {minimumFractionDigits: 1}) + " VPS";
            document.getElementById('ppc-display').innerText = (ppc * totalMult).toLocaleString(undefined, {maximumFractionDigits: 0}) + " Points Per Click";
            document.getElementById('icon-mult-display').innerText = totalMult.toFixed(1) + "x";
            
            if (fatflaps > 0 || prestigeCount > 0) {
                document.getElementById('fatflap-display').classList.remove('hidden');
                document.getElementById('fatflap-count').innerText = fatflaps.toLocaleString();
            }
            upgrades.forEach(u => {
                const el = document.getElementById(`upg-${u.id}`);
                if (el) {
                    const bCost = getBulkCost(u.cost, bulkAmount);
                    el.classList.toggle('disabled', score < bCost);
                    document.getElementById(`cost-${u.id}`).innerText = bCost.toLocaleString();
                    document.getElementById(`owned-${u.id}`).innerText = u.owned.toLocaleString();
                }
            });
        }

        function renderShop() {
            const shop = document.getElementById('shop-list');
            const filtered = upgrades.filter(u => currentShopTab === 'clicker' ? u.isClickUpgrade : !u.isClickUpgrade);
            shop.innerHTML = filtered.map(u => `
                <div id="upg-${u.id}" onclick="buyUpgrade(${u.id})" class="upgrade-card glass p-4 flex justify-between items-center disabled">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${u.emoji}</span>
                        <div>
                            <p class="font-bold text-sm">${u.name}</p>
                            <p class="text-[10px] text-emerald-400">+${u.basePower.toLocaleString()} ${u.isClickUpgrade?'PPC':'VPS'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-bold opacity-80" id="cost-${u.id}">${u.cost.toLocaleString()}</p>
                        <p class="text-[9px] opacity-60">Owned: <span id="owned-${u.id}">${u.owned}</span></p>
                    </div>
                </div>`).join('');
        }

        setInterval(() => { if (vps > 0) { score += (vps * getTotalMultiplier()) / 10; updateUI(); } }, 100);

        window.switchTab = (t) => {
            document.getElementById('login-form').classList.toggle('hidden', t !== 'login');
            document.getElementById('signup-form').classList.toggle('hidden', t !== 'signup');
            document.getElementById('tab-login').classList.toggle('bg-blue-600', t === 'login');
            document.getElementById('tab-signup').classList.toggle('bg-blue-600', t === 'signup');
        };

        window.handleSignup = async () => {
            const u = document.getElementById('su-username').value, e = document.getElementById('su-email').value, p = document.getElementById('su-password').value;
            try { const c = await createUserWithEmailAndPassword(auth, e, p); await setDoc(doc(db, "users", c.user.uid), { username: u }); await sendEmailVerification(c.user); window.showAlert("Success", "Check email for verification."); } catch (err) { window.showAlert("Error", err.message); }
        };
        window.handleLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('li-email').value, document.getElementById('li-password').value); } catch (err) { window.showAlert("Error", err.message); } };
        window.handleGuest = () => signInAnonymously(auth);
        window.logoutAction = () => window.showAlert("Logout", "Are you sure you want to sign out?", () => signOut(auth), true);

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                if (!user.isAnonymous && !user.emailVerified) { document.getElementById('verify-notice').classList.remove('hidden'); document.getElementById('login-form').classList.add('hidden'); document.getElementById('auth-tabs').classList.add('hidden'); } 
                else {
                    document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('game-screen').classList.remove('hidden');
                    if(user.isAnonymous) { currentUsername = "Guest_" + user.uid.substring(0,4); } 
                    else {
                        const snap = await getDoc(doc(db, "users", user.uid)); currentUsername = snap.exists() ? snap.data().username : "Vraj";
                        const save = await getDoc(doc(db, "leaderboard", user.uid)); 
                        if(save.exists()){ 
                            const d = save.data(); score = d.score || 0; vps = d.vps || 0; ppc = d.ppc || 1; totalVrajs = d.totalVrajs || 0; totalClicks = d.totalClicks || 0; totalUpgrades = d.totalUpgrades || 0; goldenVrajsCaught = d.goldenVrajsCaught || 0; timePlayed = d.timePlayed || 0; prestigeCount = d.prestigeCount || 0; fatflaps = d.fatflaps || 0; ownedPrestigeUpgrades = d.ownedPrestigeUpgrades || [];
                            if(d.upgStates) d.upgStates.forEach((s, i) => { if(upgrades[i]) { upgrades[i].owned = s.owned; upgrades[i].cost = s.cost; } });
                            if(d.achStates) achievements.forEach((a, i) => { if(d.achStates[i]) a.unlocked = d.achStates[i]; });
                            if(d.activeTheme) setTheme(d.activeTheme);
                        }
                    }
                    document.getElementById('user-display').innerText = currentUsername; 
                    renderShop(); renderAchievements(); renderPrestigeShop(); updateUI();
                    
                    setInterval(() => { if(currentUser && !currentUser.isAnonymous) {
                        setDoc(doc(db, "leaderboard", currentUser.uid), { score, vps, ppc, totalVrajs, totalClicks, totalUpgrades, goldenVrajsCaught, timePlayed, username: currentUsername, upgStates: upgrades.map(u => ({ owned: u.owned, cost: u.cost })), achStates: achievements.map(a => a.unlocked), prestigeCount, fatflaps, ownedPrestigeUpgrades, activeTheme }, { merge: true }); 
                    }}, 10000);
                    onSnapshot(query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(10)), (s) => {
                        document.getElementById('leaderboard-list').innerHTML = s.docs.map((d, i) => {
                            const dData = d.data(); 
                            let rankClass = ""; 
                            let medal = "";
                            if (i === 0) { rankClass = "lb-rank-1"; medal = "ü•á"; }
                            else if (i === 1) { rankClass = "lb-rank-2"; medal = "ü•à"; }
                            else if (i === 2) { rankClass = "lb-rank-3"; medal = "ü•â"; }
                            
                            return `<div class="lb-card p-3 flex items-center justify-between mb-2 ${rankClass}"><div class="flex items-center gap-3"><span class="text-xs font-black">#${i+1} ${medal}</span><div><p class="text-xs font-bold">${dData.username}</p><p class="text-[9px] opacity-60 font-bold">${(dData.prestigeCount || 0)} Ascensions</p></div></div><div class="text-right"><p class="text-xs font-black text-blue-400">${Math.floor(dData.score).toLocaleString()}</p></div></div>`;
                        }).join('');
                    });
                    onSnapshot(query(collection(db, "globalChat"), orderBy("timestamp", "desc"), limit(20)), (s) => {
                        document.getElementById('chat-box').innerHTML = s.docs.map(d => `<div class="mb-1"><span class="text-emerald-400 font-bold">${d.data().username}:</span> ${d.data().text}</div>`).join('');
                    });
                }
            } else { document.getElementById('auth-screen').classList.remove('hidden'); document.getElementById('game-screen').classList.add('hidden'); }
        });

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault(); const input = document.getElementById('chat-input'); if(!input.value.trim()) return;
            await addDoc(collection(db, "globalChat"), { text: input.value, username: currentUsername, timestamp: serverTimestamp() }); 
            chatsSent++; input.value = "";
        };
    </script>
</body>
</html>
