<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vraj Clicker 2</title>
    <link rel="icon" type="image/png" href="image_0.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background: #070b14; color: #e2e8f0; margin: 0; height: 100vh; width: 100vw; overflow: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .game-grid { display: grid; grid-template-columns: 350px 1fr 350px; grid-template-rows: 1fr; height: 100vh; gap: 1.5rem; padding: 1.5rem; box-sizing: border-box; }
        .left-area { position: relative; height: 100%; min-height: 0; }
        .center-area { display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 1rem 0; height: 100%; }
        .right-area { display: flex; flex-direction: column; gap: 1rem; height: 100%; overflow: hidden; }
        .scroll-panel { overflow-y: auto; flex-grow: 1; scrollbar-width: thin; scrollbar-color: #3b82f6 transparent; }
        .scroll-panel::-webkit-scrollbar { width: 4px; }
        .scroll-panel::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
        .side-tabs-container { position: absolute; right: -32px; top: 50px; display: flex; flex-direction: column; gap: 10px; z-index: 20; }
        .side-tab { background: rgba(15, 23, 42, 0.98); border: 1px solid rgba(255, 255, 255, 0.1); border-left: none; padding: 15px 8px; border-radius: 0 12px 12px 0; cursor: pointer; writing-mode: vertical-lr; text-orientation: mixed; font-size: 10px; font-weight: 800; color: #475569; transition: all 0.2s; }
        .side-tab.active { background: #3b82f6; color: white; transform: translateX(5px); }
        .click-btn-container { transition: transform 0.05s active; cursor: pointer; user-select: none; position: relative; }
        .click-btn-container:active { transform: scale(0.95); }
        .click-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; pointer-events: none; }
        .upgrade-card, .ach-card, .prestige-card { transition: all 0.2s; border: 1px solid rgba(255,255,255,0.05); border-radius: 1rem; }
        .upgrade-card:hover:not(.disabled), .prestige-card:hover:not(.disabled) { background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); cursor: pointer; }
        .upgrade-card.disabled, .prestige-card.disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(1); }
        .ach-card.locked { opacity: 0.3; filter: grayscale(1); }
        .ach-card.unlocked { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.4); box-shadow: 0 0 10px rgba(16, 185, 129, 0.1); }
        .stat-row { display: flex; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .hidden { display: none !important; }
        .bulk-btn.active { background: #3b82f6; color: white; }
        .float-text { position: absolute; color: #60a5fa; font-weight: 800; pointer-events: none; animation: floatUp 0.8s ease-out forwards; z-index: 100; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }
        .golden-vraj { position: absolute; width: 80px; height: 80px; cursor: pointer; z-index: 50; filter: drop-shadow(0 0 15px gold) brightness(1.5); animation: goldenFly 10s linear forwards; }
        @keyframes goldenFly { 0% { left: -100px; top: 20%; } 100% { left: 110vw; top: 60%; } }
        #multiplier-display { position: fixed; bottom: 2rem; right: 380px; z-index: 60; }
        .prestige-btn { background: linear-gradient(135deg, #7c3aed, #3b82f6); border: 2px solid rgba(255,255,255,0.2); }
        .prestige-btn:disabled { background: #1e293b; opacity: 0.5; cursor: not-allowed; }
        .lb-card { background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%); border: 1px solid rgba(255,255,255,0.05); }
        .rank-1 { border-color: rgba(255, 215, 0, 0.5) !important; background: linear-gradient(90deg, rgba(255, 215, 0, 0.1) 0%, transparent 100%) !important; box-shadow: 0 0 15px rgba(255, 215, 0, 0.1); }
        .rank-1 .rank-text { color: #ffd700 !important; }
        .rank-2 { border-color: rgba(192, 192, 192, 0.5) !important; background: linear-gradient(90deg, rgba(192, 192, 192, 0.1) 0%, transparent 100%) !important; }
        .rank-2 .rank-text { color: #e5e7eb !important; }
        .rank-3 { border-color: rgba(205, 127, 50, 0.5) !important; background: linear-gradient(90deg, rgba(205, 127, 50, 0.1) 0%, transparent 100%) !important; }
        .rank-3 .rank-text { color: #cd7f32 !important; }

        #game-modal { z-index: 1000; position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
    </style>
</head>
<body class="select-none">

    <div id="game-modal" class="hidden">
        <div class="glass p-8 rounded-3xl max-w-md w-full border-white/20 shadow-2xl">
            <h2 id="modal-title" class="text-2xl font-black mb-4 text-blue-400">Title</h2>
            <div id="modal-content" class="text-sm text-gray-300 mb-8 leading-relaxed">Content</div>
            <div id="modal-footer" class="flex gap-4">
                <button id="modal-cancel" class="flex-1 py-3 bg-gray-800 rounded-xl font-bold">Cancel</button>
                <button id="modal-confirm" class="flex-1 py-3 bg-blue-600 rounded-xl font-bold">Confirm</button>
            </div>
        </div>
    </div>

    <div id="multiplier-display" class="hidden">
        <div class="glass p-3 rounded-2xl border-yellow-500/50 border flex items-center gap-3">
            <span class="text-2xl">üåü</span>
            <div>
                <p class="text-xs font-bold text-yellow-400">2X MULTI ACTIVE</p>
                <p id="mult-timer" class="text-lg font-black text-white">03:00</p>
            </div>
        </div>
    </div>

    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass p-8 rounded-3xl shadow-2xl w-full max-w-md text-center">
            <h1 class="text-4xl font-extrabold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">Vraj Clicker 2</h1>
            <div id="auth-tabs" class="flex mb-6 bg-gray-800/50 rounded-lg p-1">
                <button onclick="switchTab('login')" id="tab-login" class="flex-1 py-2 rounded-md font-semibold bg-blue-600">Login</button>
                <button onclick="switchTab('signup')" id="tab-signup" class="flex-1 py-2 rounded-md font-semibold text-gray-400">Sign Up</button>
            </div>
            <div id="login-form" class="space-y-4">
                <input type="email" id="li-email" placeholder="Email" class="w-full p-4 rounded-xl bg-gray-900 border border-gray-700 outline-none">
                <input type="password" id="li-password" placeholder="Password" class="w-full p-4 rounded-xl bg-gray-900 border border-gray-700 outline-none">
                <button onclick="handleLogin()" class="w-full bg-blue-600 p-4 rounded-xl font-bold">Enter Game</button>
                <button onclick="handleGuest()" class="w-full bg-gray-700 p-4 rounded-xl font-bold text-sm">Play as Guest</button>
            </div>
            <div id="signup-form" class="hidden space-y-4">
                <input type="text" id="su-username" placeholder="Username" class="w-full p-4 rounded-xl bg-gray-900 border border-gray-700 outline-none">
                <input type="email" id="su-email" placeholder="Email" class="w-full p-4 rounded-xl bg-gray-900 border border-gray-700 outline-none">
                <input type="password" id="su-password" placeholder="Password" class="w-full p-4 rounded-xl bg-gray-900 border border-gray-700 outline-none">
                <button onclick="handleSignup()" class="w-full bg-emerald-600 p-4 rounded-xl font-bold">Create Account</button>
            </div>
            <div id="verify-notice" class="hidden py-6">
                <h2 class="text-xl font-bold text-yellow-400">Check Email</h2>
                <button onclick="location.reload()" class="bg-blue-600 p-3 rounded-xl font-bold w-full mt-4">I've Verified</button>
            </div>
        </div>
    </div>

    <div id="game-screen" class="hidden h-screen overflow-hidden">
        <div class="game-grid">
            <div class="left-area">
                <div class="glass rounded-3xl flex flex-col h-full overflow-hidden relative z-10 bg-[#070b14]/90">
                    <div id="panel-shop" class="left-panel-content flex flex-col h-full overflow-hidden">
                        <div class="p-4 border-b border-white/10 bg-white/5 space-y-3 flex-shrink-0">
                            <h3 class="font-bold text-blue-400">üè™ Vraj Shop</h3>
                            <div class="flex bg-black/40 rounded-lg p-1 text-[10px] font-bold">
                                <button onclick="setBulk(1)" id="bulk-1" class="bulk-btn flex-1 py-1 rounded active">1X</button>
                                <button onclick="setBulk(10)" id="bulk-10" class="bulk-btn flex-1 py-1 rounded">10X</button>
                                <button onclick="setBulk(100)" id="bulk-100" class="bulk-btn flex-1 py-1 rounded">100X</button>
                            </div>
                        </div>
                        <div id="shop-list" class="scroll-panel p-4 space-y-3"></div>
                    </div>
                    
                    <div id="panel-prestige" class="left-panel-content hidden h-full flex flex-col overflow-hidden">
                        <div class="p-6 border-b border-white/10 bg-white/5 flex-shrink-0 text-center">
                            <h3 class="font-bold text-purple-400 text-xl mb-2">üìà Ascension</h3>
                            <p class="text-[10px] text-gray-400 uppercase font-bold mb-4">Reset progress for permanent power</p>
                            
                            <div class="w-full bg-black/40 h-6 rounded-full overflow-hidden border border-white/10 relative mb-4">
                                <div id="prestige-bar" class="h-full bg-gradient-to-r from-purple-600 to-blue-500 transition-all duration-500" style="width: 0%"></div>
                                <span id="prestige-percent" class="absolute inset-0 flex items-center justify-center text-[10px] font-black text-white">0%</span>
                            </div>

                            <button id="prestige-btn" onclick="openPrestigeModal()" class="prestige-btn w-full py-4 rounded-2xl font-black text-white shadow-lg transform active:scale-95 transition-all">
                                ASCEND <span id="prestige-gain-display">(+0 Fatflaps)</span>
                            </button>
                            <p class="text-[9px] text-gray-500 mt-2 italic">Goal for Next Level: <span id="next-prestige-cost">10,000</span></p>
                        </div>
                        <div class="p-4 bg-white/5 border-b border-white/10"><h4 class="text-xs font-bold text-purple-300 uppercase tracking-widest">Heavenly Upgrades</h4></div>
                        <div id="prestige-shop-list" class="scroll-panel p-4 space-y-3"></div>
                    </div>

                    <div id="panel-achievements" class="left-panel-content hidden h-full flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-white/10 bg-white/5 flex-shrink-0">
                            <h3 class="font-bold text-purple-400 mb-2">üèÜ Achievements</h3>
                            <div class="w-full bg-black/40 h-4 rounded-full overflow-hidden border border-white/5">
                                <div id="ach-progress-bar" class="h-full bg-gradient-to-r from-purple-500 to-blue-500 transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <p class="text-[10px] font-bold text-gray-400 mt-1 uppercase tracking-widest text-right">
                                Completed: <span id="ach-count" class="text-white">0</span> / <span id="ach-total">0</span>
                            </p>
                        </div>
                        <div id="ach-list" class="scroll-panel p-4 space-y-2"></div>
                    </div>

                    <div id="panel-stats" class="left-panel-content hidden h-full flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-white/10 bg-white/5 flex-shrink-0">
                            <h3 class="font-bold text-emerald-400">üìä Statistics</h3>
                        </div>
                        <div class="scroll-panel p-2 space-y-1 text-sm">
                            <div class="stat-row"><span>Fatflaps (Prestige)</span><span id="stat-fatflaps" class="text-purple-400 font-bold">0</span></div>
                            <div class="stat-row"><span>Total Ascensions</span><span id="stat-prestige-count" class="text-purple-400 font-bold">0</span></div>
                            <div class="stat-row"><span>Total Vrajs Collected</span><span id="stat-total-vrajs" class="text-blue-400 font-bold">0</span></div>
                            <div class="stat-row"><span>Manual Clicks</span><span id="stat-manual-clicks" class="text-blue-400 font-bold">0</span></div>
                            <div class="stat-row"><span>Upgrades Bought</span><span id="stat-upgrades-bought" class="text-blue-400 font-bold">0</span></div>
                            <div class="stat-row"><span>Golden Vrajs Caught</span><span id="stat-golden-caught" class="text-blue-400 font-bold">0</span></div>
                            <div class="stat-row"><span>Global Chats Sent</span><span id="stat-chats-sent" class="text-blue-400 font-bold">0</span></div>
                            <div class="stat-row"><span>Time Played</span><span id="stat-time-played" class="text-blue-400 font-bold">0m</span></div>
                        </div>
                    </div>

                    <div id="panel-settings" class="left-panel-content hidden h-full p-6 flex flex-col justify-between">
                        <div>
                            <h3 class="font-bold text-gray-400 text-xl mb-4">‚öôÔ∏è Settings</h3>
                            <div class="space-y-4">
                                <button onclick="trackSettingClick()" class="w-full p-3 glass rounded-xl text-left text-sm hover:bg-white/5 transition">Check for Updates</button>
                                <button onclick="trackSettingClick()" class="w-full p-3 glass rounded-xl text-left text-sm hover:bg-white/5 transition">Toggle Particles</button>
                            </div>
                        </div>
                        <button onclick="logoutAction()" class="w-full bg-red-500/10 text-red-500 p-4 rounded-xl font-bold border border-red-500/20">Sign Out</button>
                    </div>
                </div>
                <div class="side-tabs-container">
                    <div id="tab-shop" onclick="switchSideTab('shop')" class="side-tab active">SHOP</div>
                    <div id="tab-prestige" onclick="switchSideTab('prestige')" class="side-tab">ASCEND</div>
                    <div id="tab-achievements" onclick="switchSideTab('achievements')" class="side-tab">GOALS</div>
                    <div id="tab-stats" onclick="switchSideTab('stats')" class="side-tab">STATS</div>
                    <div id="tab-settings" onclick="switchSideTab('settings')" class="side-tab">SYSTEM</div>
                </div>
            </div>

            <div class="center-area">
                <div class="text-center">
                    <div id="fatflap-display" class="mb-2 flex items-center justify-center gap-2 hidden">
                        <span class="text-2xl">ü•û</span>
                        <span id="fatflap-count" class="text-2xl font-black text-purple-400">0</span>
                        <span class="text-[10px] font-bold text-purple-500/80 uppercase">Fatflaps</span>
                    </div>

                    <h2 id="score" class="text-7xl font-black text-blue-400 drop-shadow-lg">0</h2>
                    <p id="vps-display" class="text-emerald-400 font-bold tracking-widest text-sm uppercase">0 VPS</p>
                    <p id="ppc-display" class="text-blue-300 font-bold text-[10px] mt-1">1 Points Per Click</p>
                </div>
                <div id="clicker-container" onclick="clickVraj(event)" class="click-btn-container w-[450px] h-[450px] rounded-full p-1 bg-gradient-to-tr from-blue-500 via-purple-500 to-pink-500 shadow-2xl">
                    <div class="w-full h-full rounded-full overflow-hidden border-8 border-[#070b14]">
                        <img src="image_0.png" class="click-img">
                    </div>
                </div>
                <div class="w-full max-w-xs text-center">
                    <div class="glass p-3 rounded-2xl text-xs text-gray-400">User: <span id="user-display" class="text-blue-300 font-bold">...</span></div>
                </div>
            </div>

            <div class="right-area">
                <div class="glass rounded-3xl flex-1 flex flex-col overflow-hidden min-h-0">
                    <div class="p-4 border-b border-white/10 bg-white/5 font-bold text-purple-400 flex-shrink-0">üèÜ Leaderboard</div>
                    <div id="leaderboard-list" class="scroll-panel p-4 space-y-2"></div>
                </div>
                <div class="glass rounded-3xl flex-1 flex flex-col overflow-hidden min-h-0">
                    <div class="p-4 border-b border-white/10 bg-white/5 font-bold text-emerald-400 flex-shrink-0">üí¨ Global Chat</div>
                    <div id="chat-box" class="scroll-panel p-4 flex flex-col-reverse text-sm"></div>
                    <form id="chat-form" class="p-3 bg-white/5 border-t border-white/10 flex gap-2 flex-shrink-0">
                        <input type="text" id="chat-input" placeholder="Type..." class="flex-grow bg-gray-900 border border-gray-700 p-2 rounded-lg text-xs outline-none">
                        <button class="bg-emerald-600 px-3 py-2 rounded-lg text-xs font-bold">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously, onAuthStateChanged, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDwg2ZSpQspAD-o19AZCOHcrl9VnYc_sdk", authDomain: "vraj-clicker-2.firebaseapp.com", projectId: "vraj-clicker-2", storageBucket: "vraj-clicker-2.firebasestorage.app", messagingSenderId: "162243172716", appId: "1:162243172716:web:874a1f8be471a9f0d83b49" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const clickSound = new Audio('click.mp3');
        function playSfx() { clickSound.currentTime = 0; clickSound.play().catch(()=>{}); }

        window.showAlert = (title, content, onConfirm = null, isConfirm = false) => {
            const modal = document.getElementById('game-modal');
            const titleEl = document.getElementById('modal-title');
            const contentEl = document.getElementById('modal-content');
            const cancelBtn = document.getElementById('modal-cancel');
            const confirmBtn = document.getElementById('modal-confirm');
            titleEl.innerText = title;
            contentEl.innerHTML = content;
            modal.classList.remove('hidden');
            cancelBtn.classList.toggle('hidden', !isConfirm);
            cancelBtn.onclick = () => modal.classList.add('hidden');
            confirmBtn.onclick = () => { modal.classList.add('hidden'); if(onConfirm) onConfirm(); };
        };

        let score = 0, vps = 0, ppc = 1, bulkAmount = 1;
        let totalVrajs = 0, totalClicks = 0, totalUpgrades = 0, settingsClicked = 0, goldenVrajsCaught = 0, chatsSent = 0, currentRank = 999, timePlayed = 0;
        let multiplier = 1, multTimeRemaining = 0;
        let prestigeCount = 0, fatflaps = 0, ownedPrestigeUpgrades = [];
        let currentUser = null, currentUsername = "Guest";
        let clickIntervals = [], lastClickTime = 0, hasWarned = false;

        const upgradeData = [
            { name: "Vraj Finger", baseCost: 10, basePower: 0.2, emoji: "‚òùÔ∏è" },
            { name: "Vraj Sprout", baseCost: 20, basePower: 0.4, emoji: "üå±" },
            { name: "Vraj Cursor", baseCost: 50, basePower: 1, emoji: "üñ±Ô∏è" },
            { name: "Vraj Nanobots", baseCost: 80, basePower: 2, emoji: "ü§è" },
            { name: "Vraj Drone", baseCost: 120, basePower: 4, emoji: "üöÅ" },
            { name: "Vraj Magnet", baseCost: 210, basePower: 6, emoji: "üß≤" },
            { name: "Vraj Juice", baseCost: 336, basePower: 10, emoji: "üßÉ" },
            { name: "Vraj Keyboard", baseCost: 538, basePower: 15, emoji: "‚å®Ô∏è" },
            { name: "Vraj Potion", baseCost: 861, basePower: 30, emoji: "üß™" },
            { name: "Vraj Coffee", baseCost: 1378, basePower: 50, emoji: "‚òï" },
            { name: "Vraj Gear", baseCost: 2205, basePower: 100, emoji: "‚öôÔ∏è" },
            { name: "Vraj Botnet", baseCost: 3528, basePower: 120, emoji: "üåê" },
            { name: "Vraj Tuner", baseCost: 5645, basePower: 150, emoji: "üéöÔ∏è" },
            { name: "Vraj Garden", baseCost: 9032, basePower: 170, emoji: "üåø" },
            { name: "Vraj Typist", baseCost: 14451, basePower: 200, emoji: "üíª" },
            { name: "Vraj Swarm", baseCost: 23122, basePower: 250, emoji: "üêù" },
            { name: "Vraj Automaton", baseCost: 36995, basePower: 280, emoji: "ü§ñ" },
            { name: "Vraj Attractor", baseCost: 59192, basePower: 296, emoji: "üß≤" },
            { name: "Vraj Smoothie", baseCost: 94707, basePower: 474, emoji: "ü•§" },
            { name: "Vraj Console", baseCost: 151531, basePower: 758, emoji: "üïπÔ∏è" },
            { name: "Vraj Lab", baseCost: 242450, basePower: 1212, emoji: "‚öóÔ∏è" },
            { name: "Vraj Brewery", baseCost: 387920, basePower: 1940, emoji: "üç∫" },
            { name: "Vraj Workshop", baseCost: 620672, basePower: 3103, emoji: "üõ†Ô∏è" },
            { name: "Vraj Network", baseCost: 993075, basePower: 4965, emoji: "üì°" },
            { name: "Vraj Reactor", baseCost: 1588920, basePower: 7945, emoji: "‚öõÔ∏è" },
            { name: "Vraj Meadow", baseCost: 2542272, basePower: 12711, emoji: "üåæ" },
            { name: "Vraj Terminal", baseCost: 4067635, basePower: 20338, emoji: "üñ•Ô∏è" },
            { name: "Vraj Hive", baseCost: 6508216, basePower: 32541, emoji: "üêú" },
            { name: "Vraj Factory", baseCost: 10413146, basePower: 52066, emoji: "üè≠" },
            { name: "Vraj Collider", baseCost: 16661034, basePower: 83305, emoji: "üî¨" },
            { name: "Vraj Extract", baseCost: 26657654, basePower: 133288, emoji: "üßâ" },
            { name: "Vraj Deck", baseCost: 42652246, basePower: 213261, emoji: "üéÆ" },
            { name: "Vraj Chemworks", baseCost: 68243594, basePower: 341218, emoji: "üß´" },
            { name: "Vraj Distillery", baseCost: 109189750, basePower: 545949, emoji: "ü•É" },
            { name: "Vraj Assembly", baseCost: 174703600, basePower: 873518, emoji: "ü§ù" },
            { name: "Vraj Mainframe", baseCost: 279525760, basePower: 1397629, emoji: "üíΩ" },
            { name: "Vraj Singularity", baseCost: 447241216, basePower: 2236206, emoji: "üåÄ" },
            { name: "Vraj Forest", baseCost: 715585946, basePower: 3577930, emoji: "üå≤" },
            { name: "Vraj Supercomp", baseCost: 1144937514, basePower: 5724688, emoji: "üíæ" },
            { name: "Vraj Colony", baseCost: 1831900022, basePower: 9159501, emoji: "üêú" },
            { name: "Vraj Megaplant", baseCost: 2931040035, basePower: 14655200, emoji: "üèóÔ∏è" },
            { name: "Vraj Accelerator", baseCost: 4689664056, basePower: 23448320, emoji: "üöÄ" },
            { name: "Vraj Serum", baseCost: 7503462490, basePower: 37517312, emoji: "üíâ" },
            { name: "Vraj Interface", baseCost: 12005539984, basePower: 60027700, emoji: "üß©" },
            { name: "Vraj Genome", baseCost: 19208863974, basePower: 96044320, emoji: "üß¨" },
            { name: "Vraj Roast", baseCost: 30734182358, basePower: 153670912, emoji: "üå∞" },
            { name: "Vraj Forge", baseCost: 49174691773, basePower: 245873459, emoji: "üóúÔ∏è" },
            { name: "Vraj Datasphere", baseCost: 78679506837, basePower: 393397534, emoji: "üåê" }
        ];

        const prestigeUpgradeData = [
            { id: "p1", name: "Heavenly Clicks", cost: 1, desc: "Double base clicking power forever.", emoji: "‚ú®" },
            { id: "p2", name: "Golden Aura", cost: 2, desc: "Golden Vrajs appear twice as often.", emoji: "‚òÄÔ∏è" },
            { id: "p3", name: "Persistent Vraj", cost: 5, desc: "Start every prestige with 50 Vraj Fingers.", emoji: "ü•û" }
        ];

        const achievements = [];
        [1, 100, 500, 1000, 5000, 10000, 50000, 100000, 500000, 1000000].forEach(n => achievements.push({ id: `click-${n}`, title: `${n.toLocaleString()} Clicks`, desc: `Click the Vraj ${n.toLocaleString()} times.`, target: n, type: 'clicks', unlocked: false }));
        upgradeData.forEach((u, i) => {
            achievements.push({ id: `buy-${i}-10`, title: `${u.name} Novice`, desc: `Own 10 ${u.name}s.`, target: 10, type: 'upgrade', upgIdx: i, unlocked: false });
            achievements.push({ id: `buy-${i}-50`, title: `${u.name} Expert`, desc: `Own 50 ${u.name}s.`, target: 50, type: 'upgrade', upgIdx: i, unlocked: false });
        });

        const upgrades = upgradeData.map((u, i) => ({ id: i+1, ...u, owned: 0, cost: u.baseCost, isClickUpgrade: (i+1)%2===0 }));

        window.switchSideTab = (tab) => {
            document.querySelectorAll('.left-panel-content').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.side-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('panel-'+tab).classList.remove('hidden');
            document.getElementById('tab-'+tab).classList.add('active');
            if(tab === 'achievements') renderAchievements();
            if(tab === 'stats') updateStatsUI();
            if(tab === 'prestige') renderPrestigeShop();
        };

        window.setBulk = (amt) => { bulkAmount = amt; document.querySelectorAll('.bulk-btn').forEach(b => b.classList.remove('active')); document.getElementById('bulk-'+amt).classList.add('active'); updateUI(); };
        function getBulkCost(baseCost, count) { let total = 0; let temp = baseCost; for(let i=0; i<count; i++) { total += temp; temp = Math.ceil(temp * 1.15); } return total; }

        window.buyUpgrade = (id) => {
            const upg = upgrades.find(u => u.id === id);
            const cost = getBulkCost(upg.cost, bulkAmount);
            if (score >= cost) {
                score -= cost;
                if (upg.isClickUpgrade) ppc += (upg.basePower * bulkAmount); else vps += (upg.basePower * bulkAmount);
                upg.owned += bulkAmount; totalUpgrades += bulkAmount;
                for(let i=0; i<bulkAmount; i++) upg.cost = Math.ceil(upg.cost * 1.15);
                updateUI(); playSfx(); checkAchievements();
            }
        };

        window.clickVraj = (e) => {
            const now = Date.now();
            if (lastClickTime !== 0) {
                const diff = now - lastClickTime;
                clickIntervals.push(diff);
                if (clickIntervals.length > 30) {
                    clickIntervals.shift();
                    const avg = clickIntervals.reduce((a,b) => a+b) / clickIntervals.length;
                    const variance = clickIntervals.reduce((a,b) => a + Math.pow(b - avg, 2), 0) / clickIntervals.length;
                    if (variance < 6) { 
                        if (!hasWarned) { window.showAlert("‚ö†Ô∏è Anti-Cheat", "Bot behavior detected. Please click manually."); hasWarned = true; clickIntervals = []; return; } 
                        else { signOut(auth).then(() => location.reload()); return; } 
                    }
                }
            }
            lastClickTime = now; totalClicks++;
            const prestigeBoost = (1 + (0.5 * fatflaps));
            const p1Boost = ownedPrestigeUpgrades.includes("p1") ? 2 : 1;
            const gain = ppc * multiplier * prestigeBoost * p1Boost;
            score += gain; totalVrajs += gain; playSfx(); updateUI(); checkAchievements();
            const text = document.createElement('div');
            text.className = 'float-text'; text.innerText = '+' + Math.floor(gain).toLocaleString();
            text.style.left = (e.clientX - 10) + 'px'; text.style.top = (e.clientY - 20) + 'px';
            document.body.appendChild(text); setTimeout(() => text.remove(), 800);
        };

        function calculatePrestigeGain() {
            let tempScore = score; let tempPrestige = prestigeCount; let levelsToGain = 0;
            while (true) {
                let cost = 10000 * Math.pow(1.5, tempPrestige);
                if (tempScore >= cost) { tempScore -= cost; tempPrestige++; levelsToGain++; } else { break; }
            }
            return levelsToGain;
        }

        window.openPrestigeModal = () => {
            const gain = calculatePrestigeGain();
            if (gain === 0) return;
            const boostMsg = `Each Fatflap gives a <b>50% permanent boost</b> to VPS and Clicking Power.`;
            const resetMsg = `<br><br>Ascending will <b>RESET</b> all your Vrajs and standard Upgrades, but you keep Achievements and Heavenly Upgrades.`;
            window.showAlert("Ascend to the Heavens?", `You are about to gain <span class="text-purple-400 font-bold">${gain} Fatflap(s)</span>.<br><br>${boostMsg}${resetMsg}`, () => handlePrestige(), true);
        };

        window.handlePrestige = () => {
            const gain = calculatePrestigeGain();
            if (gain > 0) {
                fatflaps += gain; prestigeCount += gain;
                score = 0; vps = 0;
                ppc = ownedPrestigeUpgrades.includes("p1") ? 2 : 1;
                upgrades.forEach((u, i) => {
                    u.owned = 0; u.cost = u.baseCost;
                    if (ownedPrestigeUpgrades.includes("p3") && i === 0) {
                        u.owned = 50; for(let k=0; k<50; k++) u.cost = Math.ceil(u.cost * 1.15);
                        vps += (u.basePower * 50);
                    }
                });
                updateUI(); renderPrestigeShop();
            }
        };

        window.buyPrestigeUpgrade = (id) => {
            const upg = prestigeUpgradeData.find(u => u.id === id);
            if (fatflaps >= upg.cost && !ownedPrestigeUpgrades.includes(id)) {
                fatflaps -= upg.cost; ownedPrestigeUpgrades.push(id);
                renderPrestigeShop(); updateUI();
            }
        };

        function renderPrestigeShop() {
            const list = document.getElementById('prestige-shop-list');
            list.innerHTML = prestigeUpgradeData.map(u => {
                const isOwned = ownedPrestigeUpgrades.includes(u.id);
                return `
                <div onclick="${isOwned ? '' : `buyPrestigeUpgrade('${u.id}')`}" class="prestige-card glass p-4 flex justify-between items-center ${isOwned ? 'opacity-50' : (fatflaps < u.cost ? 'disabled' : '')}">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${u.emoji}</span>
                        <div><p class="font-bold text-sm text-purple-300">${u.name}</p><p class="text-[9px] text-gray-400">${u.desc}</p></div>
                    </div>
                    <div class="text-right"><p class="text-xs font-bold text-yellow-500">${isOwned ? 'OWNED' : u.cost + ' ü•û'}</p></div>
                </div>`;
            }).join('');
        }

        window.trackSettingClick = () => { settingsClicked++; checkAchievements(); };

        function checkAchievements() {
            let changed = false;
            achievements.forEach(ach => {
                if (ach.unlocked) return;
                let meets = false;
                if (ach.type === 'clicks' && totalClicks >= ach.target) meets = true;
                if (ach.type === 'upgrade' && upgrades[ach.upgIdx].owned >= ach.target) meets = true;
                if (meets) { ach.unlocked = true; changed = true; }
            });
            if (changed) renderAchievements();
        }

        function updateStatsUI() {
            document.getElementById('stat-total-vrajs').innerText = Math.floor(totalVrajs).toLocaleString();
            document.getElementById('stat-manual-clicks').innerText = totalClicks.toLocaleString();
            document.getElementById('stat-upgrades-bought').innerText = totalUpgrades.toLocaleString();
            document.getElementById('stat-golden-caught').innerText = goldenVrajsCaught.toLocaleString();
            document.getElementById('stat-fatflaps').innerText = fatflaps.toLocaleString();
            document.getElementById('stat-prestige-count').innerText = prestigeCount.toLocaleString();
        }

        function renderAchievements() {
            const list = document.getElementById('ach-list');
            const completed = achievements.filter(a => a.unlocked).length;
            const total = achievements.length;
            document.getElementById('ach-count').innerText = completed;
            document.getElementById('ach-total').innerText = total;
            document.getElementById('ach-progress-bar').style.width = `${(completed/total)*100}%`;
            list.innerHTML = achievements.map(ach => `
                <div class="ach-card glass p-3 flex items-center justify-between ${ach.unlocked ? 'unlocked' : 'locked'}">
                    <div><p class="text-xs font-bold text-white">${ach.title}</p><p class="text-[9px] text-gray-400">${ach.desc}</p></div>
                    ${ach.unlocked ? '<span class="text-emerald-400">‚úÖ</span>' : '<span class="text-gray-600">üîí</span>'}
                </div>`).join('');
        }

        function spawnGoldenVraj() {
            if (document.querySelector('.golden-vraj')) return;
            const golden = document.createElement('img'); golden.src = 'image_0.png'; golden.className = 'golden-vraj';
            golden.onclick = (e) => { e.stopPropagation(); goldenVrajsCaught++; activateMultiplier(); golden.remove(); };
            document.body.appendChild(golden);
            setTimeout(() => { if(golden) golden.remove(); }, 10000);
        }

        function activateMultiplier() { multiplier = 2; multTimeRemaining = 180; document.getElementById('multiplier-display').classList.remove('hidden'); }

        setInterval(() => {
            timePlayed++;
            if (multTimeRemaining > 0) {
                multTimeRemaining--;
                const mins = Math.floor(multTimeRemaining / 60); const secs = multTimeRemaining % 60;
                document.getElementById('mult-timer').innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
                if (multTimeRemaining === 0) { multiplier = 1; document.getElementById('multiplier-display').classList.add('hidden'); }
            }
            if (Math.random() < (ownedPrestigeUpgrades.includes("p2") ? 0.01 : 0.005)) spawnGoldenVraj();
            const currentLevelCost = 10000 * Math.pow(1.5, prestigeCount);
            const progress = Math.min(100, (score / currentLevelCost) * 100);
            document.getElementById('prestige-bar').style.width = progress + '%';
            document.getElementById('prestige-percent').innerText = Math.floor(progress) + '%';
            const gain = calculatePrestigeGain();
            document.getElementById('prestige-gain-display').innerText = `(+${gain} Fatflaps)`;
            document.getElementById('prestige-btn').disabled = gain === 0;
            document.getElementById('next-prestige-cost').innerText = currentLevelCost.toLocaleString();
        }, 1000);

        function updateUI() {
            const pb = (1 + (0.5 * fatflaps));
            document.getElementById('score').innerText = Math.floor(score).toLocaleString();
            document.getElementById('vps-display').innerText = (vps * multiplier * pb).toLocaleString(undefined, {minimumFractionDigits: 1}) + " VPS";
            const p1B = ownedPrestigeUpgrades.includes("p1") ? 2 : 1;
            document.getElementById('ppc-display').innerText = (ppc * multiplier * pb * p1B).toLocaleString() + " Points Per Click";
            if (fatflaps > 0 || prestigeCount > 0) {
                document.getElementById('fatflap-display').classList.remove('hidden');
                document.getElementById('fatflap-count').innerText = fatflaps.toLocaleString();
            }
            upgrades.forEach(u => {
                const el = document.getElementById(`upg-${u.id}`);
                const bCost = getBulkCost(u.cost, bulkAmount);
                if (el) { el.classList.toggle('disabled', score < bCost); document.getElementById(`cost-${u.id}`).innerText = bCost.toLocaleString(); document.getElementById(`owned-${u.id}`).innerText = u.owned.toLocaleString(); }
            });
        }

        const shop = document.getElementById('shop-list');
        upgrades.forEach(u => {
            shop.innerHTML += `<div id="upg-${u.id}" onclick="buyUpgrade(${u.id})" class="upgrade-card glass p-4 flex justify-between items-center disabled"><div class="flex items-center gap-3"><span class="text-2xl">${u.emoji}</span><div><p class="font-bold text-sm text-white">${u.name}</p><p class="text-[10px] text-emerald-400">+${u.basePower.toLocaleString()} ${u.isClickUpgrade?'PPC':'VPS'}</p></div></div><div class="text-right"><p class="text-xs font-bold text-blue-300" id="cost-${u.id}">${u.cost.toLocaleString()}</p><p class="text-[9px] text-gray-400">Owned: <span id="owned-${u.id}">0</span></p></div></div>`;
        });

        setInterval(() => { if (vps > 0) { const pb = (1 + (0.5 * fatflaps)); score += (vps * multiplier * pb) / 10; updateUI(); } }, 100);

        window.switchTab = (t) => {
            document.getElementById('login-form').classList.toggle('hidden', t !== 'login');
            document.getElementById('signup-form').classList.toggle('hidden', t !== 'signup');
            document.getElementById('tab-login').classList.toggle('bg-blue-600', t === 'login');
            document.getElementById('tab-signup').classList.toggle('bg-blue-600', t === 'signup');
        };

        window.handleSignup = async () => {
            const u = document.getElementById('su-username').value, e = document.getElementById('su-email').value, p = document.getElementById('su-password').value;
            try { const c = await createUserWithEmailAndPassword(auth, e, p); await setDoc(doc(db, "users", c.user.uid), { username: u }); await sendEmailVerification(c.user); window.showAlert("Success", "Check email for verification."); } catch (err) { window.showAlert("Error", err.message); }
        };
        window.handleLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('li-email').value, document.getElementById('li-password').value); } catch (err) { window.showAlert("Error", err.message); } };
        window.handleGuest = () => signInAnonymously(auth);
        window.logoutAction = () => window.showAlert("Logout", "Are you sure you want to sign out?", () => signOut(auth), true);

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                if (!user.isAnonymous && !user.emailVerified) { document.getElementById('verify-notice').classList.remove('hidden'); document.getElementById('login-form').classList.add('hidden'); document.getElementById('auth-tabs').classList.add('hidden'); } 
                else {
                    document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('game-screen').classList.remove('hidden');
                    if(user.isAnonymous) { currentUsername = "Guest_" + user.uid.substring(0,4); } 
                    else {
                        const snap = await getDoc(doc(db, "users", user.uid)); currentUsername = snap.exists() ? snap.data().username : "Vraj";
                        const save = await getDoc(doc(db, "leaderboard", user.uid)); 
                        if(save.exists()){ 
                            const d = save.data(); score = d.score || 0; vps = d.vps || 0; ppc = d.ppc || 1; totalVrajs = d.totalVrajs || 0; totalClicks = d.totalClicks || 0; totalUpgrades = d.totalUpgrades || 0; goldenVrajsCaught = d.goldenVrajsCaught || 0; chatsSent = d.chatsSent || 0; timePlayed = d.timePlayed || 0; prestigeCount = d.prestigeCount || 0; fatflaps = d.fatflaps || 0; ownedPrestigeUpgrades = d.ownedPrestigeUpgrades || [];
                            if(d.upgStates) d.upgStates.forEach((s, i) => { if(upgrades[i]) { upgrades[i].owned = s.owned; upgrades[i].cost = s.cost; } });
                            if(d.achStates) achievements.forEach((a, i) => { if(d.achStates[i]) a.unlocked = d.achStates[i]; });
                        }
                    }
                    document.getElementById('user-display').innerText = currentUsername; renderAchievements(); renderPrestigeShop(); updateUI();
                    setInterval(() => { if(currentUser && !currentUser.isAnonymous) {
                        setDoc(doc(db, "leaderboard", currentUser.uid), { score, vps, ppc, totalVrajs, totalClicks, totalUpgrades, goldenVrajsCaught, chatsSent, timePlayed, username: currentUsername, upgStates: upgrades.map(u => ({ owned: u.owned, cost: u.cost })), achStates: achievements.map(a => a.unlocked), prestigeCount, fatflaps, ownedPrestigeUpgrades }, { merge: true }); 
                    }}, 10000);
                    onSnapshot(query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(10)), (s) => {
                        document.getElementById('leaderboard-list').innerHTML = s.docs.map((d, i) => {
                            const dData = d.data(); const rankClass = (i === 0) ? 'rank-1' : (i === 1) ? 'rank-2' : (i === 2) ? 'rank-3' : ''; const medal = (i === 0) ? 'ü•á' : (i === 1) ? 'ü•à' : (i === 2) ? 'ü•â' : '';
                            return `<div class="lb-card p-3 rounded-xl flex items-center justify-between border border-white/5 bg-white/5 mb-2 ${rankClass}"><div class="flex items-center gap-3"><span class="text-xs font-black rank-text">#${i+1} ${medal}</span><div><p class="text-xs font-bold text-white">${dData.username}</p><p class="text-[9px] text-purple-400 font-bold">${(dData.prestigeCount || 0)} Ascensions</p></div></div><div class="text-right"><p class="text-xs font-black text-blue-400">${Math.floor(dData.score).toLocaleString()}</p></div></div>`;
                        }).join('');
                    });
                    onSnapshot(query(collection(db, "globalChat"), orderBy("timestamp", "desc"), limit(20)), (s) => {
                        document.getElementById('chat-box').innerHTML = s.docs.map(d => `<div class="mb-1"><span class="text-emerald-400 font-bold">${d.data().username}:</span> ${d.data().text}</div>`).join('');
                    });
                }
            } else { document.getElementById('auth-screen').classList.remove('hidden'); document.getElementById('game-screen').classList.add('hidden'); }
        });

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault(); const input = document.getElementById('chat-input'); if(!input.value.trim()) return;
            await addDoc(collection(db, "globalChat"), { text: input.value, username: currentUsername, timestamp: serverTimestamp() }); 
            chatsSent++; input.value = "";
        };
    </script>
</body>
</html>
